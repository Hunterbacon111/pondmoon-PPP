<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Greenwood at Katy - Property Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.8.0/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
<script>if(typeof pdfjsLib!=='undefined')pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.worker.min.js';</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAynge_ihipaRhyKRBJUVhBUY9lHeree0I"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

:root {
  --navy: #0a1628;
  --navy-light: #1a2a4a;
  --navy-mid: #132038;
  --gold: #c8a55a;
  --gold-light: #dcc07a;
  --gold-dark: #a88a3e;
  --bg: #f0f1f5;
  --card: #ffffff;
  --green: #2d9f6f;
  --green-bg: #e8f5ee;
  --red: #d94452;
  --red-bg: #fce8ea;
  --orange: #d4872a;
  --blue: #3574b8;
  --blue-light: #e8f0fa;
  --purple: #7c5cbf;
  --teal: #2a9d8f;
  --gray: #6b7a8d;
  --gray-light: #9ba8b6;
  --text: #1a2332;
  --text-light: #4a5668;
  --border: #dfe3ea;
  --shadow: 0 2px 12px rgba(10,22,40,0.06);
  --shadow-lg: 0 8px 30px rgba(10,22,40,0.10);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }

/* ===== COVER PAGE ===== */
.cover {
  min-height: 100vh; background: var(--navy); color: white; position: relative; overflow: hidden;
}
.cover-hero {
  width: 100%; height: 55vh; object-fit: cover; display: block;
  filter: brightness(0.85);
}
.cover-overlay {
  position: absolute; top: 0; left: 0; right: 0; height: 55vh;
  background: linear-gradient(180deg, rgba(10,22,40,0.3) 0%, rgba(10,22,40,0.7) 100%);
  display: flex; align-items: flex-end; padding: 48px 60px;
}
.cover-title-block h1 {
  font-family: 'Playfair Display', serif; font-size: 52px; font-weight: 700;
  letter-spacing: -0.5px; line-height: 1.1;
}
.cover-title-block .gold-line {
  width: 80px; height: 3px; background: var(--gold); margin: 16px 0;
}
.cover-title-block .tagline {
  font-size: 16px; font-weight: 300; letter-spacing: 2px; text-transform: uppercase;
  color: rgba(255,255,255,0.8);
}
.cover-body {
  padding: 48px 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 48px;
}
.cover-info h2 {
  font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 600;
  color: var(--gold); margin-bottom: 24px; letter-spacing: 0.5px;
}
.cover-info-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 16px 32px;
}
.cover-info-item .label {
  font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--gray-light); margin-bottom: 4px;
}
.cover-info-item .value {
  font-size: 17px; font-weight: 600; color: white;
}
.cover-photos {
  display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
}
.cover-photos img {
  width: 100%; height: 160px; object-fit: cover; border-radius: 8px;
  border: 1px solid rgba(200,165,90,0.2);
}
.cover-map {
  padding: 0 60px 32px; display: flex; flex-direction: column; gap: 16px;
}
.cover-map-label {
  display: flex; align-items: center; gap: 14px;
}
.map-pin {
  width: 36px; height: 36px; background: var(--gold); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: var(--navy); font-size: 14px; font-weight: 700; flex-shrink: 0;
}
.map-title {
  font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 600;
  color: var(--gold); letter-spacing: 0.3px;
}
.map-address {
  font-size: 13px; color: var(--gray-light); margin-top: 2px;
}
.cover-map-frame {
  width: 100%; height: 280px; border-radius: 8px; overflow: hidden;
  border: 1px solid rgba(200,165,90,0.2);
}
.cover-footer {
  padding: 32px 60px; border-top: 1px solid rgba(255,255,255,0.08);
  display: flex; justify-content: space-between; align-items: center;
  font-size: 12px; color: var(--gray-light);
}
.cover-footer .pondmoon {
  font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 600;
  color: var(--gold);
}
.cover-enter {
  display: inline-block; padding: 12px 36px; background: var(--gold);
  color: var(--navy); font-weight: 600; font-size: 13px; letter-spacing: 1px;
  text-transform: uppercase; border: none; cursor: pointer; border-radius: 4px;
  transition: all 0.3s;
}
.cover-enter:hover { background: var(--gold-light); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(200,165,90,0.3); }

/* ===== DASHBOARD SHELL ===== */
.dashboard { display: none; }
.dashboard.visible { display: block; }

/* Top bar */
.topbar {
  background: var(--navy); color: white; padding: 16px 40px;
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; z-index: 200;
  box-shadow: 0 2px 20px rgba(10,22,40,0.2);
}
.topbar-left { display: flex; align-items: center; gap: 16px; }
.topbar-logo {
  font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; color: var(--gold);
}
.topbar-divider { width: 1px; height: 24px; background: rgba(255,255,255,0.15); }
.topbar-address { font-size: 13px; color: var(--gray-light); font-weight: 400; }
.topbar-right { font-size: 12px; color: var(--gray-light); display: flex; align-items: center; gap: 16px; }
.topbar-back {
  padding: 6px 16px; border-radius: 4px; font-size: 11px; font-weight: 600;
  letter-spacing: 0.5px; text-transform: uppercase; cursor: pointer;
  background: transparent; border: 1px solid rgba(200,165,90,0.4);
  color: var(--gold); transition: all 0.2s;
}
.topbar-back:hover { background: var(--gold); color: var(--navy); }

/* Navigation */
.nav {
  background: white; border-bottom: 1px solid var(--border);
  display: flex; padding: 0 40px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.nav-tab {
  padding: 16px 28px; font-size: 13px; font-weight: 600; cursor: pointer;
  border-bottom: 2px solid transparent; color: var(--gray); transition: all 0.2s;
  letter-spacing: 0.3px;
}
.nav-tab:hover { color: var(--navy); }
.nav-tab.active { color: var(--navy); border-bottom-color: var(--gold); }

/* Main content */
.main { max-width: 1440px; margin: 0 auto; padding: 28px 40px 60px; }
.section { display: none; }
.section.active { display: block; }
.section-title {
  font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600;
  color: var(--navy); margin-bottom: 6px;
}
.section-subtitle { font-size: 13px; color: var(--gray); margin-bottom: 24px; }

/* KPI Cards */
.kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 16px; margin-bottom: 28px; }
.kpi-card {
  background: var(--card); border-radius: 10px; padding: 22px 24px;
  box-shadow: var(--shadow); border: 1px solid var(--border);
  position: relative; overflow: hidden;
}
.kpi-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: var(--navy);
}
.kpi-card .label { font-size: 11px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
.kpi-card .value { font-size: 28px; font-weight: 700; margin-top: 6px; color: var(--navy); }
.kpi-card .sub { font-size: 12px; color: var(--gray); margin-top: 6px; line-height: 1.4; }
.kpi-card .trend-up { color: var(--navy); }
.kpi-card .trend-down { color: var(--navy); }
.kpi-card.gold::before { background: var(--gold); }

/* Chart containers */
.chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
.chart-row.full { grid-template-columns: 1fr; }
.chart-card {
  background: var(--card); border-radius: 10px; padding: 24px;
  box-shadow: var(--shadow); border: 1px solid var(--border);
}
.chart-card h3 {
  font-size: 14px; font-weight: 600; margin-bottom: 18px; color: var(--navy);
  letter-spacing: 0.2px;
}

/* Detail cards */
.detail-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px; }
.detail-card {
  background: var(--card); border-radius: 10px; padding: 22px;
  box-shadow: var(--shadow); border: 1px solid var(--border);
}
.detail-card h4 {
  font-size: 11px; font-weight: 700; color: var(--navy); margin-bottom: 14px;
  text-transform: uppercase; letter-spacing: 1px;
  padding-bottom: 10px; border-bottom: 2px solid var(--gold);
}
.detail-card ul { list-style: none; }
.detail-card li {
  font-size: 13px; color: var(--text-light); padding: 7px 0;
  border-bottom: 1px solid var(--border);
}
.detail-card li:last-child { border-bottom: none; }

/* Budget table */
.budget-table-wrap { overflow-x: auto; }
.budget-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.budget-table th, .budget-table td { padding: 10px 14px; text-align: right; border-bottom: 1px solid var(--border); }
.budget-table th {
  background: var(--navy); color: white; font-weight: 600; font-size: 11px;
  letter-spacing: 0.5px; text-transform: uppercase; position: sticky; top: 0;
}
.budget-table td:first-child, .budget-table th:first-child { text-align: left; }
.budget-table tr.section-header td {
  font-weight: 700; background: var(--blue-light); color: var(--navy);
  font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase;
}
.budget-table tr.total-row td { font-weight: 700; border-top: 2px solid var(--navy); background: #f8f9fb; }
.budget-table .negative { color: var(--red); }
.budget-table tbody tr:hover { background: #f8f9fc; }

/* Table card header with export button */
.table-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
.table-card-header h3 { font-size: 14px; font-weight: 600; color: var(--navy); letter-spacing: 0.2px; margin: 0; }
.export-pdf-btn {
  display: inline-flex; align-items: center; padding: 7px 16px; border-radius: 6px;
  font-size: 12px; font-weight: 600; border: 1px solid var(--border); background: var(--card);
  cursor: pointer; color: var(--navy); transition: all 0.2s; letter-spacing: 0.3px; font-family: 'Inter', sans-serif;
}
.export-pdf-btn:hover { background: var(--navy); color: white; border-color: var(--navy); }
.export-pdf-btn:active { transform: scale(0.97); }

/* Print-only header (hidden on screen) */
.print-report-header { display: none; }

/* ===== CELL COMMENTS ===== */
.budget-table td[data-row] { position: relative; cursor: pointer; }
.budget-table td[data-row]:hover { background: rgba(200,165,90,0.06); }
.budget-table td.has-comment::after {
  content: ''; position: absolute; top: 0; right: 0;
  width: 0; height: 0; border-style: solid;
  border-width: 0 8px 8px 0;
  border-color: transparent var(--gold) transparent transparent;
  pointer-events: none;
}
.cell-comment-tooltip {
  position: fixed; z-index: 1000; max-width: 280px;
  padding: 8px 12px; background: var(--navy); color: white;
  font-size: 12px; line-height: 1.5; border-radius: 6px;
  box-shadow: var(--shadow-lg); pointer-events: none;
  opacity: 0; transition: opacity 0.15s ease; word-wrap: break-word;
}
.cell-comment-tooltip.visible { opacity: 1; }
.cell-comment-tooltip::after {
  content: ''; position: absolute; bottom: -6px; left: 20px;
  width: 0; height: 0; border-style: solid;
  border-width: 6px 5px 0 5px;
  border-color: var(--navy) transparent transparent transparent;
}
.cell-comment-popup {
  position: fixed; z-index: 1001; width: 300px;
  background: var(--card); border: 1px solid var(--border);
  border-radius: 8px; box-shadow: var(--shadow-lg);
  display: none; font-family: 'Inter', -apple-system, sans-serif;
}
.cell-comment-popup.active { display: block; }
.cell-comment-popup-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 14px; background: var(--navy); color: white;
  border-radius: 8px 8px 0 0; font-size: 11px;
  font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;
}
.cell-comment-popup-close {
  background: none; border: none; color: rgba(255,255,255,0.6);
  cursor: pointer; font-size: 16px; padding: 0 2px; line-height: 1;
  transition: color 0.2s;
}
.cell-comment-popup-close:hover { color: white; }
.cell-comment-popup-body { padding: 12px 14px; }
.cell-comment-popup-body .cell-label {
  font-size: 11px; color: var(--gray); margin-bottom: 6px;
  font-weight: 500;
}
.cell-comment-popup textarea {
  width: 100%; min-height: 60px; max-height: 120px;
  padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px;
  font-family: 'Inter', -apple-system, sans-serif; font-size: 12px;
  color: var(--text); resize: vertical; outline: none;
  transition: border-color 0.2s; box-sizing: border-box;
}
.cell-comment-popup textarea:focus { border-color: var(--gold); }
.cell-comment-popup-actions {
  display: flex; justify-content: space-between; align-items: center;
  padding: 0 14px 12px;
}
.cell-comment-popup-actions button {
  padding: 6px 16px; border-radius: 4px; font-size: 12px;
  font-weight: 600; cursor: pointer; border: none; transition: all 0.2s;
}
.cell-comment-save { background: var(--navy); color: white; }
.cell-comment-save:hover { background: var(--navy-light); }
.cell-comment-delete {
  background: none; border: 1px solid var(--border) !important;
  color: var(--red); font-size: 11px;
}
.cell-comment-delete:hover { background: var(--red-bg); }

/* ===== AI CHAT WIDGET ===== */
.ai-chat-card { position: relative; }
.ai-chat-header {
  display: flex; justify-content: space-between; align-items: flex-start;
  margin-bottom: 16px;
}
.ai-chat-header-left { display: flex; align-items: center; gap: 12px; }
.ai-chat-icon {
  width: 36px; height: 36px; border-radius: 8px;
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
  color: var(--gold); display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; letter-spacing: 0.5px; flex-shrink: 0;
}
.ai-chat-header h3 { margin: 0 0 2px; }
.ai-chat-subtitle { font-size: 12px; color: var(--gray); font-weight: 400; }
.ai-key-btn {
  background: none; border: 1px solid var(--border); border-radius: 6px;
  padding: 6px 10px; cursor: pointer; font-size: 14px; color: var(--gray);
  transition: all 0.2s;
}
.ai-key-btn:hover { border-color: var(--gold); color: var(--gold); }
.ai-key-panel {
  padding: 12px 16px; margin-bottom: 12px;
  background: var(--blue-light); border-radius: 8px;
  border: 1px solid var(--border);
}
.ai-key-panel label {
  font-size: 11px; font-weight: 600; color: var(--navy);
  text-transform: uppercase; letter-spacing: 0.5px;
  display: block; margin-bottom: 6px;
}
.ai-key-row { display: flex; gap: 8px; }
.ai-key-row input {
  flex: 1; padding: 8px 12px; border: 1px solid var(--border);
  border-radius: 4px; font-family: 'Inter', sans-serif; font-size: 12px;
  outline: none; transition: border-color 0.2s;
}
.ai-key-row input:focus { border-color: var(--gold); }
.ai-key-row button {
  padding: 8px 16px; background: var(--navy); color: white;
  border: none; border-radius: 4px; font-size: 12px; font-weight: 600;
  cursor: pointer; transition: background 0.2s;
}
.ai-key-row button:hover { background: var(--navy-light); }
.ai-key-status { font-size: 11px; margin-top: 6px; color: var(--green); }
.ai-suggestions { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.ai-suggest-btn {
  padding: 6px 14px; background: rgba(200,165,90,0.08);
  border: 1px solid rgba(200,165,90,0.25); border-radius: 16px;
  font-size: 12px; color: var(--navy); cursor: pointer;
  font-family: 'Inter', sans-serif; transition: all 0.2s;
}
.ai-suggest-btn:hover { background: rgba(200,165,90,0.18); border-color: var(--gold); }
.ai-chat-messages {
  max-height: 400px; overflow-y: auto; margin-bottom: 12px;
  padding: 4px 0; min-height: 40px;
}
.ai-msg { margin-bottom: 12px; display: flex; gap: 10px; animation: aiMsgIn 0.25s ease; }
@keyframes aiMsgIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
.ai-msg-user { justify-content: flex-end; }
.ai-msg-avatar {
  width: 28px; height: 28px; border-radius: 6px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 10px; font-weight: 700; letter-spacing: 0.3px;
}
.ai-msg-user .ai-msg-avatar { background: var(--gold); color: var(--navy); order: 2; }
.ai-msg-assistant .ai-msg-avatar { background: var(--navy); color: var(--gold); }
.ai-msg-bubble {
  max-width: 80%; padding: 10px 14px; border-radius: 10px;
  font-size: 13px; line-height: 1.6; word-wrap: break-word;
}
.ai-msg-user .ai-msg-bubble { background: var(--navy); color: white; border-bottom-right-radius: 2px; }
.ai-msg-assistant .ai-msg-bubble { background: #f4f5f8; color: var(--text); border-bottom-left-radius: 2px; }
.ai-msg-bubble strong { font-weight: 600; }
.ai-msg-loading .ai-msg-bubble { color: var(--gray); font-style: italic; }
.ai-typing-dots span {
  display: inline-block; width: 6px; height: 6px; margin: 0 2px;
  background: var(--gray-light); border-radius: 50%;
  animation: aiBounce 1.4s infinite ease-in-out;
}
.ai-typing-dots span:nth-child(1) { animation-delay: 0s; }
.ai-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.ai-typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes aiBounce {
  0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
  40% { transform: scale(1); opacity: 1; }
}
.ai-chat-input-row { display: flex; gap: 8px; align-items: flex-end; }
.ai-chat-input-row textarea {
  flex: 1; padding: 10px 14px; border: 1px solid var(--border);
  border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px;
  outline: none; transition: border-color 0.2s; resize: none;
  min-height: 42px; max-height: 120px; line-height: 1.5;
}
.ai-chat-input-row textarea:focus { border-color: var(--gold); }
.ai-send-btn {
  padding: 10px 24px; background: var(--gold); color: var(--navy);
  border: none; border-radius: 8px; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.2s; letter-spacing: 0.3px;
}
.ai-send-btn:hover { background: var(--gold-light); }
.ai-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.ai-error { color: var(--red); font-size: 12px; }

/* Loan headline banner */
.loan-headline {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
  border-radius: 12px; padding: 28px 32px; margin-bottom: 24px;
  display: flex; align-items: center; justify-content: space-between;
  box-shadow: var(--shadow-lg); position: relative; overflow: hidden;
}
.loan-headline::before {
  content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 4px;
  background: var(--gold);
}
.loan-headline-left { display: flex; align-items: center; gap: 20px; }
.loan-headline-icon {
  width: 52px; height: 52px; border-radius: 12px;
  background: rgba(200,165,90,0.12); display: flex;
  align-items: center; justify-content: center;
  font-size: 24px; flex-shrink: 0; color: var(--gold);
  font-weight: 700; font-family: 'Playfair Display', serif;
}
.loan-headline-text h3 {
  font-family: 'Playfair Display', serif; font-size: 22px;
  font-weight: 700; color: white; margin-bottom: 4px;
}
.loan-headline-text p {
  font-size: 13px; color: rgba(255,255,255,0.55); line-height: 1.5;
}
.loan-headline-text p strong { color: rgba(255,255,255,0.85); font-weight: 600; }
.loan-headline-right {
  display: flex; gap: 28px; text-align: center;
}
.loan-headline-stat .val {
  font-size: 24px; font-weight: 700; color: var(--gold);
  font-family: 'Inter', sans-serif;
}
.loan-headline-stat .lbl {
  font-size: 10px; color: rgba(255,255,255,0.45); text-transform: uppercase;
  letter-spacing: 1px; margin-top: 2px;
}

/* Loan features grid */
.loan-features {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 12px; margin-bottom: 24px;
}
.loan-feature-item {
  background: var(--card); border-radius: 8px; padding: 14px 18px;
  box-shadow: var(--shadow); border: 1px solid var(--border);
  border-left: 3px solid var(--navy);
}
.loan-feature-item .feat-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
  color: var(--gray); font-weight: 600; margin-bottom: 4px;
}
.loan-feature-item .feat-value {
  font-size: 13px; font-weight: 600; color: var(--navy); line-height: 1.4;
}
.loan-feature-item.feat-highlight { border-left-color: var(--gold); }

/* Loan amort table */
.loan-amort-table {
  width: 100%; border-collapse: collapse; font-size: 12px;
}
.loan-amort-table th {
  padding: 10px 14px; text-align: right; background: var(--navy); color: white;
  font-weight: 600; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase;
}
.loan-amort-table th:first-child { text-align: left; }
.loan-amort-table td {
  padding: 10px 14px; text-align: right; border-bottom: 1px solid var(--border);
}
.loan-amort-table td:first-child { text-align: left; font-weight: 600; color: var(--navy); }
.loan-amort-table tbody tr:hover { background: #f8f9fc; }
.loan-amort-table tr.current-year { background: rgba(200,165,90,0.12); border-left: 3px solid var(--gold); }
.loan-amort-table tr.current-year td { font-weight: 700; color: var(--navy); }
.loan-amort-table tr.current-year td:first-child { color: var(--gold-dark); }
.loan-amort-table tr.ref-year { background: rgba(10,22,40,0.03); }
.loan-amort-table tr.ref-year td { font-weight: 600; }

/* Top Goal banner */
.top-goal {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
  border-radius: 12px; padding: 24px 30px; margin-bottom: 24px;
  display: flex; align-items: center; gap: 20px;
  box-shadow: var(--shadow-lg); position: relative; overflow: hidden;
}
.top-goal::before {
  content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 4px;
  background: var(--gold);
}
.top-goal::after {
  content: ''; position: absolute; top: -30px; right: -30px;
  width: 120px; height: 120px; border-radius: 50%;
  background: rgba(200,165,90,0.06);
}
.top-goal-icon {
  width: 48px; height: 48px; border-radius: 12px;
  background: rgba(200,165,90,0.15); display: flex;
  align-items: center; justify-content: center;
  font-size: 22px; flex-shrink: 0;
}
.top-goal-content { flex: 1; }
.top-goal-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
  color: var(--gold); font-weight: 700; margin-bottom: 6px;
}
.top-goal-text {
  font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700;
  color: white; line-height: 1.3;
}
.top-goal-meta {
  display: flex; gap: 20px; margin-top: 8px;
}
.top-goal-meta-item {
  font-size: 11px; color: rgba(255,255,255,0.55); display: flex;
  align-items: center; gap: 6px;
}
.top-goal-meta-item strong {
  color: rgba(255,255,255,0.8); font-weight: 600;
}
.top-goal-progress {
  flex-shrink: 0; text-align: center; min-width: 80px;
}
.top-goal-pct {
  font-size: 28px; font-weight: 700; color: var(--gold);
  font-family: 'Inter', sans-serif;
}
.top-goal-pct-label {
  font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase;
  letter-spacing: 1px; margin-top: 2px;
}

/* Strategy summary cards */
.strategy-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px; margin-bottom: 28px;
}
.strategy-card {
  background: var(--card); border-radius: 10px; padding: 20px 22px;
  box-shadow: var(--shadow); border: 1px solid var(--border);
  position: relative; overflow: hidden; transition: all 0.3s ease;
  cursor: pointer; user-select: none;
}
.strategy-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
.strategy-card.strategy-active {
  box-shadow: var(--shadow-lg); transform: translateY(-2px);
  border-color: var(--navy); background: #f8f9fd;
}
.strategy-card.strategy-active::after {
  content: 'âœ• Click to clear'; position: absolute; top: 8px; right: 12px;
  font-size: 9px; color: var(--gray-light); font-weight: 600; letter-spacing: 0.3px;
}
.strategy-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
}
.strategy-card.cat-Concession::before { background: var(--gold); }
.strategy-card.cat-Marketing::before { background: var(--blue); }
.strategy-card.cat-Personnel::before { background: var(--teal); }
.strategy-card.cat-Renovation::before { background: var(--orange); }
.strategy-card.cat-Refinance::before { background: var(--purple); }
.strategy-card.cat-Sale::before { background: var(--red); }
.strategy-card-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
}
.strategy-icon {
  width: 34px; height: 34px; border-radius: 8px; display: flex;
  align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; color: white; flex-shrink: 0;
}
.cat-Concession .strategy-icon { background: var(--gold); color: var(--navy); }
.cat-Marketing .strategy-icon { background: var(--blue); }
.cat-Personnel .strategy-icon { background: var(--teal); }
.cat-Renovation .strategy-icon { background: var(--orange); }
.cat-Refinance .strategy-icon { background: var(--purple); }
.cat-Sale .strategy-icon { background: var(--red); }
.strategy-card-title {
  font-size: 13px; font-weight: 700; color: var(--navy);
  text-transform: uppercase; letter-spacing: 0.5px;
}
.strategy-card-count {
  font-size: 11px; color: var(--gray); margin-top: 1px;
}
.strategy-card-summary {
  font-size: 13px; color: var(--text-light); line-height: 1.6;
}
.strategy-card-empty {
  font-size: 12px; color: var(--gray-light); font-style: italic;
}

/* Actions table */
.actions-filters { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
.filter-btn {
  padding: 7px 18px; border-radius: 6px; font-size: 12px; font-weight: 600;
  border: 1px solid var(--border); background: var(--card); cursor: pointer;
  color: var(--gray); transition: all 0.2s;
}
.filter-btn:hover { border-color: var(--navy); color: var(--navy); }
.filter-btn.active { background: var(--navy); color: white; border-color: var(--navy); }
.actions-table {
  width: 100%; border-collapse: collapse; font-size: 13px;
  background: var(--card); border-radius: 10px; overflow: hidden;
  box-shadow: var(--shadow); border: 1px solid var(--border);
}
.actions-table th {
  padding: 14px 18px; text-align: left; background: var(--navy); color: white;
  font-weight: 600; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase;
}
.actions-table th.sortable { cursor: pointer; user-select: none; position: relative; transition: background 0.2s; }
.actions-table th.sortable:hover { background: #1a2942; }
.actions-table th.sortable .sort-arrow { display: inline-block; margin-left: 4px; opacity: 0.35; font-size: 10px; transition: opacity 0.2s; }
.actions-table th.sortable.sort-active .sort-arrow { opacity: 1; color: var(--gold); }
.actions-table td { padding: 14px 18px; border-bottom: 1px solid var(--border); line-height: 1.5; }
.actions-table tbody tr:hover { background: #f8f9fc; }
.status-badge {
  display: inline-block; padding: 3px 12px; border-radius: 4px; font-size: 11px; font-weight: 600;
  letter-spacing: 0.3px;
}
.cat-badge {
  display: inline-block; padding: 2px 10px; border-radius: 3px; font-size: 10px; font-weight: 700;
  letter-spacing: 0.5px; text-transform: uppercase; margin-right: 8px; vertical-align: middle;
}
.cat-badge-Concession { background: rgba(200,165,90,0.15); color: var(--gold-dark); }
.cat-badge-Marketing { background: rgba(53,116,184,0.12); color: var(--blue); }
.cat-badge-Personnel { background: rgba(42,157,143,0.12); color: var(--teal); }
.cat-badge-Renovation { background: rgba(212,135,42,0.12); color: var(--orange); }
.cat-badge-Refinance { background: rgba(124,92,191,0.12); color: var(--purple); }
.cat-badge-Sale { background: rgba(217,68,82,0.12); color: var(--red); }
.sentiment-badge {
  display: inline-block; padding: 1px 7px; border-radius: 3px; font-size: 9px; font-weight: 700;
  letter-spacing: 0.3px; text-transform: uppercase; margin-right: 6px; vertical-align: middle;
}
.sentiment-concern { background: #fee2e2; color: #b91c1c; }
.sentiment-positive { background: #dcfce7; color: #166534; }
.status-pending { background: #fef3c7; color: #92400e; }
.status-in_progress { background: #dbeafe; color: #1e40af; }
.status-recommended { background: #d1fae5; color: #065f46; }
.status-noted { background: #f1f5f9; color: #475569; }
.status-monitoring { background: #ffe4e6; color: #9f1239; }
.status-done { background: var(--navy); color: white; }

/* Action checkbox */
.action-check {
  width: 18px; height: 18px; cursor: pointer; accent-color: var(--navy);
  flex-shrink: 0;
}
.actions-table tr.row-done td { opacity: 0.45; }
.actions-table tr.row-done td:last-child { opacity: 1; }
.actions-table tr.row-done .action-text { text-decoration: line-through; }

/* Add action form */
.add-action-bar {
  display: flex; gap: 10px; margin-top: 20px; align-items: stretch;
}
.add-action-bar input, .add-action-bar select {
  padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 13px; font-family: 'Inter', sans-serif; background: var(--card);
  color: var(--text); outline: none; transition: border-color 0.2s;
}
.add-action-bar input:focus, .add-action-bar select:focus { border-color: var(--gold); }
.add-action-bar input.action-input { flex: 1; }
.add-action-bar input.responsible-input { width: 130px; }
.add-action-bar button {
  padding: 10px 22px; background: var(--navy); color: white; border: none;
  border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
  white-space: nowrap; transition: background 0.2s;
}
.add-action-bar button:hover { background: var(--navy-light); }
.status-communicated { background: #ede9fe; color: #5b21b6; }

/* ===== AI FILE UPLOAD ===== */
.file-upload-card { background: var(--card); border-radius: 10px; margin-top: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
.file-upload-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 24px; cursor: pointer; transition: background 0.2s; }
.file-upload-header:hover { background: #f8f9fc; }
.file-upload-header-left { display: flex; align-items: center; gap: 14px; }
.file-upload-icon { width: 36px; height: 36px; background: var(--navy); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 12px; font-weight: 700; flex-shrink: 0; }
.file-upload-header h3 { font-size: 14px; font-weight: 600; color: var(--navy); margin: 0; }
.file-upload-subtitle { font-size: 12px; color: var(--gray); margin-top: 2px; }
.file-upload-toggle { font-size: 12px; color: var(--gray); transition: transform 0.3s; }
.file-upload-toggle.open { transform: rotate(180deg); }
.file-upload-body { padding: 0 24px 24px; }
.file-drop-zone { border: 2px dashed var(--border); border-radius: 10px; padding: 36px; text-align: center; transition: all 0.3s; cursor: pointer; }
.file-drop-zone.drag-over { border-color: var(--gold); background: rgba(200,165,90,0.06); }
.file-drop-icon { font-size: 36px; margin-bottom: 10px; }
.file-drop-text { font-size: 14px; color: var(--text); font-weight: 500; }
.file-browse-link { color: var(--gold-dark); font-weight: 600; cursor: pointer; text-decoration: underline; text-underline-offset: 2px; }
.file-drop-hint { font-size: 11px; color: var(--gray-light); margin-top: 6px; }
.file-list { margin-top: 16px; }
.file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: #f8f9fc; border-radius: 6px; margin-bottom: 6px; font-size: 13px; }
.file-list-item .file-name { font-weight: 500; color: var(--navy); }
.file-list-item .file-size { font-size: 11px; color: var(--gray); margin-left: 8px; }
.file-list-item .file-remove { background: none; border: none; color: var(--gray-light); cursor: pointer; font-size: 14px; padding: 2px 6px; transition: color 0.2s; }
.file-list-item .file-remove:hover { color: var(--red); }
.file-actions { display: flex; gap: 10px; margin-top: 16px; }
.file-process-btn { padding: 10px 24px; background: var(--navy); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
.file-process-btn:hover { background: var(--navy-light); }
.file-process-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.file-process-icon { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; background: var(--gold); color: var(--navy); border-radius: 4px; font-size: 9px; font-weight: 800; }
.file-clear-btn { padding: 10px 18px; background: transparent; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; color: var(--gray); cursor: pointer; }
.file-clear-btn:hover { border-color: var(--gray); }
.file-status { display: flex; align-items: center; gap: 12px; margin-top: 16px; padding: 14px 18px; background: #f0f4ff; border-radius: 8px; }
.file-status-spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--navy); border-radius: 50%; animation: fileSpin 0.8s linear infinite; }
@keyframes fileSpin { to { transform: rotate(360deg); } }
.file-status-text { font-size: 13px; color: var(--navy); font-weight: 500; }
.file-preview { margin-top: 16px; }
.file-preview-title { font-size: 13px; font-weight: 700; color: var(--navy); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
.file-preview-list { max-height: 350px; overflow-y: auto; }
.file-preview-item { padding: 12px 16px; background: #f8faf8; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid var(--gold); font-size: 13px; line-height: 1.5; position: relative; }
.file-preview-item .preview-action { font-weight: 500; color: var(--text); padding-right: 28px; }
.file-preview-item .preview-meta { font-size: 11px; color: var(--gray); margin-top: 4px; display: flex; gap: 16px; flex-wrap: wrap; }
.file-preview-item .preview-remove { position: absolute; top: 8px; right: 10px; background: none; border: none; color: var(--gray-light); cursor: pointer; font-size: 15px; padding: 2px 6px; border-radius: 4px; transition: all 0.2s; line-height: 1; }
.file-preview-item .preview-remove:hover { color: #e74c3c; background: rgba(231,76,60,0.08); }
.file-preview-item.removed { opacity: 0.3; border-left-color: var(--gray-light); text-decoration: line-through; pointer-events: none; transition: all 0.3s; }
.file-preview-actions { display: flex; gap: 10px; margin-top: 14px; }
.file-confirm-btn { padding: 10px 24px; background: rgba(45,159,111,0.9); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
.file-confirm-btn:hover { background: rgba(37,138,93,1); }
.file-discard-btn { padding: 10px 18px; background: transparent; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; color: var(--gray); cursor: pointer; }

/* Strategy filter animation */
@keyframes slideIn {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes highlightPulse {
  0% { background: rgba(200,165,90,0.12); }
  50% { background: rgba(200,165,90,0.22); }
  100% { background: rgba(200,165,90,0.06); }
}
.actions-table tbody tr.row-animate {
  animation: slideIn 0.35s ease-out both;
}
.actions-table tbody tr.row-highlight-pulse {
  animation: slideIn 0.35s ease-out both, highlightPulse 0.8s ease-out 0.3s both;
}
.strategy-filter-label {
  display: inline-flex; align-items: center; gap: 8px; padding: 6px 16px;
  background: var(--navy); color: white; border-radius: 6px; font-size: 12px;
  font-weight: 600; letter-spacing: 0.3px; margin-bottom: 12px; cursor: pointer;
  transition: all 0.2s;
}
.strategy-filter-label:hover { background: var(--navy-light); }
.strategy-filter-label .clear-x { opacity: 0.6; font-size: 10px; margin-left: 4px; }
.strategy-filter-label:hover .clear-x { opacity: 1; }

/* Leasing weekly table */
.leasing-table-wrap { overflow-x: auto; margin-bottom: 24px; }
.leasing-table {
  width: 100%; border-collapse: collapse; font-size: 12px;
  background: var(--card); border-radius: 10px; overflow: hidden;
  box-shadow: var(--shadow); border: 1px solid var(--border);
}
.leasing-table th {
  padding: 10px 12px; text-align: right; background: var(--navy); color: white;
  font-weight: 600; font-size: 11px; letter-spacing: 0.5px; white-space: nowrap;
  position: sticky; top: 0;
}
.leasing-table th:first-child { text-align: left; min-width: 140px; }
.leasing-table td { padding: 9px 12px; text-align: right; border-bottom: 1px solid var(--border); white-space: nowrap; }
.leasing-table td:first-child { text-align: left; font-weight: 500; color: var(--navy); }
.leasing-table tbody tr:hover { background: #f8f9fc; }
.leasing-table tr.highlight-row { background: rgba(200,165,90,0.06); }
.leasing-table tr.highlight-row td { font-weight: 600; }
.leasing-table .pct-cell { font-weight: 600; }
.leasing-table .trend-up-cell { color: var(--green); }
.leasing-table .trend-down-cell { color: var(--red); }

/* Concession cards */
.concession-strip {
  display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;
}
.concession-item {
  background: linear-gradient(135deg, var(--navy), var(--navy-light));
  color: white; padding: 14px 20px; border-radius: 8px;
  font-size: 13px; line-height: 1.5; flex: 1; min-width: 250px;
  box-shadow: var(--shadow);
}
.concession-item .concession-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--gold); margin-bottom: 6px; font-weight: 600;
}

/* Expiration matrix table */
.exp-matrix-table {
  width: 100%; border-collapse: collapse; font-size: 12px;
  background: var(--card); border-radius: 10px; overflow: hidden;
  box-shadow: var(--shadow); border: 1px solid var(--border);
}
.exp-matrix-table th {
  padding: 10px 12px; text-align: right; background: var(--navy); color: white;
  font-weight: 600; font-size: 11px; letter-spacing: 0.3px;
}
.exp-matrix-table th:first-child { text-align: left; }
.exp-matrix-table th.month-group {
  text-align: center; border-left: 2px solid rgba(255,255,255,0.15);
}
.exp-matrix-table td {
  padding: 9px 12px; text-align: right; border-bottom: 1px solid var(--border);
}
.exp-matrix-table td:first-child { text-align: left; font-weight: 500; color: var(--navy); }
.exp-matrix-table td.month-first { border-left: 2px solid var(--border); }
.exp-matrix-table tbody tr:hover { background: #f8f9fc; }
.exp-matrix-table .retention-high { color: var(--green); font-weight: 600; }
.exp-matrix-table .retention-low { color: var(--red); font-weight: 600; }

/* Comps table */
.comps-table {
  width: 100%; border-collapse: collapse; font-size: 13px;
  background: var(--card); border-radius: 10px; overflow: hidden;
  box-shadow: var(--shadow); border: 1px solid var(--border);
}
.comps-table th {
  padding: 14px 16px; text-align: right; background: var(--navy); color: white;
  font-weight: 600; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase;
}
.comps-table th:first-child { text-align: left; }
.comps-table td { padding: 12px 16px; text-align: right; border-bottom: 1px solid var(--border); }
.comps-table td:first-child { text-align: left; font-weight: 500; }
.comps-table tr.subject { background: linear-gradient(90deg, rgba(200,165,90,0.08), rgba(200,165,90,0.03)); }
.comps-table tr.subject td { font-weight: 700; color: var(--navy); }
.comps-table tr.avg-row { background: var(--navy); color: white; font-weight: 700; }
.comps-table tr.avg-row td { color: white; border-bottom: none; }
.comps-table tbody tr:hover:not(.avg-row) { background: #f8f9fc; }

/* Comps Google Map */
#comps-map { height: 460px; border-radius: 8px; }
.gmap-label {
  background: var(--navy); color: white; font-family: 'Inter', sans-serif;
  font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 6px;
  white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.25);
  position: relative;
}
.gmap-label::after {
  content: ''; position: absolute; left: 50%; bottom: -7px;
  transform: translateX(-50%); border-left: 7px solid transparent;
  border-right: 7px solid transparent; border-top: 7px solid var(--navy);
}
.gmap-label-gwk {
  background: var(--gold); color: var(--navy); font-size: 12px; font-weight: 700;
  padding: 5px 12px; border-radius: 8px; box-shadow: 0 3px 12px rgba(0,0,0,0.3);
}
.gmap-label-gwk::after {
  border-top-color: var(--gold);
}

/* ===== CONTACTS SECTION ===== */
.contacts-add-bar {
  display: flex; gap: 10px; margin-bottom: 28px; align-items: flex-start; flex-wrap: wrap;
}
.contacts-add-bar input {
  padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 13px; font-family: 'Inter', sans-serif; background: var(--card);
  color: var(--text); outline: none; transition: border-color 0.2s;
}
.contacts-add-bar input:focus { border-color: var(--gold); }
.contacts-add-bar .contact-name-input { flex: 1; min-width: 140px; }
.contacts-add-bar .contact-phone-input { width: 150px; }
.contacts-add-bar .contact-role-input { flex: 0.8; min-width: 140px; }
.contacts-add-bar button {
  padding: 10px 22px; background: var(--navy); color: white; border: none;
  border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
  white-space: nowrap; transition: background 0.2s;
}
.contacts-add-bar button:hover { background: var(--navy-light); }

.contact-email-wrapper { position: relative; flex: 1.5; min-width: 200px; }
.contact-email-wrapper input { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; font-family: 'Inter', sans-serif; background: var(--card); color: var(--text); outline: none; transition: border-color 0.2s; box-sizing: border-box; }
.contact-email-wrapper input:focus { border-color: var(--gold); }
.ai-role-hint {
  position: absolute; bottom: -20px; left: 0; font-size: 11px;
  color: var(--gold-dark); font-weight: 500; display: flex; align-items: center; gap: 4px;
  animation: hintFadeIn 0.3s ease;
}
.ai-role-hint .hint-icon {
  font-size: 9px; font-weight: 700; background: var(--gold);
  color: var(--navy); width: 16px; height: 16px; border-radius: 3px;
  display: inline-flex; align-items: center; justify-content: center;
}
@keyframes hintFadeIn {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}

.contacts-search-bar {
  display: flex; gap: 12px; margin-bottom: 20px; align-items: center;
}
.contacts-search-bar input {
  flex: 1; padding: 9px 14px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 13px; font-family: 'Inter', sans-serif; outline: none;
  transition: border-color 0.2s; background: var(--card);
}
.contacts-search-bar input:focus { border-color: var(--gold); }
.contacts-count-label {
  font-size: 12px; color: var(--gray); font-weight: 600; white-space: nowrap;
}

.contacts-group {
  background: var(--card); border-radius: 10px;
  box-shadow: var(--shadow); border: 1px solid var(--border);
  margin-bottom: 20px; overflow: hidden;
}
.contacts-group-header {
  display: flex; align-items: center; gap: 14px;
  padding: 16px 24px; background: var(--navy); color: white;
  border-bottom: 2px solid var(--gold);
}
.contacts-group-icon {
  width: 36px; height: 36px; border-radius: 8px;
  background: rgba(200,165,90,0.15); display: flex;
  align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; color: var(--gold);
  font-family: 'Playfair Display', serif; overflow: hidden; flex-shrink: 0;
}
.contacts-group-icon img {
  width: 24px; height: 24px; object-fit: contain;
}
.contacts-group-icon img.logo-failed { display: none; }
.contacts-group-name {
  font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 600;
  letter-spacing: 0.3px;
}
.contacts-group-count {
  margin-left: auto; font-size: 11px; color: var(--gray-light);
  font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;
}
.contacts-group-body { padding: 8px 16px; }

.contact-card {
  display: flex; align-items: center; gap: 16px;
  padding: 14px 8px; border-bottom: 1px solid var(--border);
  transition: background 0.15s;
}
.contact-card:last-child { border-bottom: none; }
.contact-card:hover { background: rgba(200,165,90,0.04); }

.contact-avatar {
  width: 42px; height: 42px; border-radius: 50%;
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
  color: var(--gold); display: flex; align-items: center; justify-content: center;
  font-size: 15px; font-weight: 700; letter-spacing: 0.5px; flex-shrink: 0;
}
.contact-info { flex: 1; min-width: 0; }
.contact-name { font-size: 14px; font-weight: 600; color: var(--navy); }
.contact-role-badge {
  display: inline-block; font-size: 10px; font-weight: 600;
  padding: 2px 8px; border-radius: 10px; margin-left: 8px;
  background: rgba(200,165,90,0.12); color: var(--gold-dark);
  letter-spacing: 0.3px; text-transform: uppercase; vertical-align: middle;
}
.contact-details { display: flex; gap: 20px; margin-top: 4px; }
.contact-details a {
  font-size: 12px; color: var(--gray); text-decoration: none;
  display: flex; align-items: center; gap: 5px; transition: color 0.2s;
}
.contact-details a:hover { color: var(--navy); }
.contact-details .detail-icon { font-size: 11px; opacity: 0.7; }

.contact-actions { display: flex; gap: 6px; flex-shrink: 0; }
.contact-actions button {
  background: none; border: 1px solid var(--border); border-radius: 4px;
  padding: 5px 10px; font-size: 11px; cursor: pointer; color: var(--gray);
  transition: all 0.2s; font-family: 'Inter', sans-serif;
}
.contact-actions button:hover { border-color: var(--navy); color: var(--navy); }
.contact-actions button.contact-delete:hover { border-color: var(--red); color: var(--red); }

@keyframes contactSlideIn {
  from { opacity: 0; transform: translateX(-20px) scale(0.97); }
  60% { opacity: 1; transform: translateX(4px) scale(1.01); }
  to { opacity: 1; transform: translateX(0) scale(1); }
}
.contact-card-new { animation: contactSlideIn 0.4s ease-out; }

@keyframes groupFadeIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
.contacts-group-new { animation: groupFadeIn 0.35s ease-out; }

.contact-edit-row {
  display: flex; gap: 8px; padding: 12px 8px; border-bottom: 1px solid var(--border);
  align-items: center; background: rgba(200,165,90,0.04);
}
.contact-edit-row input {
  padding: 7px 10px; border: 1px solid var(--border); border-radius: 4px;
  font-size: 12px; font-family: 'Inter', sans-serif; outline: none;
  transition: border-color 0.2s;
}
.contact-edit-row input:focus { border-color: var(--gold); }
.contact-edit-row button {
  padding: 7px 14px; border: none; border-radius: 4px; font-size: 12px;
  font-weight: 600; cursor: pointer; transition: background 0.2s;
}
.contact-edit-save { background: var(--navy); color: white; }
.contact-edit-save:hover { background: var(--navy-light); }
.contact-edit-cancel { background: transparent; border: 1px solid var(--border) !important; color: var(--gray); }

.contacts-empty { text-align: center; padding: 60px 20px; color: var(--gray); }
.contacts-empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.3; }
.contacts-empty-text { font-size: 14px; font-weight: 500; }
.contacts-empty-sub { font-size: 12px; color: var(--gray-light); margin-top: 6px; }

/* Batch import card */
.batch-import-card { background: var(--card); border-radius: 10px; margin-bottom: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
.batch-import-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; cursor: pointer; transition: background 0.2s; }
.batch-import-header:hover { background: #f8f9fc; }
.batch-import-header-left { display: flex; align-items: center; gap: 14px; }
.batch-import-icon { width: 36px; height: 36px; background: var(--navy); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 12px; font-weight: 700; flex-shrink: 0; }
.batch-import-header h3 { font-size: 14px; font-weight: 600; color: var(--navy); margin: 0; }
.batch-import-subtitle { font-size: 12px; color: var(--gray); margin-top: 2px; }
.batch-import-toggle { font-size: 12px; color: var(--gray); transition: transform 0.3s; }
.batch-import-toggle.open { transform: rotate(180deg); }
.batch-import-body { padding: 0 24px 24px; }
.batch-import-body textarea {
  width: 100%; min-height: 80px; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
  font-size: 12px; font-family: 'Inter', monospace; color: var(--text); background: #f8f9fc;
  outline: none; transition: border-color 0.2s; resize: vertical; box-sizing: border-box; line-height: 1.5;
}
.batch-import-body textarea:focus { border-color: var(--gold); }
.batch-import-body textarea::placeholder { color: var(--gray-light); }
.batch-import-actions { display: flex; gap: 10px; margin-top: 12px; align-items: center; }
.batch-parse-btn { padding: 9px 20px; background: var(--navy); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; }
.batch-parse-btn:hover { background: var(--navy-light); }
.batch-parse-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.batch-ai-btn { padding: 9px 20px; background: transparent; border: 1px solid var(--gold); color: var(--gold-dark); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
.batch-ai-btn:hover { background: rgba(200,165,90,0.08); }
.batch-ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.batch-status { font-size: 12px; color: var(--gray); margin-left: 8px; }

/* Batch preview list */
.batch-preview { margin-top: 16px; }
.batch-preview-title { font-size: 13px; font-weight: 600; color: var(--navy); margin-bottom: 10px; }
.batch-preview-item {
  display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: #f8faf8;
  border-radius: 6px; margin-bottom: 6px; border-left: 3px solid var(--gold); transition: all 0.2s;
}
.batch-preview-item.deselected { opacity: 0.35; border-left-color: var(--gray-light); }
.batch-preview-check { flex-shrink: 0; width: 18px; height: 18px; cursor: pointer; accent-color: var(--navy); }
.batch-preview-info { flex: 1; min-width: 0; }
.batch-preview-name { font-size: 13px; font-weight: 600; color: var(--navy); }
.batch-preview-email { font-size: 11px; color: var(--gray); }
.batch-preview-role { font-size: 11px; color: var(--gold-dark); font-weight: 500; margin-top: 2px; }
.batch-preview-role-edit { padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 11px; width: 200px; outline: none; font-family: 'Inter', sans-serif; }
.batch-preview-role-edit:focus { border-color: var(--gold); }
.batch-preview-ai-tag { font-size: 9px; font-weight: 700; background: var(--gold); color: var(--navy); padding: 1px 5px; border-radius: 3px; margin-left: 4px; vertical-align: middle; }
.batch-confirm-row { display: flex; gap: 10px; margin-top: 14px; }
.batch-confirm-btn { padding: 10px 24px; background: rgba(45,159,111,0.9); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
.batch-confirm-btn:hover { background: rgba(37,138,93,1); }
.batch-discard-btn { padding: 10px 18px; background: transparent; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; color: var(--gray); cursor: pointer; }

/* ===== LOGIN OVERLAY ===== */
.login-overlay {
  position: fixed; inset: 0; z-index: 99999;
  background: url("/* __LOGIN_BG__ */") center center / cover no-repeat;
  display: flex; align-items: center; justify-content: center;
  transition: opacity 0.5s, visibility 0.5s;
}
.login-overlay::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(ellipse at center, rgba(10,22,40,0.4) 0%, rgba(10,22,40,0.75) 100%);
}
.login-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
.login-card {
  position: relative; z-index: 1;
  background: rgba(255,255,255,0.95); backdrop-filter: blur(12px);
  border-radius: 16px; padding: 44px 40px 36px;
  width: 360px; max-width: 90vw; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  animation: loginFadeIn 0.6s ease;
}
@keyframes loginFadeIn {
  from { opacity: 0; transform: translateY(24px) scale(0.96); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.login-logo-wrap {
  text-align: center; margin-bottom: 20px;
}
.login-logo-wrap img {
  height: 50px; width: auto;
}
.login-title {
  text-align: center; font-size: 20px; font-weight: 700; color: var(--navy);
  margin-bottom: 4px;
}
.login-subtitle {
  text-align: center; font-size: 12px; color: var(--gray); margin-bottom: 28px;
}
.login-field { margin-bottom: 16px; }
.login-field label {
  display: block; font-size: 11px; font-weight: 600; color: var(--gray);
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
}
.login-input {
  width: 100%; padding: 12px 14px; border: 1px solid var(--border);
  border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;
  color: var(--text); outline: none; transition: border-color 0.2s;
  box-sizing: border-box; background: #f8f9fc;
}
.login-input:focus { border-color: var(--gold); background: white; }
.login-btn {
  width: 100%; padding: 13px; margin-top: 8px; border: none; border-radius: 8px;
  background: var(--navy); color: white; font-size: 14px; font-weight: 600;
  font-family: 'Inter', sans-serif; cursor: pointer;
  transition: background 0.2s, transform 0.1s;
}
.login-btn:hover { background: var(--navy-light); }
.login-btn:active { transform: scale(0.98); }
.login-error {
  text-align: center; font-size: 12px; color: #d93025; margin-top: 14px;
  min-height: 18px; transition: opacity 0.3s;
}
.login-footer {
  text-align: center; font-size: 10px; color: var(--gray-light); margin-top: 24px;
  line-height: 1.5;
}

/* Responsive */
@media (max-width: 1000px) {
  .cover-body { grid-template-columns: 1fr; }
  .chart-row, .detail-row { grid-template-columns: 1fr; }
  .kpi-row { grid-template-columns: repeat(2, 1fr); }
  .cover-overlay { padding: 32px; }
  .cover-body { padding: 32px; }
  .cover-title-block h1 { font-size: 36px; }
}
@media (max-width: 600px) {
  .kpi-row { grid-template-columns: 1fr; }
  .main { padding: 20px; }
  .topbar { padding: 12px 20px; }
  .nav { padding: 0 20px; }
  .cover-title-block h1 { font-size: 28px; }
}

/* ===== PRINT STYLES FOR PDF EXPORT ===== */
@media print {
  @page { size: landscape; margin: 0.5in 0.4in 0.6in 0.4in; }

  /* Use flexbox on body to reorder print header before dashboard */
  body {
    display: flex !important; flex-direction: column !important;
  }
  body > * { display: none !important; }

  /* Show the print header â€” order -1 forces it to top */
  #print-report-header {
    display: block !important; position: relative; background: white; padding: 0 0 10px 0;
    order: -1 !important;
  }

  /* Show the dashboard chain: body > .dashboard > .main > #financial */
  #dashboard {
    display: block !important; padding: 0 !important; margin: 0 !important; background: white !important;
    order: 0 !important;
  }
  #dashboard > .topbar,
  #dashboard > .nav { display: none !important; }
  #dashboard > .main {
    display: block !important; padding: 0 !important; margin: 0 !important; background: white !important;
    max-width: none !important;
  }

  /* Hide all sections except financial */
  .main > .section { display: none !important; }
  #financial { display: block !important; padding: 0 !important; margin: 0 !important; }

  /* Inside financial: hide everything except the last chart-card (the table) */
  #financial > .section-title,
  #financial > .section-subtitle,
  #financial > .kpi-row,
  #financial > .chart-row,
  .table-card-header,
  .export-pdf-btn,
  .cell-comment-popup,
  .cell-comment-tooltip,
  .login-overlay { display: none !important; }

  /* Hide chart cards but show the table card */
  #financial > .chart-card { display: none !important; }
  #financial > .chart-card:last-of-type {
    display: block !important;
    box-shadow: none !important; border: none !important;
    padding: 0 !important; margin: 0 !important; background: white !important;
  }

  /* Also hide the ai-chat-card specifically */
  #financial > .ai-chat-card { display: none !important; }

  /* Print header styling */
  .print-header-top {
    display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 8px;
  }
  .print-property-name {
    font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; color: #0a1628;
  }
  .print-property-address { font-size: 11px; color: #6b7a8d; margin-top: 2px; }
  .print-header-meta { text-align: right; }
  .print-header-label {
    font-size: 13px; font-weight: 700; color: #0a1628; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .print-header-period { font-size: 11px; color: #6b7a8d; margin-top: 2px; }
  .print-header-date { font-size: 10px; color: #9ba8b6; margin-top: 1px; }
  .print-header-bar {
    height: 2px; background: linear-gradient(90deg, #0a1628 0%, #c8a55a 100%); margin: 6px 0;
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }
  .print-header-details {
    display: flex; justify-content: space-between;
    font-size: 10px; color: #6b7a8d; padding-bottom: 10px;
    border-bottom: 1px solid #dfe3ea; margin-bottom: 10px;
  }

  /* Table print styles */
  .budget-table-wrap { overflow: visible !important; }
  .budget-table { font-size: 9px !important; width: 100% !important; border-collapse: collapse !important; }
  .budget-table th, .budget-table td {
    padding: 5px 6px !important; border: 0.5px solid #ccc !important;
  }
  .budget-table th {
    background: #0a1628 !important; color: white !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
    font-size: 8px !important;
  }
  .budget-table tr.section-header td {
    background: #e8f0fa !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
    font-weight: 700 !important; font-size: 8px !important;
  }
  .budget-table tr.total-row td {
    background: #f8f9fb !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
    font-weight: 700 !important; border-top: 1.5px solid #0a1628 !important;
  }
  .budget-table .negative {
    color: #d94452 !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
  }
  .budget-table tbody tr:hover { background: transparent !important; }
  .budget-table td.has-comment::after { display: none !important; }

  /* Table pagination */
  .budget-table tr { page-break-inside: avoid; }
  .budget-table thead { display: table-header-group; }
  .budget-table tr.section-header { page-break-after: avoid; }
}

/* ===== UPLOAD PANEL ===== */
.section-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
.upload-btn {
  background: var(--navy); color: white; border: none; padding: 8px 16px;
  border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
  transition: background 0.2s; white-space: nowrap; margin-top: 2px;
}
.upload-btn:hover { background: #1a2340; }
.undo-btn {
  background: transparent; color: var(--navy); border: 1.5px solid var(--navy); padding: 7px 14px;
  border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
  transition: all 0.2s; white-space: nowrap; margin-top: 2px; margin-left: 6px;
}
.undo-btn:hover { background: var(--navy); color: white; }
.upload-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 10000;
  display: flex; align-items: center; justify-content: center;
}
.upload-panel {
  background: white; border-radius: 12px; padding: 24px;
  width: 520px; max-width: 90vw; max-height: 80vh;
  overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.upload-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.upload-header h3 { margin: 0; color: var(--navy); font-size: 18px; }
.upload-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; line-height: 1; }
.upload-close:hover { color: #333; }
.upload-tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 2px solid var(--border); }
.upload-tab {
  padding: 8px 16px; cursor: pointer; font-weight: 500;
  border-bottom: 2px solid transparent; margin-bottom: -2px; color: #999; font-size: 14px;
}
.upload-tab:hover { color: #666; }
.upload-tab.active { color: var(--navy); border-bottom-color: var(--gold); }
.upload-dropzone {
  border: 2px dashed var(--border); border-radius: 8px;
  padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s;
}
.upload-dropzone:hover, .upload-dropzone.dragover { border-color: var(--gold); background: rgba(200,165,90,0.05); }
.dropzone-icon { font-size: 36px; color: var(--gold); margin-bottom: 8px; }
.dropzone-hint { color: #999; font-size: 12px; margin-top: 8px; }
.upload-submit {
  width: 100%; padding: 12px; margin-top: 12px;
  background: var(--navy); color: white; border: none;
  border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;
}
.upload-submit:disabled { opacity: 0.5; cursor: not-allowed; }
.upload-submit:not(:disabled):hover { background: #1a2340; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 12px 0; }
.form-row label { display: block; font-size: 12px; color: #666; margin-bottom: 2px; }
.form-row input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; box-sizing: border-box; }
.form-row input:focus { outline: none; border-color: var(--gold); }
.upload-status { margin-top: 12px; padding: 12px; border-radius: 6px; text-align: center; font-size: 13px; }
.upload-status.error { background: #ffeae8; color: #c62828; }
.upload-status.success { background: #e8f5e9; color: #2e7d32; }
/* ===== OCR SCREENSHOT ===== */
.ocr-section { margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
.ocr-dropzone {
  border: 2px dashed var(--border); border-radius: 8px;
  padding: 24px 16px; text-align: center; cursor: pointer; transition: all 0.2s;
  background: #fafafa;
}
.ocr-dropzone:hover, .ocr-dropzone.dragover { border-color: var(--gold); background: rgba(200,165,90,0.08); }
.ocr-dropzone .dropzone-icon { font-size: 28px; margin-bottom: 4px; }
.ocr-dropzone div:nth-child(2) { font-size: 13px; color: #555; font-weight: 500; }
.ocr-preview { margin-top: 10px; text-align: center; }
.ocr-preview img { max-height: 180px; max-width: 100%; border-radius: 6px; border: 1px solid var(--border); }
.ocr-preview-actions { margin-top: 8px; display: flex; gap: 8px; justify-content: center; }
.ocr-analyze-btn {
  background: var(--gold); color: white; border: none; padding: 10px 24px;
  border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s;
}
.ocr-analyze-btn:hover { background: #b8942e; }
.ocr-analyze-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.ocr-clear-btn {
  background: none; border: 1px solid var(--border); padding: 10px 16px;
  border-radius: 6px; font-size: 13px; cursor: pointer; color: #666;
}
.ocr-clear-btn:hover { background: #f5f5f5; }
.ocr-status { margin-top: 8px; font-size: 12px; text-align: center; color: #666; }
.ocr-status.analyzing { color: var(--gold); font-weight: 500; }
.ocr-status.error { color: #c62828; }
.ocr-status.success { color: #2e7d32; }
.form-row input.ai-filled { border-color: var(--gold); background: #fffde7; }
.upload-status.info { background: #e3f2fd; color: #1565c0; }
@media print { .upload-btn { display: none; } }
</style>
</head>
<body>

<!-- ===== LOGIN OVERLAY ===== -->
<div class="login-overlay" id="login-overlay">
  <div class="login-card">
    <div class="login-title">Pondmoon PPP</div>
    <div class="login-subtitle">Property Planning Panel</div>
    <div class="login-field">
      <label>Username</label>
      <input class="login-input" id="login-user" type="text" placeholder="Enter username" autocomplete="username" autofocus>
    </div>
    <div class="login-field">
      <label>Password</label>
      <input class="login-input" id="login-pass" type="password" placeholder="Enter password" autocomplete="current-password">
    </div>
    <button class="login-btn" onclick="handleLogin()">Sign In</button>
    <div class="login-error" id="login-error"></div>
    <div class="login-footer">Client-side protected &bull; Pondmoon Real Estate Partners</div>
  </div>
</div>

<!-- ===== COVER PAGE ===== -->
<div class="cover" id="cover-page" style="display:none">
  <img class="cover-hero" src="/* __IMG_1__ */" alt="Greenwood at Katy">
  <div class="cover-overlay">
    <div class="cover-title-block">
      <div class="tagline">Pondmoon Real Estate Partners - Property Planning Panel (PPP)</div>
      <div class="gold-line"></div>
      <h1>Greenwood at Katy</h1>
    </div>
  </div>
  <div class="cover-body">
    <div class="cover-info">
      <h2>Investment Overview</h2>
      <div class="cover-info-grid">
        <div class="cover-info-item">
          <div class="label">Location</div>
          <div class="value">Katy, Texas</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Acquisition Date</div>
          <div class="value">November 2025</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Total Units</div>
          <div class="value">324</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Year Built</div>
          <div class="value">2022</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Total SF</div>
          <div class="value">310,836</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Avg Unit Size</div>
          <div class="value">959 SF</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Loan</div>
          <div class="value">HUD $49.3M @ 3.18%</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Tax Status</div>
          <div class="value">100% Exempt (HCHA)</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Property Manager</div>
          <div class="value">Greystar</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Co-Investor</div>
          <div class="value">Allen Harrison Co.</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Construction</div>
          <div class="value">Garden-Style, 3-Story</div>
        </div>
        <div class="cover-info-item">
          <div class="label">Unit Mix</div>
          <div class="value" style="font-size:14px; line-height:1.4">1BR / 2BR / 3BR<br><span style="font-size:12px; font-weight:400; color:var(--gray-light)">50% allocated to 80% AMI. Existing tenant qualify up to 140% AMI.</span></div>
        </div>
      </div>
    </div>
    <div class="cover-photos">
      <img src="/* __IMG_2__ */" alt="Pool & Amenities">
      <img src="/* __IMG_3__ */" alt="Aerial View">
      <img src="/* __IMG_4__ */" alt="Lake & Fountain">
      <img src="/* __IMG_1__ */" alt="Community Overview">
    </div>
  </div>
  <div class="cover-map">
    <div class="cover-map-label">
      <div class="map-pin">&#9679;</div>
      <div>
        <div class="map-title">Greenwood at Katy</div>
        <div class="map-address">1700 Katy Fort Bend Rd, Katy, TX 77493</div>
      </div>
    </div>
    <div class="cover-map-frame">
      <iframe
        src="https://maps.google.com/maps?q=Greenwood+at+Katy,+1700+Katy+Fort+Bend+Rd,+Katy,+TX+77493&t=&z=15&ie=UTF8&iwloc=&output=embed"
        width="100%" height="100%" style="border:0; border-radius: 8px;" allowfullscreen="" loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
  </div>
  <div class="cover-footer">
    <div class="pondmoon">Pondmoon</div>
    <div>
      <span style="margin-right: 24px">1700 Katy Fort Bend Rd, Katy, TX 77493</span>
      <button class="cover-enter" onclick="enterDashboard()">View Dashboard</button>
    </div>
  </div>
</div>

<!-- ===== DASHBOARD ===== -->
<div class="dashboard" id="dashboard">

<div class="topbar">
  <div class="topbar-left">
    <div style="display:flex;align-items:center;gap:12px;"><a href="../../index.html" style="color:var(--gold);font-size:11px;text-decoration:none;opacity:0.8;letter-spacing:1px;" title="Back to Portal">&larr; PORTAL</a><div class="topbar-logo" onclick="returnToCover()" style="cursor:pointer" title="Back to Cover">Greenwood at Katy</div></div>
    <div class="topbar-divider"></div>
    <div class="topbar-address">1700 Katy Fort Bend Rd, Katy, TX 77493 &middot; 324 Units &middot; Built 2022</div>
  </div>
  <div class="topbar-right">
    <span>Updated: /* __BUILD_DATE__ */</span>
    <button class="topbar-back" onclick="returnToCover()">&larr; Cover</button>
  </div>
</div>

<div class="nav">
  <div class="nav-tab active" onclick="switchTab('leasing')">Leasing Performance</div>
  <div class="nav-tab" onclick="switchTab('financial')">T-12 Financials</div>
  <div class="nav-tab" onclick="switchTab('budget')">2026 Budget</div>
  <div class="nav-tab" onclick="switchTab('loan')">HUD Loan</div>
  <div class="nav-tab" onclick="switchTab('comps')">Market Comps</div>
  <div class="nav-tab" onclick="switchTab('actions')">Management Actions</div>
  <div class="nav-tab" onclick="switchTab('contacts')">Contacts</div>
</div>

<div class="main">

<!-- ===== LEASING SECTION ===== -->
<div id="leasing" class="section active">
  <div class="section-header-row">
    <div>
      <div class="section-title">Leasing Performance</div>
      <div class="section-subtitle">Weekly occupancy, concessions, renewals, and delinquency tracking</div>
    </div>
    <button class="upload-btn" onclick="openUploadPanel('leasing')">Upload / Update Data</button>
    <button class="undo-btn" onclick="undoLeasing()" title="Restore previous leasing data">&#8630; Undo</button>
  </div>
  <div class="kpi-row" id="leasing-kpis"></div>

  <div class="chart-row">
    <div class="chart-card">
      <h3>Occupancy &amp; Leased % Trend</h3>
      <canvas id="occupancy-chart" height="120"></canvas>
    </div>
    <div class="chart-card">
      <h3>Leasing Activity</h3>
      <canvas id="leasing-activity-chart" height="120"></canvas>
    </div>
  </div>

  <div id="concession-container"></div>

  <div class="chart-card" style="margin-bottom:24px">
    <h3>Weekly Leasing Metrics</h3>
    <div class="leasing-table-wrap" id="weekly-table-container"></div>
  </div>

  <div class="chart-card" style="margin-bottom:24px">
    <h3>Expiration Matrix (Latest Snapshot: <span id="exp-matrix-date"></span>)</h3>
    <div class="leasing-table-wrap" id="exp-matrix-container"></div>
  </div>

  <div id="delinquency-notes-container"></div>

  <div class="detail-row" id="leasing-details"></div>
</div>

<!-- ===== FINANCIAL SECTION ===== -->
<div id="financial" class="section">
  <div class="section-header-row">
    <div>
      <div class="section-title">T-12 Financials</div>
      <div class="section-subtitle" id="financial-subtitle">Prior T-12 Actuals (Oct 2024 &ndash; Sep 2025)</div>
    </div>
    <button class="upload-btn" onclick="openUploadPanel('financials')">Upload / Update Data</button>
  </div>
  <div class="kpi-row" id="financial-kpis"></div>
  <div class="chart-row">
    <div class="chart-card">
      <h3>Monthly Revenue (T-12 Actuals)</h3>
      <canvas id="revenue-chart" height="120"></canvas>
    </div>
    <div class="chart-card">
      <h3>Operating Expense Breakdown (T-12 Actuals)</h3>
      <canvas id="opex-chart" height="120"></canvas>
    </div>
  </div>
  <div class="chart-row">
    <div class="chart-card">
      <h3>Monthly NOI Trend (T-12 Actuals)</h3>
      <canvas id="noi-chart" height="120"></canvas>
    </div>
    <div class="chart-card">
      <h3>Vacancy &amp; Concession Loss (T-12 Actuals)</h3>
      <canvas id="vacancy-chart" height="120"></canvas>
    </div>
  </div>

  <!-- AI Q&A Widget -->
  <div class="chart-card ai-chat-card" style="margin-bottom:24px">
    <div class="ai-chat-header">
      <div class="ai-chat-header-left">
        <div class="ai-chat-icon">AI</div>
        <div>
          <h3>Financial Q&amp;A Assistant</h3>
          <div class="ai-chat-subtitle">Ask questions about T-12 financials, YoY comparisons, and trends &middot; Powered by Claude</div>
        </div>
      </div>
      <div>
        <button class="ai-key-btn" onclick="toggleApiKeyInput()" title="API Key Settings">&#9881;</button>
      </div>
    </div>
    <div class="ai-key-panel" id="ai-key-panel" style="display:none">
      <label>Anthropic API Key</label>
      <div class="ai-key-row">
        <input type="password" id="ai-api-key" placeholder="sk-ant-..." autocomplete="off">
        <button onclick="saveApiKey()">Save</button>
      </div>
      <div class="ai-key-status" id="ai-key-status"></div>
    </div>
    <div class="ai-suggestions" id="ai-suggestions">
      <button class="ai-suggest-btn" onclick="askSuggested(this)">ä»Šå¹´T-12 Revenueæ¯”åŽ»å¹´å¢žåŠ å¤šå°‘ï¼Ÿ</button>
      <button class="ai-suggest-btn" onclick="askSuggested(this)">Which month had the highest NOI?</button>
      <button class="ai-suggest-btn" onclick="askSuggested(this)">Operating expenseså“ªä¸ªç±»åˆ«å¢žé•¿æœ€å¿«ï¼Ÿ</button>
      <button class="ai-suggest-btn" onclick="askSuggested(this)">Bad debtåŒæ¯”å˜åŒ–ï¼Ÿ</button>
      <button class="ai-suggest-btn" onclick="askSuggested(this)">Greenwoodå’ŒTrailsçš„ä¿é™©è´¹per unitå¯¹æ¯”ï¼Ÿ</button>
      <button class="ai-suggest-btn" onclick="askSuggested(this)">Compare NOI/unit: Greenwood vs Trails</button>
    </div>
    <div class="ai-chat-messages" id="ai-chat-messages"></div>
    <div class="ai-chat-input-row">
      <textarea id="ai-chat-input" rows="1" placeholder="Ask about financials... (supports English &amp; ä¸­æ–‡)"
                oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
      <button class="ai-send-btn" onclick="sendChatMessage()" id="ai-send-btn">Send</button>
    </div>
  </div>

  <div class="chart-card" style="margin-bottom:24px">
    <div class="table-card-header">
      <h3>T-12 Income &amp; Expense Detail</h3>
      <button class="export-pdf-btn" onclick="exportFinancialPDF()" title="Export as PDF">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:5px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
        Export PDF
      </button>
    </div>
    <div class="budget-table-wrap" id="budget-table-container"></div>
  </div>
</div>

<!-- ===== HUD LOAN SECTION ===== -->
<div id="loan" class="section">
  <div class="section-header-row">
    <div>
      <div class="section-title">HUD Loan Profile</div>
      <div class="section-subtitle">FHA Section 221(d)(4) â€” Fixed rate, fully amortizing, non-recourse</div>
    </div>
    <button class="upload-btn" onclick="openUploadPanel('loan')">Upload / Update Data</button>
  </div>

  <!-- Loan headline banner -->
  <div id="loan-headline"></div>

  <!-- KPI cards -->
  <div class="kpi-row" id="loan-kpis"></div>

  <!-- Charts -->
  <div class="chart-row">
    <div class="chart-card">
      <h3>Loan Balance Over Time</h3>
      <canvas id="loan-balance-chart" height="140"></canvas>
    </div>
    <div class="chart-card">
      <h3>Annual Interest vs Principal</h3>
      <canvas id="loan-split-chart" height="140"></canvas>
    </div>
  </div>

  <!-- 2026 Debt Service Breakdown -->
  <div class="chart-row">
    <div class="chart-card">
      <h3>2026 Debt Service Breakdown (Annual)</h3>
      <canvas id="loan-ds-donut" height="160"></canvas>
    </div>
    <div class="chart-card">
      <h3>2026 Monthly Debt Service by Component</h3>
      <canvas id="loan-ds-monthly-chart" height="160"></canvas>
    </div>
  </div>

  <!-- HUD Loan Features grid -->
  <div id="loan-features-container"></div>

  <!-- Amortization Schedule Table -->
  <div class="chart-card" style="margin-bottom:24px">
    <h3>Amortization Schedule (Selected Years)</h3>
    <div class="leasing-table-wrap" id="loan-amort-container"></div>
  </div>
</div>

<!-- ===== COMPS SECTION ===== -->
<div id="comps" class="section">
  <div class="section-header-row">
    <div>
      <div class="section-title">Market Comparables</div>
      <div class="section-subtitle">Greenwood at Katy vs peer properties in Katy / West Houston &mdash; Source: Marketing Presentation (Feb 2026)</div>
    </div>
    <button class="upload-btn" onclick="openUploadPanel('comps')">Upload / Update Data</button>
  </div>
  <div class="kpi-row" id="comps-kpis"></div>

  <!-- GWK Concession Banner -->
  <div id="comps-gwk-concession"></div>

  <!-- Charts -->
  <div class="chart-row">
    <div class="chart-card">
      <h3>Rent/SF by Unit Type &mdash; GWK vs Comp Avg</h3>
      <canvas id="comps-psf-compare-chart" height="140"></canvas>
    </div>
    <div class="chart-card">
      <h3>Competitor Exposure Rate</h3>
      <canvas id="comps-exposure-chart" height="140"></canvas>
    </div>
  </div>

  <!-- GWK Floor Plan Pricing Table -->
  <div class="chart-card" style="margin-bottom:24px">
    <h3>Greenwood at Katy &mdash; Floor Plan Pricing</h3>
    <div class="leasing-table-wrap" id="comps-gwk-table"></div>
  </div>

  <!-- Competitor Comps Table -->
  <div class="chart-card" style="margin-bottom:24px">
    <h3>Competitor Rent/SF &amp; Concessions</h3>
    <div class="leasing-table-wrap" id="comps-competitor-table"></div>
  </div>

  <!-- Property Locations Map -->
  <div class="chart-card" style="margin-bottom:24px">
    <h3>Property Locations</h3>
    <div id="comps-map"></div>
  </div>
</div>

<!-- ===== 2026 BUDGET SECTION ===== -->
<div id="budget" class="section">
  <div class="section-header-row">
    <div>
      <div class="section-title">2026 Budget</div>
      <div class="section-subtitle" id="budget-subtitle">Annual Operating Budget &mdash; Greenwood at Katy</div>
    </div>
    <button class="upload-btn" onclick="openUploadPanel('budget')">Upload / Update Data</button>
  </div>
  <div class="kpi-row" id="budget-kpis"></div>

  <div class="chart-row">
    <div class="chart-card">
      <h3>Budgeted Monthly Income</h3>
      <canvas id="budget-income-chart" height="120"></canvas>
    </div>
    <div class="chart-card">
      <h3>Budgeted OpEx Breakdown</h3>
      <canvas id="budget-opex-chart" height="120"></canvas>
    </div>
  </div>

  <div class="chart-row">
    <div class="chart-card">
      <h3>Budgeted NOI vs Debt Service</h3>
      <canvas id="budget-noi-chart" height="120"></canvas>
    </div>
    <div class="chart-card">
      <h3>Budgeted Occupancy Targets</h3>
      <canvas id="budget-occ-chart" height="120"></canvas>
    </div>
  </div>

  <div class="chart-card" style="margin-bottom:24px">
    <h3>2026 Budget Detail</h3>
    <div class="budget-table-wrap" id="budget-detail-container"></div>
  </div>
</div>

<!-- ===== ACTIONS SECTION ===== -->
<div id="actions" class="section">
  <div class="section-header-row">
    <div>
      <div class="section-title">Management Actions</div>
      <div class="section-subtitle">Decisions and action items from weekly calls, emails, and strategic plans</div>
    </div>
    <button class="upload-btn" onclick="openUploadPanel('minutes')">Upload Meeting Minutes</button>
  </div>
  <div id="top-goal-container"></div>
  <div id="strategy-summary-container"></div>
  <div class="actions-filters" id="actions-filters"></div>
  <div id="actions-table-container"></div>
  <div class="add-action-bar">
    <input type="text" class="action-input" id="new-action-text" placeholder="Add new action item...">
    <input type="text" class="responsible-input" id="new-action-resp" placeholder="Responsible">
    <button onclick="addAction()">+ Add</button>
  </div>

  <!-- AI Document Parser -->
  <div class="file-upload-card" id="file-upload-card">
    <div class="file-upload-header" onclick="toggleUploadPanel()">
      <div class="file-upload-header-left">
        <div class="file-upload-icon">AI</div>
        <div>
          <h3>AI Document Parser</h3>
          <div class="file-upload-subtitle">Upload meeting minutes, emails, or action plans &mdash; AI extracts action items automatically</div>
        </div>
      </div>
      <div class="file-upload-toggle" id="file-upload-toggle">&#9660;</div>
    </div>
    <div class="file-upload-body" id="file-upload-body" style="display:none">
      <div class="file-drop-zone" id="file-drop-zone">
        <div class="file-drop-icon">&#128196;</div>
        <div class="file-drop-text">Drag &amp; drop files here, or <label for="file-input-picker" class="file-browse-link">browse</label></div>
        <div class="file-drop-hint">Accepts .docx, .pdf, .txt, .eml</div>
        <input type="file" id="file-input-picker" accept=".docx,.pdf,.txt,.eml" multiple style="display:none" onchange="handleFileSelect(event)">
      </div>
      <div class="file-list" id="file-list" style="display:none"></div>
      <div class="file-actions" id="file-actions" style="display:none">
        <button class="file-process-btn" id="file-process-btn" onclick="processUploadedFiles()">
          <span class="file-process-icon">AI</span> Extract Action Items
        </button>
        <button class="file-clear-btn" onclick="clearUploadedFiles()">Clear</button>
      </div>
      <div class="file-status" id="file-status" style="display:none">
        <div class="file-status-spinner"></div>
        <div class="file-status-text" id="file-status-text">Reading document...</div>
      </div>
      <div class="file-preview" id="file-preview" style="display:none">
        <h4 class="file-preview-title">Extracted Action Items</h4>
        <div class="file-preview-list" id="file-preview-list"></div>
        <div class="file-preview-actions">
          <button class="file-confirm-btn" onclick="confirmExtractedActions()">Add All to Actions Table</button>
          <button class="file-discard-btn" onclick="discardExtractedActions()">Discard</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== CONTACTS SECTION ===== -->
<div id="contacts" class="section">
  <div class="section-title">Contacts</div>
  <div class="section-subtitle">Key contacts grouped by company &mdash; property management, investors, and service providers</div>

  <div class="contacts-add-bar">
    <input type="text" class="contact-name-input" id="contact-name" placeholder="Name">
    <div class="contact-email-wrapper">
      <input type="email" id="contact-email" placeholder="Email" oninput="detectContactRole()">
      <div class="ai-role-hint" id="ai-role-hint" style="display:none">
        <span class="hint-icon">AI</span>
        <span id="ai-role-hint-text"></span>
      </div>
    </div>
    <input type="tel" class="contact-phone-input" id="contact-phone" placeholder="Phone">
    <input type="text" class="contact-role-input" id="contact-role" placeholder="Role">
    <button onclick="addContact()">+ Add Contact</button>
  </div>

  <!-- Batch Import Card -->
  <div class="batch-import-card">
    <div class="batch-import-header" onclick="toggleBatchImport()">
      <div class="batch-import-header-left">
        <div class="batch-import-icon">AI</div>
        <div>
          <h3>Batch Import from Email</h3>
          <div class="batch-import-subtitle">Paste To/Cc lines from emails &mdash; AI parses contacts and searches job titles</div>
        </div>
      </div>
      <div class="batch-import-toggle" id="batch-import-toggle">&#9660;</div>
    </div>
    <div class="batch-import-body" id="batch-import-body" style="display:none">
      <textarea id="batch-import-text" placeholder="Paste email To/Cc lines here, e.g.:&#10;To: Meredith Monroe <mmonroe@allenharrisonco.com>; Nicole Zhong <nzhong@pondmoonusa.com>&#10;Cc: Ashley Johnson <ashley.johnson@greystar.com>"></textarea>
      <div class="batch-import-actions">
        <button class="batch-parse-btn" onclick="parseBatchContacts()">Parse Contacts</button>
        <button class="batch-ai-btn" id="batch-ai-btn" onclick="aiSearchBatchRoles()" style="display:none" disabled>
          <span style="font-size:10px;font-weight:700;background:var(--gold);color:var(--navy);padding:1px 5px;border-radius:3px">AI</span>
          Search Job Titles
        </button>
        <span class="batch-status" id="batch-status"></span>
      </div>
      <div class="batch-preview" id="batch-preview" style="display:none">
        <div class="batch-preview-title" id="batch-preview-title">Parsed Contacts</div>
        <div id="batch-preview-list"></div>
        <div class="batch-confirm-row">
          <button class="batch-confirm-btn" onclick="confirmBatchContacts()">Add Selected Contacts</button>
          <button class="batch-discard-btn" onclick="discardBatchContacts()">Discard</button>
        </div>
      </div>
    </div>
  </div>

  <div class="contacts-search-bar">
    <input type="text" id="contacts-search" placeholder="Search contacts..." oninput="renderContacts()">
    <div class="contacts-count-label" id="contacts-count-label"></div>
  </div>

  <div id="contacts-list-container"></div>
</div>

</div><!-- end main -->
</div><!-- end dashboard -->

<!-- Cell comment tooltip (hover preview) -->
<div class="cell-comment-tooltip" id="cell-comment-tooltip"></div>

<!-- Cell comment edit popup -->
<div class="cell-comment-popup" id="cell-comment-popup">
  <div class="cell-comment-popup-header">
    <span id="cell-comment-popup-title">Add Comment</span>
    <button class="cell-comment-popup-close" onclick="closeCellCommentPopup()">&times;</button>
  </div>
  <div class="cell-comment-popup-body">
    <div class="cell-label" id="cell-comment-label"></div>
    <textarea id="cell-comment-textarea" placeholder="Add a note about this value..."></textarea>
  </div>
  <div class="cell-comment-popup-actions">
    <button class="cell-comment-delete" id="cell-comment-delete-btn" onclick="deleteCellComment()" style="display:none">Delete</button>
    <div style="flex:1"></div>
    <button class="cell-comment-save" onclick="saveCellComment()">Save</button>
  </div>
</div>

<script>
// ===== DATA INJECTION =====
const PROPERTY_INFO = /* __PROPERTY_JSON__ */;
let LEASING_DATA = /* __LEASING_JSON__ */;
const BUDGET_DATA = /* __BUDGET_JSON__ */;
let FINANCIAL_DATA = /* __FINANCIAL_JSON__ */;
const ACTIONS_DATA = /* __ACTIONS_JSON__ */;
const COMPS_DATA = /* __COMPS_JSON__ */;
const LOAN_DATA = /* __LOAN_JSON__ */;
const COMPANION_DATA = /* __COMPANION_JSON__ */;

// ===== SERVER PERSISTENCE =====
const API_BASE = '/api/v1';
const PROPERTY_ID = 'gwk';
let _contactsCache = null;
let _cellCommentsCache = null;
let _actionsStateCache = null;
let _apiKeyCache = null;
let _kimiKeyCache = null;  // kept for backwards compat
const KIMI_KEY_STORAGE = 'ppp_kimi_key';  // kept for backwards compat

async function serverLoad(dataType) {
  try {
    const resp = await fetch(`${API_BASE}/${PROPERTY_ID}/${dataType}`);
    if (resp.ok) { const r = await resp.json(); return r.data; }
  } catch (e) { console.warn('API load failed:', e); }
  return null;
}
async function serverSave(dataType, data) {
  try {
    await fetch(`${API_BASE}/${PROPERTY_ID}/${dataType}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data })
    });
  } catch (e) { console.warn('API save failed:', e); }
}

async function initServerData() {
  const [contacts, comments, actions, apiKey, kimiKey] = await Promise.all([
    serverLoad('contacts'), serverLoad('cell_comments'),
    serverLoad('actions_state'), serverLoad('api_key'), serverLoad('kimi_key')
  ]);
  if (contacts !== null && contacts.length > 0) {
    _contactsCache = contacts;
    localStorage.setItem(CONTACTS_STORAGE_KEY || 'gwk_contacts', JSON.stringify(contacts));
  }
  if (comments !== null && Object.keys(comments).length > 0) {
    _cellCommentsCache = comments;
    localStorage.setItem(CELL_COMMENTS_KEY || 'gwk_cell_comments', JSON.stringify(comments));
  }
  if (actions !== null && Object.keys(actions).length > 0) {
    _actionsStateCache = actions;
    localStorage.setItem(ACTIONS_STORAGE_KEY || 'gwk_actions_state', JSON.stringify(actions));
  }
  if (apiKey !== null && apiKey !== '') {
    _apiKeyCache = apiKey;
    localStorage.setItem(AI_KEY_STORAGE || 'gwk_anthropic_key', apiKey);
  }
  if (kimiKey !== null && kimiKey !== '') {
    _kimiKeyCache = kimiKey;
    localStorage.setItem(KIMI_KEY_STORAGE || 'ppp_kimi_key', kimiKey);
  }
  if (typeof renderContacts === 'function') try { renderContacts(); } catch(e) {}
}

// ===== LOGIN =====
const LOGIN_HASH = '07aa1f9f4a0f3ce27e42aca996038e72516b199f8bad26f99cf3001ea9d0120f';
const LOGIN_USER = 'pondmoon';

function sha256(str) {
  // Pure JS SHA-256 (works on HTTP, no crypto.subtle needed)
  function rr(n,x){return(x>>>n)|(x<<(32-n));}
  const K=[0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,
    0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,
    0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,
    0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967,
    0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,
    0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,
    0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,
    0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2];
  let H=[0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19];
  const bytes=new TextEncoder().encode(str);
  const bits=bytes.length*8;
  const padded=new Uint8Array(Math.ceil((bytes.length+9)/64)*64);
  padded.set(bytes);padded[bytes.length]=0x80;
  const dv=new DataView(padded.buffer);
  dv.setUint32(padded.length-4,bits,false);
  for(let off=0;off<padded.length;off+=64){
    const w=new Array(64);
    for(let i=0;i<16;i++)w[i]=dv.getUint32(off+i*4,false);
    for(let i=16;i<64;i++){const s0=rr(7,w[i-15])^rr(18,w[i-15])^(w[i-15]>>>3);const s1=rr(17,w[i-2])^rr(19,w[i-2])^(w[i-2]>>>10);w[i]=(w[i-16]+s0+w[i-7]+s1)|0;}
    let[a,b,c,d,e,f,g,h]=H;
    for(let i=0;i<64;i++){const S1=rr(6,e)^rr(11,e)^rr(25,e);const ch=(e&f)^(~e&g);const t1=(h+S1+ch+K[i]+w[i])|0;const S0=rr(2,a)^rr(13,a)^rr(22,a);const maj=(a&b)^(a&c)^(b&c);const t2=(S0+maj)|0;h=g;g=f;f=e;e=(d+t1)|0;d=c;c=b;b=a;a=(t1+t2)|0;}
    H=[a,b,c,d,e,f,g,h].map((v,i)=>(v+H[i])|0);
  }
  return Promise.resolve(H.map(v=>(v>>>0).toString(16).padStart(8,'0')).join(''));
}

async function handleLogin() {
  const user = document.getElementById('login-user').value.trim().toLowerCase();
  const pass = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';

  if (!user || !pass) { errEl.textContent = 'Please enter username and password.'; return; }

  const hash = await sha256(pass);
  if (user !== LOGIN_USER || hash !== LOGIN_HASH) {
    errEl.textContent = 'Invalid username or password.';
    document.getElementById('login-pass').value = '';
    document.getElementById('login-pass').focus();
    return;
  }

  // Success â€” hide login, show cover
  sessionStorage.setItem('gwk_logged_in', '1');
  const overlay = document.getElementById('login-overlay');
  overlay.classList.add('hidden');
  document.getElementById('cover-page').style.display = '';
  setTimeout(() => overlay.remove(), 600);
}

function checkLoginSession() {
  if (sessionStorage.getItem('gwk_logged_in') === '1' || sessionStorage.getItem('ppp_logged_in') === '1') {
    // Already logged in this tab
    const overlay = document.getElementById('login-overlay');
    if (overlay) overlay.remove();
    document.getElementById('cover-page').style.display = '';
  }
}
checkLoginSession();
initServerData();  // Load data from server into caches

// Enter key on login inputs
document.addEventListener('DOMContentLoaded', () => {
  const loginPass = document.getElementById('login-pass');
  const loginUser = document.getElementById('login-user');
  if (loginPass) loginPass.addEventListener('keydown', e => { if (e.key === 'Enter') handleLogin(); });
  if (loginUser) loginUser.addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('login-pass').focus(); });
});

// ===== UPLOAD FUNCTIONALITY =====
let _currentUploadType = null;
let _selectedFile = null;

function openUploadPanel(type) {
  _currentUploadType = type;
  _selectedFile = null;
  document.getElementById('upload-overlay').style.display = 'flex';
  var titles = {
    'leasing': 'Update Leasing Data',
    'financials': 'Update T-12 Financials',
    'budget': 'Update Budget Data',
    'loan': 'Update Loan Data',
    'comps': 'Update Market Comps',
    'minutes': 'Upload Meeting Minutes',
  };
  document.getElementById('upload-title').textContent = titles[type] || 'Upload File';
  document.getElementById('upload-file-input').value = '';
  document.getElementById('upload-file-info').style.display = 'none';
  document.getElementById('upload-submit-btn').disabled = true;
  document.getElementById('upload-status').style.display = 'none';
  // Show/hide manual entry tab â€” only for leasing
  var tabManual = document.getElementById('upload-tab-manual');
  if (type === 'leasing') {
    tabManual.style.display = '';
    document.getElementById('manual-leasing-form').style.display = 'block';
    document.getElementById('manual-financials-msg').style.display = 'none';
  } else if (type === 'financials') {
    tabManual.style.display = '';
    document.getElementById('manual-leasing-form').style.display = 'none';
    document.getElementById('manual-financials-msg').style.display = 'block';
  } else {
    tabManual.style.display = 'none';
    document.getElementById('manual-leasing-form').style.display = 'none';
    document.getElementById('manual-financials-msg').style.display = 'none';
  }
  // Update accepted file types hint
  var hintMap = {
    'leasing': 'Supported: .xlsx, .xls, .docx, .png, .jpg (max 10MB)',
    'financials': 'Supported: .xlsx, .xls, .pdf (max 10MB)',
    'budget': 'Supported: .xlsx, .xls, .xlsb (max 10MB)',
    'loan': 'Supported: .xlsx, .xls, .pdf (max 10MB)',
    'comps': 'Supported: .pdf (max 10MB)',
    'minutes': 'Supported: .docx (max 10MB)',
  };
  document.getElementById('upload-hint').textContent = hintMap[type] || 'Max 10MB';
  switchUploadMode('file');
}

function closeUploadPanel() {
  document.getElementById('upload-overlay').style.display = 'none';
  _currentUploadType = null;
  _selectedFile = null;
}

async function undoLeasing() {
  if (!confirm('Restore leasing data to the previous version?')) return;
  try {
    var resp = await fetch(API_BASE + '/' + PROPERTY_ID + '/leasing/undo', { method: 'POST' });
    var result = await resp.json();
    if (result.ok && result.data) {
      LEASING_DATA = result.data;
      hotUpdateLeasing();
      alert('Leasing data restored to previous version (' + result.restored_from + ')');
    } else {
      alert(result.error || 'Undo failed');
    }
  } catch (e) {
    alert('Undo failed: ' + e.message);
  }
}

function switchUploadMode(mode) {
  document.getElementById('upload-mode-file').style.display = mode === 'file' ? 'block' : 'none';
  document.getElementById('upload-mode-manual').style.display = mode === 'manual' ? 'block' : 'none';
  document.getElementById('upload-tab-file').classList.toggle('active', mode === 'file');
  document.getElementById('upload-tab-manual').classList.toggle('active', mode === 'manual');
}

function handleDrop(event) {
  event.preventDefault();
  var dz = event.target.closest('.upload-dropzone');
  if (dz) dz.classList.remove('dragover');
  var files = event.dataTransfer.files;
  if (files.length > 0) selectFile(files[0]);
}

function handleUploadFileSelect(input) {
  if (input.files.length > 0) selectFile(input.files[0]);
}

function selectFile(file) {
  var ext = file.name.split('.').pop().toLowerCase();
  var isImage = ['png', 'jpg', 'jpeg'].includes(ext);
  if (!isImage && !['xlsx', 'xls', 'pdf', 'xlsb'].includes(ext)) {
    showUploadStatus('Unsupported file type. Please use .xlsx, .xls, .pdf, .xlsb, .png, or .jpg', 'error');
    return;
  }
  if (file.size > 10 * 1024 * 1024) {
    showUploadStatus('File too large (max 10MB)', 'error');
    return;
  }
  _selectedFile = file;
  document.getElementById('upload-file-name').textContent = file.name;
  document.getElementById('upload-file-size').textContent = '(' + (file.size / 1024).toFixed(0) + ' KB)';
  document.getElementById('upload-file-info').style.display = 'block';
  document.getElementById('upload-submit-btn').disabled = false;
  document.getElementById('upload-status').style.display = 'none';
  // Show image preview
  var imgPreview = document.getElementById('upload-img-preview');
  if (isImage) {
    var reader = new FileReader();
    reader.onload = function(e) { document.getElementById('upload-preview-img').src = e.target.result; };
    reader.readAsDataURL(file);
    imgPreview.style.display = 'block';
    document.getElementById('upload-submit-btn').textContent = 'Analyze with AI & Save';
  } else {
    imgPreview.style.display = 'none';
    document.getElementById('upload-submit-btn').textContent = 'Upload & Process';
  }
}

// Click dropzone to open file picker
document.addEventListener('DOMContentLoaded', function() {
  var dz = document.getElementById('upload-dropzone');
  if (dz) dz.addEventListener('click', function(e) {
    if (e.target.tagName !== 'INPUT') document.getElementById('upload-file-input').click();
  });
  // Close modal on overlay click
  var ov = document.getElementById('upload-overlay');
  if (ov) ov.addEventListener('click', function(e) {
    if (e.target === ov) closeUploadPanel();
  });
  // OCR: click dropzone to open image picker
  var ocrDz = document.getElementById('ocr-dropzone');
  if (ocrDz) ocrDz.addEventListener('click', function(e) {
    if (e.target.tagName !== 'INPUT') document.getElementById('ocr-file-input').click();
  });
  // OCR: drag & drop
  if (ocrDz) {
    ocrDz.addEventListener('dragover', function(e) { e.preventDefault(); ocrDz.classList.add('dragover'); });
    ocrDz.addEventListener('dragleave', function() { ocrDz.classList.remove('dragover'); });
    ocrDz.addEventListener('drop', function(e) {
      e.preventDefault(); ocrDz.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) loadOcrImage(e.dataTransfer.files[0]);
    });
  }
  // OCR: file input change
  var ocrInput = document.getElementById('ocr-file-input');
  if (ocrInput) ocrInput.addEventListener('change', function() {
    if (this.files.length > 0) loadOcrImage(this.files[0]);
  });
  // OCR: clipboard paste (Ctrl+V / Cmd+V)
  document.addEventListener('paste', function(e) {
    var overlay = document.getElementById('upload-overlay');
    if (!overlay || overlay.style.display === 'none') return;
    var items = e.clipboardData && e.clipboardData.items;
    if (!items) return;
    for (var i = 0; i < items.length; i++) {
      if (items[i].type.indexOf('image') !== -1) {
        e.preventDefault();
        var blob = items[i].getAsFile();
        if (blob) loadOcrImage(blob);
        return;
      }
    }
  });
});

// ===== OCR SCREENSHOT ANALYSIS =====
let _ocrImageBase64 = null;
let _ocrImageMediaType = null;

function loadOcrImage(file) {
  if (!file.type.startsWith('image/')) {
    showOcrStatus('Please use an image file (PNG, JPG)', 'error');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    showOcrStatus('Image too large (max 5MB)', 'error');
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    _ocrImageBase64 = e.target.result.split(',')[1];
    _ocrImageMediaType = file.type;
    document.getElementById('ocr-preview-img').src = e.target.result;
    document.getElementById('ocr-preview').style.display = 'block';
    document.getElementById('ocr-dropzone').style.display = 'none';
    document.getElementById('ocr-status').style.display = 'none';
    // Auto-switch to manual tab if on file tab
    switchUploadMode('manual');
  };
  reader.readAsDataURL(file);
}

function clearOcrPreview() {
  _ocrImageBase64 = null;
  _ocrImageMediaType = null;
  document.getElementById('ocr-preview').style.display = 'none';
  document.getElementById('ocr-dropzone').style.display = 'block';
  document.getElementById('ocr-status').style.display = 'none';
  document.getElementById('ocr-file-input').value = '';
  // Remove AI-filled highlights
  document.querySelectorAll('#manual-leasing-form input.ai-filled').forEach(function(inp) {
    inp.classList.remove('ai-filled');
  });
}

function showOcrStatus(msg, type) {
  var el = document.getElementById('ocr-status');
  el.textContent = msg;
  el.className = 'ocr-status ' + (type || '');
  el.style.display = 'block';
}

// ===== CLAUDE VISION OCR =====
async function analyzeScreenshot() {
  if (!_ocrImageBase64) return;
  var btn = document.getElementById('ocr-analyze-btn');
  btn.disabled = true;
  btn.textContent = 'Analyzing...';
  showOcrStatus('Sending screenshot to Claude for analysis...', 'analyzing');

  try {
    var result = await callClaudeVision(_ocrImageBase64, _ocrImageMediaType);
    fillFormFromOcr(result);
    showOcrStatus('Data extracted successfully! Please review and confirm below.', 'success');
  } catch (err) {
    console.error('OCR error:', err);
    if (err.message === 'NO_KEY') {
      showOcrStatus('No Anthropic API Key found. Please set it in the AI Chat section (gear icon).', 'error');
    } else if (err.message === 'INVALID_KEY') {
      showOcrStatus('Invalid Anthropic API Key. Please update it in the AI Chat section (gear icon).', 'error');
    } else {
      showOcrStatus('Could not extract data: ' + err.message + '. Please fill in manually.', 'error');
    }
  } finally {
    btn.disabled = false;
    btn.innerHTML = '&#9889; Analyze with AI';
  }
}

async function callClaudeVision(base64Data, mediaType) {
  // Call server-side Claude proxy (API key stored on server)
  var response = await fetch(API_BASE + '/' + PROPERTY_ID + '/ocr', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ image: base64Data, media_type: mediaType }),
  });

  var data = await response.json();
  if (!response.ok) {
    if (data.error === 'NO_KEY') throw new Error('NO_KEY');
    if (data.error === 'INVALID_KEY') throw new Error('INVALID_KEY');
    throw new Error(data.error || 'API Error ' + response.status);
  }
  return data.data;
}

function fillFormFromOcr(data) {
  var fieldMap = {
    'week_ending': 'manual-week-ending',
    'occupied_num': 'manual-occupied',
    'leased_num': 'manual-leased',
    'new_prospects': 'manual-prospects',
    'walk_in_traffic': 'manual-walkin',
    'gross_leases': 'manual-gross',
    'net_leases': 'manual-net',
    'move_in': 'manual-movein',
    'move_out': 'manual-moveout',
    'trend_30_day': 'manual-trend30',
    'trend_60_day': 'manual-trend60',
    'psf_all_leases': 'manual-psf'
  };
  // Remove previous highlights
  document.querySelectorAll('#manual-leasing-form input.ai-filled').forEach(function(inp) {
    inp.classList.remove('ai-filled');
  });
  for (var key in fieldMap) {
    var el = document.getElementById(fieldMap[key]);
    if (!el || data[key] === null || data[key] === undefined) continue;
    el.value = data[key];
    el.classList.add('ai-filled');
  }
}

async function submitFileUpload() {
  if (!_selectedFile || !_currentUploadType) return;
  var ext = _selectedFile.name.split('.').pop().toLowerCase();
  var isImage = ['png', 'jpg', 'jpeg'].includes(ext);

  if (isImage) {
    // Image: use Claude OCR to extract data, then auto-save
    await submitImageUpload();
  } else {
    // Spreadsheet/PDF: use existing server-side extractor
    await submitSpreadsheetUpload();
  }
}

async function submitImageUpload() {
  var btn = document.getElementById('upload-submit-btn');
  btn.disabled = true;
  btn.textContent = 'Analyzing with Claude...';
  showUploadStatus('Reading image and sending to Claude for analysis...', 'info');

  try {
    // Read image as base64
    var base64Data = await new Promise(function(resolve, reject) {
      var reader = new FileReader();
      reader.onload = function() {
        var result = reader.result;
        var base64 = result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(_selectedFile);
    });
    var mediaType = _selectedFile.type || 'image/png';

    // Call Claude OCR via server proxy
    var ocrResult = await callClaudeVision(base64Data, mediaType);
    showUploadStatus('Data extracted! Saving to dashboard...', 'info');

    // Auto-save: submit as a new leasing week
    if (!ocrResult.week_ending) {
      showUploadStatus('Claude could not find a week ending date in the image. Please enter manually.', 'error');
      // Switch to manual mode and fill in what we got
      switchUploadMode('manual');
      fillFormFromOcr(ocrResult);
      btn.disabled = false;
      btn.textContent = 'Analyze with AI & Save';
      return;
    }

    var resp = await fetch(API_BASE + '/' + PROPERTY_ID + '/leasing/add_week', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(ocrResult),
    });
    var result = await resp.json();
    if (result.ok && result.data) {
      LEASING_DATA = result.data;
      hotUpdateLeasing();
      showUploadStatus('Week ' + ocrResult.week_ending + ' added successfully! Charts refreshed.', 'success');
      setTimeout(closeUploadPanel, 2000);
    } else {
      showUploadStatus('Save failed: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (err) {
    console.error('Image upload error:', err);
    if (err.message === 'NO_KEY') {
      showUploadStatus('No Anthropic API Key. Please set it in the AI Chat section (gear icon).', 'error');
    } else if (err.message === 'INVALID_KEY') {
      showUploadStatus('Invalid Anthropic API Key. Please update it in the AI Chat section.', 'error');
    } else {
      showUploadStatus('Analysis failed: ' + err.message, 'error');
    }
  } finally {
    btn.disabled = false;
    btn.textContent = 'Analyze with AI & Save';
  }
}

async function submitSpreadsheetUpload() {
  var btn = document.getElementById('upload-submit-btn');
  btn.disabled = true;
  btn.textContent = 'Processing...';
  showUploadStatus('Uploading file and running analysis...', 'info');
  var formData = new FormData();
  formData.append('file', _selectedFile);
  try {
    var resp = await fetch(API_BASE + '/' + PROPERTY_ID + '/upload/' + _currentUploadType, { method: 'POST', body: formData });
    var result = await resp.json();
    if (result.ok) {
      if (result.data && _currentUploadType === 'leasing') {
        LEASING_DATA = result.data;
        hotUpdateLeasing();
        showUploadStatus('Data updated successfully! Charts refreshed.', 'success');
      } else if (result.data && _currentUploadType === 'financials') {
        FINANCIAL_DATA = result.data;
        hotUpdateFinancial();
        showUploadStatus('Data updated successfully! Charts refreshed.', 'success');
      } else {
        showUploadStatus('File uploaded! Dashboard is rebuilding â€” please refresh in a few seconds.', 'success');
      }
      setTimeout(closeUploadPanel, 2000);
    } else {
      showUploadStatus('Error: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (e) {
    showUploadStatus('Upload failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Upload & Process';
  }
}

async function submitManualLeasing() {
  var weekEnding = document.getElementById('manual-week-ending').value;
  if (!weekEnding) { showUploadStatus('Please enter the week ending date', 'error'); return; }
  showUploadStatus('Saving...', 'info');
  var body = {
    week_ending: weekEnding,
    occupied_num: parseFloat(document.getElementById('manual-occupied').value) || null,
    leased_num: parseFloat(document.getElementById('manual-leased').value) || null,
    new_prospects: parseInt(document.getElementById('manual-prospects').value) || null,
    walk_in_traffic: parseInt(document.getElementById('manual-walkin').value) || null,
    gross_leases: parseInt(document.getElementById('manual-gross').value) || null,
    net_leases: parseInt(document.getElementById('manual-net').value) || null,
    move_in: parseInt(document.getElementById('manual-movein').value) || null,
    move_out: parseInt(document.getElementById('manual-moveout').value) || null,
    trend_30_day: parseFloat(document.getElementById('manual-trend30').value) || null,
    trend_60_day: parseFloat(document.getElementById('manual-trend60').value) || null,
    psf_all_leases: parseFloat(document.getElementById('manual-psf').value) || null,
  };
  try {
    var resp = await fetch(API_BASE + '/' + PROPERTY_ID + '/leasing/add_week', {
      method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
    });
    var result = await resp.json();
    if (result.ok && result.data) {
      LEASING_DATA = result.data;
      hotUpdateLeasing();
      showUploadStatus('Week added successfully!', 'success');
      document.querySelectorAll('#manual-leasing-form input').forEach(function(i) { i.value = ''; });
      setTimeout(closeUploadPanel, 1500);
    } else {
      showUploadStatus('Error: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (e) {
    showUploadStatus('Save failed: ' + e.message, 'error');
  }
}

function showUploadStatus(msg, type) {
  var el = document.getElementById('upload-status');
  el.style.display = 'block';
  el.className = 'upload-status ' + type;
  el.textContent = msg;
}

// Hot-update: destroy old Chart.js instances and re-render
function hotUpdateLeasing() {
  var container = document.getElementById('leasing');
  if (container) {
    container.querySelectorAll('canvas').forEach(function(canvas) {
      var chart = Chart.getChart(canvas);
      if (chart) chart.destroy();
    });
  }
  try { renderLeasing(); } catch(e) { console.error('hotUpdateLeasing error:', e); }
}

function hotUpdateFinancial() {
  var container = document.getElementById('financial');
  if (container) {
    container.querySelectorAll('canvas').forEach(function(canvas) {
      var chart = Chart.getChart(canvas);
      if (chart) chart.destroy();
    });
  }
  try { renderFinancial(); } catch(e) { console.error('hotUpdateFinancial error:', e); }
}

// Check server for updated data on page load
async function checkForUpdatedData() {
  try {
    var [leasingResp, financialsResp] = await Promise.all([
      serverLoad('leasing'), serverLoad('financials')
    ]);
    if (leasingResp && leasingResp.weeks && leasingResp.weeks.length > 0) {
      var serverLatest = leasingResp.weeks[leasingResp.weeks.length - 1].week_ending || '';
      var localLatest = (LEASING_DATA.weeks && LEASING_DATA.weeks.length > 0)
        ? LEASING_DATA.weeks[LEASING_DATA.weeks.length - 1].week_ending || '' : '';
      if (serverLatest > localLatest) {
        LEASING_DATA = leasingResp;
        hotUpdateLeasing();
        console.log('[upload] Leasing data updated from server');
      }
    }
    if (financialsResp && financialsResp.status === 'loaded') {
      FINANCIAL_DATA = financialsResp;
      hotUpdateFinancial();
      console.log('[upload] Financial data updated from server');
    }
  } catch (e) { console.warn('[upload] Could not check for updated data:', e); }
}

// ===== COVER / DASHBOARD TOGGLE =====
function enterDashboard() {
  document.getElementById('cover-page').style.display = 'none';
  document.getElementById('dashboard').classList.add('visible');
}
function returnToCover() {
  document.getElementById('dashboard').classList.remove('visible');
  document.getElementById('cover-page').style.display = '';
  window.scrollTo(0, 0);
}

// ===== TAB NAVIGATION =====
function switchTab(tabId) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelector(`.nav-tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
  // Trigger Google Maps resize when comps tab becomes visible
  if (tabId === 'comps' && compsMap) {
    setTimeout(() => google.maps.event.trigger(compsMap, 'resize'), 100);
  }
}

// ===== HELPERS =====
function fmt(val, type) {
  if (val === null || val === undefined) return 'N/A';
  if (type === 'pct') return val.toFixed(1) + '%';
  if (type === 'dollar') return '$' + Math.round(val).toLocaleString();
  return val.toString();
}

function kpiCard(label, value, sub, trendClass, isGold) {
  return `<div class="kpi-card${isGold ? ' gold' : ''}">
    <div class="label">${label}</div>
    <div class="value ${trendClass || ''}">${value}</div>
    ${sub ? `<div class="sub">${sub}</div>` : ''}
  </div>`;
}

// Chart.js global defaults
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.font.size = 11;
Chart.defaults.color = '#6b7a8d';

const C = {
  navy: 'rgba(10,22,40,0.85)', navyFill: 'rgba(10,22,40,0.08)',
  gold: 'rgba(200,165,90,0.9)', goldFill: 'rgba(200,165,90,0.12)',
  green: 'rgba(45,159,111,0.85)', greenFill: 'rgba(45,159,111,0.1)',
  red: 'rgba(217,68,82,0.85)',
  blue: 'rgba(53,116,184,0.8)',
  orange: 'rgba(212,135,42,0.85)',
  purple: 'rgba(124,92,191,0.8)',
  teal: 'rgba(42,157,143,0.8)',
  gray: 'rgba(107,122,141,0.6)',
};

// ===== LEASING TAB =====
function renderLeasing() {
  const weeks = LEASING_DATA.weeks || [];
  const xlsx = LEASING_DATA.xlsx_data || {};
  const latest = weeks.length > 0 ? weeks[weeks.length - 1] : null;
  const kpisEl = document.getElementById('leasing-kpis');
  const detailsEl = document.getElementById('leasing-details');

  if (!latest) {
    kpisEl.innerHTML = '<div class="chart-card" style="text-align:center;padding:40px;grid-column:1/-1"><h3>No leasing data available yet</h3></div>';
    return;
  }

  // --- KPI Cards ---
  const budgetOcc = BUDGET_DATA.metrics?.targeted_occupancy?.[1] ?? null;
  const occDiff = budgetOcc ? (latest.occupancy_pct - budgetOcc * 100) : null;
  const occSub = occDiff !== null ? `vs Budget ${fmt(budgetOcc*100,'pct')} (${occDiff > 0 ? '+' : ''}${occDiff.toFixed(1)}pp)` : '';
  const occTrend = occDiff !== null ? (occDiff >= 0 ? 'trend-up' : 'trend-down') : '';

  const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : null;
  const occChange = prevWeek ? (latest.occupancy_pct - prevWeek.occupancy_pct) : null;
  const occChangeSub = occChange !== null ? `WoW: ${occChange >= 0 ? '+' : ''}${occChange.toFixed(2)}pp` : '';

  const psf = latest.psf_all_leases || weeks.slice().reverse().find(w => w.psf_all_leases)?.psf_all_leases;
  const totalProspects = weeks.reduce((s,w) => s + (w.new_prospects || 0), 0);
  const totalLeases = weeks.reduce((s,w) => s + (w.gross_leases || 0), 0);
  const convRate = totalProspects > 0 ? ((totalLeases / totalProspects) * 100).toFixed(1) + '%' : 'N/A';

  kpisEl.innerHTML = [
    kpiCard('Current Occupancy', fmt(latest.occupancy_pct, 'pct'), `${occSub} | ${occChangeSub}`, occTrend, true),
    kpiCard('Leased %', fmt(latest.leased_pct, 'pct'), `${latest.occupied_num || Math.round(latest.occupancy_pct / 100 * 324)} occupied / ${latest.leased_num || Math.round(latest.leased_pct / 100 * 324)} leased of 324`),
    kpiCard('30-Day Trend', fmt(latest.trend_30_day, 'pct'), latest.trend_60_day ? `60-Day: ${fmt(latest.trend_60_day, 'pct')}` : ''),
    kpiCard('Rent PSF', psf ? `$${psf.toFixed(2)}` : 'N/A', 'All Leases Avg', '', true),
    kpiCard('Conversion Rate', convRate, `${totalLeases} leases / ${totalProspects} prospects (cumulative)`),
  ].join('');

  // --- Occupancy Chart ---
  const chartWeeks = weeks.filter(w => w.occupancy_pct !== null && w.occupancy_pct !== undefined && typeof w.occupancy_pct === 'number');
  const labels = chartWeeks.map(w => { const d = new Date(w.week_ending); return (d.getMonth()+1)+'/'+d.getDate(); });
  const occData = chartWeeks.map(w => w.occupancy_pct);
  const leasedData = chartWeeks.map(w => w.leased_pct);
  const t30Data = chartWeeks.map(w => w.trend_30_day);
  const t60Data = chartWeeks.map(w => w.trend_60_day);

  if (occData.length > 0) {
    new Chart(document.getElementById('occupancy-chart'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Occupied %', data: occData, borderColor: C.navy, backgroundColor: C.navyFill, fill: true, tension: 0.3, borderWidth: 2.5, pointRadius: 4, pointBackgroundColor: C.navy },
          { label: 'Leased %', data: leasedData, borderColor: C.gold, backgroundColor: C.goldFill, fill: false, tension: 0.3, borderWidth: 2, pointRadius: 3, pointBackgroundColor: C.gold },
          { label: '30-Day Trend', data: t30Data, borderColor: C.orange, borderDash:[6,3], tension: 0.3, borderWidth: 1.5, pointRadius: 0 },
          { label: '60-Day Trend', data: t60Data, borderColor: C.purple, borderDash:[4,4], tension: 0.3, borderWidth: 1.5, pointRadius: 0 },
          budgetOcc ? { label: 'Budget Target', data: labels.map(() => budgetOcc * 100), borderColor: C.red, borderDash: [10,5], pointRadius: 0, borderWidth: 1.5 } : null,
        ].filter(Boolean),
      },
      options: { responsive: true, scales: { y: { min: 82, max: 100, ticks: { callback: v => v + '%' } } }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font:{size:10} } } } },
    });
  }

  // --- Leasing Activity Chart ---
  const actWeeks = weeks.filter(w => w.source_type !== 'docx');
  if (actWeeks.length > 0) {
    const actLabels = actWeeks.map(w => { const d = new Date(w.week_ending); return (d.getMonth()+1)+'/'+d.getDate(); });
    new Chart(document.getElementById('leasing-activity-chart'), {
      type: 'bar',
      data: {
        labels: actLabels,
        datasets: [
          { label: 'New Prospects', data: actWeeks.map(w=>w.new_prospects||0), backgroundColor: C.navy, borderRadius: 3 },
          { label: 'Walk-In Traffic', data: actWeeks.map(w=>w.walk_in_traffic||0), backgroundColor: C.gold, borderRadius: 3 },
          { label: 'Gross Leases', data: actWeeks.map(w=>w.gross_leases||0), backgroundColor: C.green, borderRadius: 3 },
        ],
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font:{size:10} } } } },
    });
  }

  // --- Concessions ---
  const conc = xlsx.concessions || latest.concessions || [];
  const delinqNotes = xlsx.delinquency_notes || [];
  const concEl = document.getElementById('concession-container');
  if (conc.length > 0 || delinqNotes.length > 0) {
    let ch = '<div class="concession-strip">';
    conc.forEach((c, i) => {
      ch += `<div class="concession-item"><div class="concession-label">Concession ${i+1}</div>${c}</div>`;
    });
    ch += '</div>';
    concEl.innerHTML = ch;
  }

  // --- Weekly Metrics Table (preserving original xlsx table) ---
  const wtc = document.getElementById('weekly-table-container');
  const xlsxWeeks = weeks.filter(w => w.source_type !== 'docx').slice().reverse(); // newest first like original
  if (xlsxWeeks.length > 0) {
    let t = '<table class="leasing-table"><thead><tr><th>Metric</th>';
    xlsxWeeks.forEach(w => {
      const d = new Date(w.week_ending);
      t += `<th>${(d.getMonth()+1)}/${d.getDate()}/${String(d.getFullYear()).slice(2)}</th>`;
    });
    t += '</tr></thead><tbody>';

    const rows = [
      { label: 'Leased #', key: 'leased_num', fmt: 'int' },
      { label: 'Leased %', key: 'leased_pct', fmt: 'pct', highlight: true },
      { label: 'Occupied #', key: 'occupied_num', fmt: 'int' },
      { label: 'Occupied %', key: 'occupied_pct', fmt: 'pct', highlight: true },
      { label: 'Move Out', key: 'move_out', fmt: 'int' },
      { label: 'Move In', key: 'move_in', fmt: 'int' },
      { label: 'New Prospects', key: 'new_prospects', fmt: 'int' },
      { label: 'Walk-In Traffic', key: 'walk_in_traffic', fmt: 'int' },
      { label: 'Gross Leases', key: 'gross_leases', fmt: 'int' },
      { label: 'Net Leases', key: 'net_leases', fmt: 'int' },
      { label: '30-Day Occp Trend', key: 'trend_30_day', fmt: 'pct' },
      { label: '60-Day Occp Trend', key: 'trend_60_day', fmt: 'pct' },
      { label: 'PSF - All Leases', key: 'psf_all_leases', fmt: 'dollar2' },
    ];

    rows.forEach(row => {
      t += `<tr class="${row.highlight ? 'highlight-row' : ''}"><td>${row.label}</td>`;
      xlsxWeeks.forEach((w, wi) => {
        let v = w[row.key];
        let cls = '';
        let formatted;
        if (v === null || v === undefined || v === '-' || v === '%' || typeof v === 'string') { formatted = '-'; }
        else if (typeof v !== 'number' || isNaN(v)) { formatted = '-'; }
        else if (row.fmt === 'pct') {
          formatted = v.toFixed(2) + '%';
          cls = 'pct-cell';
          if (wi < xlsxWeeks.length - 1) {
            const prev = xlsxWeeks[wi + 1]?.[row.key];
            if (prev !== null && prev !== undefined && typeof prev === 'number' && !isNaN(prev)) {
              cls += v > prev ? ' trend-up-cell' : v < prev ? ' trend-down-cell' : '';
            }
          }
        }
        else if (row.fmt === 'dollar2') { formatted = '$' + v.toFixed(2); }
        else { formatted = Math.round(v).toLocaleString(); }
        t += `<td class="${cls}">${formatted}</td>`;
      });
      t += '</tr>';
    });
    t += '</tbody></table>';
    wtc.innerHTML = t;
  }

  // --- Expiration Matrix Table ---
  const expMatrix = xlsx.expiration_matrix || [];
  const expEl = document.getElementById('exp-matrix-container');
  const expDateEl = document.getElementById('exp-matrix-date');
  if (expMatrix.length > 0) {
    // Use the latest snapshot
    const latest_exp = expMatrix[0];
    expDateEl.textContent = new Date(latest_exp.as_of_date).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});

    const months = latest_exp.months;
    let t = '<table class="exp-matrix-table"><thead><tr><th>Metric</th>';
    months.forEach(m => { t += `<th class="month-group">${m.month}</th>`; });
    t += '</tr></thead><tbody>';

    const expRows = [
      { label: 'Expiring', key: 'expiring' },
      { label: 'Notice', key: 'notice' },
      { label: 'Renewals', key: 'renewals' },
      { label: 'Month-to-Month', key: 'month_to_month' },
      { label: 'Transfers', key: 'transfers' },
      { label: 'Pending', key: 'pending' },
      { label: 'Avg $ Increase %', key: 'avg_increase_pct', fmt: 'pct2' },
      { label: 'Renewal Retention', key: 'retention_pct', fmt: 'pct1' },
    ];

    expRows.forEach(row => {
      t += `<tr><td>${row.label}</td>`;
      months.forEach((m, mi) => {
        let v = m[row.key];
        let cls = mi === 0 ? 'month-first' : '';
        let formatted;
        if (v === null || v === undefined) { formatted = '-'; }
        else if (row.fmt === 'pct2') { formatted = v.toFixed(2) + '%'; }
        else if (row.fmt === 'pct1') {
          formatted = v.toFixed(1) + '%';
          cls += v >= 40 ? ' retention-high' : v > 0 ? ' retention-low' : '';
        }
        else { formatted = Math.round(v).toString(); }
        t += `<td class="${cls}">${formatted}</td>`;
      });
      t += '</tr>';
    });
    t += '</tbody></table>';
    expEl.innerHTML = t;
  }

  // --- Delinquency Notes ---
  const dnEl = document.getElementById('delinquency-notes-container');
  const allDelinqNotes = xlsx.delinquency_notes || [];
  if (allDelinqNotes.length > 0) {
    let dh = '<div class="concession-strip">';
    allDelinqNotes.forEach((note, i) => {
      const label = i === 0 ? 'Delinquency' : `Additional Note ${i}`;
      dh += `<div class="concession-item"><div class="concession-label">${label}</div>${note}</div>`;
    });
    dh += '</div>';
    dnEl.innerHTML = dh;
  }

  // --- Follow Up / Supplemental Details ---
  const latestDocx = weeks.filter(w => w.notes && w.notes.length > 0).slice(-1)[0];
  if (latestDocx || latest.delinquency_total) {
    detailsEl.innerHTML = `
      ${latest.delinquency_total ? `<div class="detail-card"><h4>Delinquency</h4>
        <ul><li><strong>Total:</strong> ${fmt(latest.delinquency_total, 'dollar')}</li>${latest.evictions_filed ? `<li><strong>Evictions Filed:</strong> ${latest.evictions_filed}</li>` : ''}</ul></div>` : ''}
      ${latestDocx && latestDocx.notes && latestDocx.notes.length > 0 ? `<div class="detail-card"><h4>Follow Up (${latestDocx.week_ending})</h4>
        <ul>${latestDocx.notes.filter(n=>n.length>5&&n.length<300).map(n=>`<li>${n}</li>`).join('')}</ul></div>` : ''}
      ${latest.renewal_conversion_pct ? `<div class="detail-card"><h4>Renewals (DOCX Detail)</h4>
        <ul><li><strong>Conversion:</strong> ${fmt(latest.renewal_conversion_pct, 'pct')}</li>${latest.renewal_expiring_count ? `<li><strong>Expiring:</strong> ${latest.renewal_expiring_count}</li>` : ''}</ul></div>` : ''}
    `;
  }
}

// ===== FINANCIAL TAB =====
function renderFinancial() {
  // Use T-12 actuals as primary source, budget as reference
  const F = FINANCIAL_DATA;
  const hasT12 = F && F.status === 'loaded';
  const months = hasT12 ? (F.months || []) : (BUDGET_DATA.months || []);
  const m = hasT12 ? (F.metrics || {}) : (BUDGET_DATA.metrics || {});
  const totals = hasT12 ? (F.annual_totals || {}) : (BUDGET_DATA.annual_totals || {});
  const kpisEl = document.getElementById('financial-kpis');

  // Update subtitle
  if (hasT12) {
    document.getElementById('financial-subtitle').innerHTML = `Prior T-12 Actuals &mdash; ${F.period || 'Oct 2024 â€“ Sep 2025'} &middot; Source: ${F.source || 'Yardi'}`;
  }

  const noiMargin = totals.total_income ? ((totals.noi / totals.total_income) * 100).toFixed(1) : 0;
  const noiPerUnit = totals.noi_per_unit || Math.round(totals.noi / 324);
  const opexRatio = totals.opex_ratio || (totals.total_income ? ((totals.total_opex / totals.total_income) * 100).toFixed(1) : 0);

  kpisEl.innerHTML = [
    kpiCard('T-12 Revenue', fmt(totals.total_income,'dollar'), `${fmt(Math.round(totals.total_income/12),'dollar')}/mo avg`, '', true),
    kpiCard('T-12 OpEx', fmt(totals.total_opex,'dollar'), `${opexRatio}% of revenue | ${fmt(Math.round(totals.total_opex/12),'dollar')}/mo`),
    kpiCard('T-12 NOI', fmt(totals.noi,'dollar'), `${noiMargin}% margin | $${noiPerUnit.toLocaleString()}/unit`, '', true),
    kpiCard('T-12 Concessions', fmt(totals.total_concessions,'dollar'), `Vacancy: ${fmt(totals.vacancy_loss,'dollar')}`),
    kpiCard('T-12 Bad Debt', fmt(totals.bad_debt,'dollar'), `${fmt(Math.round((totals.bad_debt||0)/12),'dollar')}/mo avg`),
  ].join('');

  // --- Revenue Chart ---
  if (m.total_income) {
    new Chart(document.getElementById('revenue-chart'), {
      type: 'bar', data: { labels: months, datasets: [
        { label: 'Total Income', data: m.total_income, backgroundColor: C.navy, borderRadius: 4 },
        { label: 'Rental Income', data: m.total_rental_income, backgroundColor: C.gold, borderRadius: 4 },
        { label: 'Other Income', data: m.total_other_income, backgroundColor: C.teal, borderRadius: 4 },
      ]}, options: { responsive: true, scales: { y: { ticks: { callback: v=>'$'+(v/1000).toFixed(0)+'K' } } }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font:{size:10} } } } },
    });
  }

  // --- OpEx Breakdown Chart ---
  if (m.payroll_benefits) {
    new Chart(document.getElementById('opex-chart'), {
      type: 'bar', data: { labels: months, datasets: [
        { label: 'Payroll', data: m.payroll_benefits, backgroundColor: C.navy },
        { label: 'Contract Svc', data: m.contract_services, backgroundColor: C.orange },
        { label: 'Utilities', data: m.utilities, backgroundColor: C.teal },
        { label: 'Marketing', data: m.marketing, backgroundColor: C.gold },
        { label: 'Insurance', data: m.insurance, backgroundColor: C.purple },
        { label: 'Mgmt Fees', data: m.management_fees, backgroundColor: C.blue },
        { label: 'Other', data: months.map((_,i)=>Math.max(0,(m.total_opex?.[i]||0)-(m.payroll_benefits?.[i]||0)-(m.contract_services?.[i]||0)-(m.utilities?.[i]||0)-(m.marketing?.[i]||0)-(m.insurance?.[i]||0)-(m.management_fees?.[i]||0))), backgroundColor: C.gray },
      ]}, options: { responsive: true, scales: { x:{stacked:true}, y:{stacked:true, ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'K'}} }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font:{size:9} } } } },
    });
  }

  // --- NOI Trend Chart ---
  if (m.noi) {
    const avgNoi = m.noi.reduce((a,b)=>a+b,0) / m.noi.length;
    new Chart(document.getElementById('noi-chart'), {
      type: 'line', data: { labels: months, datasets: [
        { label: 'NOI', data: m.noi, borderColor: C.green, backgroundColor: C.greenFill, fill: true, tension: 0.3, borderWidth: 2.5, pointRadius: 4, pointBackgroundColor: C.green },
        { label: 'Avg NOI', data: months.map(()=>avgNoi), borderColor: C.gray, borderDash:[8,4], pointRadius: 0, borderWidth: 1.5 },
      ]}, options: { responsive: true, scales: { y: { ticks: { callback: v=>'$'+(v/1000).toFixed(0)+'K' } } }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } },
    });
  }

  // --- Vacancy & Concession Chart ---
  if (m.vacancy_loss || m.total_concessions) {
    new Chart(document.getElementById('vacancy-chart'), {
      type: 'bar', data: { labels: months, datasets: [
        { label: 'Vacancy Loss', data: (m.vacancy_loss||[]).map(v=>Math.abs(v)), backgroundColor: C.red, borderRadius: 3 },
        { label: 'Concessions', data: (m.total_concessions||[]).map(v=>Math.abs(v)), backgroundColor: C.orange, borderRadius: 3 },
        { label: 'Bad Debt', data: (m.bad_debt_rent||[]).map(v=>Math.abs(v)), backgroundColor: C.purple, borderRadius: 3 },
      ]}, options: { responsive: true, scales: { x:{stacked:true}, y:{stacked:true, ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'K'}} }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font:{size:10} } } } },
    });
  }

  // --- T-12 Detail Table ---
  renderFinancialTable();
}

// Separate function for table rendering (called on comment save/delete without recreating charts)
function renderFinancialTable() {
  const F = FINANCIAL_DATA;
  const hasT12 = F && F.status === 'loaded';
  const months = hasT12 ? (F.months || []) : (BUDGET_DATA.months || []);
  const m = hasT12 ? (F.metrics || {}) : (BUDGET_DATA.metrics || {});
  const cellComments = loadCellComments();

  const tc = document.getElementById('budget-table-container');
  const rows = [
    {section:'INCOME'},
    {key:'market_rent',label:'Market Rent',format:'dollar'},
    {key:'gain_loss_to_lease',label:'Gain/Loss to Lease',format:'dollar'},
    {key:'potential_rent',label:'Potential Rent',format:'dollar',total:true},
    {key:'one_time_concessions',label:'One-Time Concessions',format:'dollar'},
    {key:'renewal_concessions',label:'Renewal Concessions',format:'dollar'},
    {key:'vacancy_loss',label:'Vacancy Loss',format:'dollar'},
    {key:'bad_debt_rent',label:'Bad Debt',format:'dollar'},
    {key:'total_rental_income',label:'TOTAL RENTAL INCOME',format:'dollar',total:true},
    {key:'total_other_income',label:'Other Income',format:'dollar'},
    {key:'total_income',label:'TOTAL INCOME',format:'dollar',total:true},
    {section:'OPERATING EXPENSES'},
    {key:'payroll_benefits',label:'Payroll & Benefits',format:'dollar'},
    {key:'repairs_maintenance',label:'Repairs & Maintenance',format:'dollar'},
    {key:'make_ready',label:'Make-Ready / Redecorating',format:'dollar'},
    {key:'contract_services',label:'Contract Services',format:'dollar'},
    {key:'marketing',label:'Marketing',format:'dollar'},
    {key:'office_expenses',label:'Office Expenses',format:'dollar'},
    {key:'other_admin',label:'Other G&A',format:'dollar'},
    {key:'utilities',label:'Utilities',format:'dollar'},
    {key:'management_fees',label:'Management Fees',format:'dollar'},
    {key:'taxes',label:'Taxes',format:'dollar'},
    {key:'insurance',label:'Insurance',format:'dollar'},
    {key:'total_opex',label:'TOTAL OPERATING EXPENSES',format:'dollar',total:true},
    {section:''},
    {key:'noi',label:'NET OPERATING INCOME',format:'dollar',total:true},
  ];
  let t='<table class="budget-table"><thead><tr><th>Line Item</th>';
  months.forEach(mo=>{t+=`<th>${mo}</th>`;});
  t+='<th>T-12 Total</th></tr></thead><tbody>';
  rows.forEach(row=>{
    if(row.section !== undefined && !row.key){t+=`<tr class="section-header"><td colspan="${months.length+2}">${row.section}</td></tr>`;return;}
    const vals=m[row.key]||[];const annual=vals.reduce((s,v)=>s+(v||0),0);
    t+=`<tr class="${row.total?'total-row':''}"><td>${row.label}</td>`;
    vals.forEach((v,ci)=>{
      let f;
      if(row.format==='dollar'){f=v!==null&&v!==0?'$'+Math.round(v).toLocaleString():'-';if(v<0)f=`<span class="negative">${f}</span>`;}
      else f=v!==null?v.toString():'-';
      const cKey=row.key+'_'+ci;
      const hasC=cellComments[cKey]?' has-comment':'';
      t+=`<td data-row="${row.key}" data-col="${ci}" class="${hasC}">${f}</td>`;
    });
    let af;
    if(row.format==='dollar'){af='$'+Math.round(annual).toLocaleString();if(annual<0)af=`<span class="negative">${af}</span>`;}
    else af='-';
    const tKey=row.key+'_total';
    const hasTc=cellComments[tKey]?' has-comment':'';
    t+=`<td data-row="${row.key}" data-col="total" class="${hasTc}">${af}</td></tr>`;
  });
  t+='</tbody></table>';tc.innerHTML=t;
}

// ===== PDF EXPORT =====
function exportFinancialPDF() {
  const F = FINANCIAL_DATA;
  const hasT12 = F && F.status === 'loaded';
  const period = hasT12 ? (F.period || 'Oct 2024 â€“ Sep 2025') : 'Oct 2024 â€“ Sep 2025';

  // Populate print header
  const periodEl = document.getElementById('print-header-period');
  const dateEl = document.getElementById('print-header-date');
  periodEl.textContent = 'Period: ' + period;
  dateEl.textContent = 'Exported: ' + new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });

  // Ensure financial section is visible
  const sec = document.getElementById('financial');
  const wasActive = sec.classList.contains('active');
  if (!wasActive) sec.classList.add('active');

  // Trigger print
  window.print();

  // Cleanup
  const cleanup = () => {
    if (!wasActive) sec.classList.remove('active');
  };
  window.addEventListener('afterprint', function onAP() {
    cleanup();
    window.removeEventListener('afterprint', onAP);
  });
  setTimeout(cleanup, 2000);
}

// ===== COMPS TAB =====
function renderComps() {
  const D = COMPS_DATA;
  const fps = D.gwk_floor_plans || [];
  const comps = D.competitors || [];
  const compAvg = D.comp_averages || {};
  const gwkAvg = D.gwk_type_avg || {};
  const kpisEl = document.getElementById('comps-kpis');

  // --- KPI Cards ---
  const gwk1br = gwkAvg['1BR'];
  const gwk2br = gwkAvg['2BR'];
  const gwk3br = gwkAvg['3BR'];
  const diff1 = gwk1br && compAvg['1x1'] ? (gwk1br.avg_psf - compAvg['1x1']) : null;
  const diff2 = gwk2br && compAvg['2x2'] ? (gwk2br.avg_psf - compAvg['2x2']) : null;

  kpisEl.innerHTML = [
    kpiCard('GWK 1BR Avg $/SF', gwk1br ? '$'+gwk1br.avg_psf.toFixed(2) : 'N/A',
      compAvg['1x1'] ? `Comp Avg: $${compAvg['1x1'].toFixed(2)} (${diff1>0?'+':''}$${diff1?.toFixed(2)})` : '', '', true),
    kpiCard('GWK 2BR Avg $/SF', gwk2br ? '$'+gwk2br.avg_psf.toFixed(2) : 'N/A',
      compAvg['2x2'] ? `Comp Avg: $${compAvg['2x2'].toFixed(2)} (${diff2>0?'+':''}$${diff2?.toFixed(2)})` : ''),
    kpiCard('GWK 3BR Avg $/SF', gwk3br ? '$'+gwk3br.avg_psf.toFixed(2) : 'N/A',
      compAvg['3x'] ? `Comp Avg: $${compAvg['3x'].toFixed(2)}` : '', '', true),
    kpiCard('Avg Comp Exposure', D.avg_exposure+'%', `${comps.length} competitors surveyed`),
  ].join('');

  // --- GWK Concession Banner ---
  const concEl = document.getElementById('comps-gwk-concession');
  if (D.gwk_concession) {
    concEl.innerHTML = `<div class="concession-strip"><div class="concession-item" style="flex:none;width:100%">
      <div class="concession-label">GWK Current Concession</div>${D.gwk_concession}
    </div></div>`;
  }

  // --- Rent/SF Comparison Chart (GWK vs Comp Avg) ---
  const types = ['1BR / 1x1', '2BR / 2x2', '3BR / 3x'];
  const gwkVals = [gwkAvg['1BR']?.avg_psf, gwkAvg['2BR']?.avg_psf, gwkAvg['3BR']?.avg_psf];
  const compVals = [compAvg['1x1'], compAvg['2x2'], compAvg['3x']];
  new Chart(document.getElementById('comps-psf-compare-chart'), {
    type: 'bar',
    data: {
      labels: types,
      datasets: [
        { label: 'GWK Avg $/SF', data: gwkVals, backgroundColor: C.gold, borderRadius: 4 },
        { label: 'Comp Avg $/SF', data: compVals, backgroundColor: C.navy, borderRadius: 4 },
      ],
    },
    options: {
      responsive: true,
      scales: { y: { ticks: { callback: v => '$'+v.toFixed(2) } } },
      plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': $' + ctx.raw?.toFixed(2) } } },
    },
  });

  // --- Exposure Rate Chart ---
  new Chart(document.getElementById('comps-exposure-chart'), {
    type: 'bar',
    data: {
      labels: comps.map(c => c.name.length > 18 ? c.name.substring(0,18)+'â€¦' : c.name),
      datasets: [{
        label: 'Exposure %',
        data: comps.map(c => c.exposure),
        backgroundColor: comps.map(c => c.exposure > 15 ? C.red : c.exposure > 10 ? C.orange : C.green),
        borderRadius: 3,
      }],
    },
    options: {
      responsive: true, indexAxis: 'y',
      scales: { x: { ticks: { callback: v => v+'%' } } },
      plugins: { legend: { display: false },
        tooltip: { callbacks: { label: ctx => ctx.raw + '% exposure' } } },
    },
  });

  // --- GWK Floor Plan Pricing Table ---
  const gwkEl = document.getElementById('comps-gwk-table');
  let gt = '<table class="comps-table"><thead><tr><th>Floor Plan</th><th>Type</th><th>SF</th><th>Market Rent</th><th>Rent/SF</th></tr></thead><tbody>';
  fps.forEach(fp => {
    const cls = fp.is_essential ? '' : 'subject';
    gt += `<tr class="${cls}"><td>${fp.plan}</td><td>${fp.type}</td><td>${fp.sf.toLocaleString()}</td><td>$${fp.market_rent.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td><td>$${fp.rent_psf.toFixed(2)}</td></tr>`;
  });
  // Average rows by type
  for (const [t, avg] of Object.entries(gwkAvg)) {
    gt += `<tr class="avg-row"><td>${t} Average</td><td>${t}</td><td>-</td><td>$${avg.avg_rent.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td><td>$${avg.avg_psf.toFixed(2)}</td></tr>`;
  }
  gt += '</tbody></table>';
  gwkEl.innerHTML = gt;

  // --- Competitor Comps Table ---
  const compEl = document.getElementById('comps-competitor-table');
  let ct = '<table class="comps-table"><thead><tr><th>Property</th><th>Exposure</th><th>1x1 $/SF</th><th>2x2 $/SF</th><th>3x $/SF</th><th>Concession</th></tr></thead><tbody>';
  comps.forEach(c => {
    const r = c.rent_by_type;
    const threeBr = r['3x2'] || r['3x1'] || r['3BR'] || null;
    ct += `<tr>
      <td>${c.name}</td>
      <td style="text-align:center;font-weight:600;${c.exposure>15?'color:var(--red)':c.exposure>10?'color:var(--orange)':'color:var(--green)'}">${c.exposure}%</td>
      <td style="text-align:right">${r['1x1'] ? '$'+r['1x1'].toFixed(2) : '-'}</td>
      <td style="text-align:right">${r['2x2'] ? '$'+r['2x2'].toFixed(2) : '-'}</td>
      <td style="text-align:right">${threeBr ? '$'+threeBr.toFixed(2) : '-'}</td>
      <td style="font-size:12px;max-width:260px">${c.concession}</td>
    </tr>`;
  });
  ct += `<tr class="avg-row"><td>Comp Average</td><td style="text-align:center">${D.avg_exposure}%</td><td style="text-align:right">$${compAvg['1x1']?.toFixed(2)||'-'}</td><td style="text-align:right">$${compAvg['2x2']?.toFixed(2)||'-'}</td><td style="text-align:right">$${compAvg['3x']?.toFixed(2)||'-'}</td><td>-</td></tr>`;
  ct += '</tbody></table>';
  compEl.innerHTML = ct;

  // --- Comps Map ---
  renderCompsMap(comps);
}

// ===== COMPS MAP (Google Maps) =====
let compsMap = null;
function renderCompsMap(comps) {
  const mapEl = document.getElementById('comps-map');
  if (!mapEl || typeof google === 'undefined' || !google.maps) return;

  const GWK = { name: 'Greenwood at Katy', lat: 29.7948, lng: -95.8017 };

  // Init map centered on GWK
  compsMap = new google.maps.Map(mapEl, {
    center: { lat: GWK.lat, lng: GWK.lng },
    zoom: 13,
    mapTypeId: 'roadmap',
    styles: [
      { featureType: 'poi', stylers: [{ visibility: 'off' }] },
      { featureType: 'transit', stylers: [{ visibility: 'off' }] },
    ],
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: true,
  });

  const bounds = new google.maps.LatLngBounds();

  // === Helper: create always-visible label overlay ===
  class MapLabel extends google.maps.OverlayView {
    constructor(pos, text, isGwk) {
      super();
      this.pos = pos;
      this.text = text;
      this.isGwk = isGwk;
    }
    onAdd() {
      this.div = document.createElement('div');
      this.div.className = this.isGwk ? 'gmap-label gmap-label-gwk' : 'gmap-label';
      this.div.textContent = this.text;
      this.div.style.position = 'absolute';
      this.div.style.cursor = 'default';
      this.getPanes().overlayMouseTarget.appendChild(this.div);
    }
    draw() {
      const proj = this.getProjection();
      const pt = proj.fromLatLngToDivPixel(this.pos);
      if (pt) {
        this.div.style.left = (pt.x - this.div.offsetWidth / 2) + 'px';
        this.div.style.top = (pt.y - this.div.offsetHeight - 18) + 'px';
      }
    }
    onRemove() { if (this.div) this.div.remove(); }
  }

  // GWK marker (gold)
  const gwkPos = new google.maps.LatLng(GWK.lat, GWK.lng);
  new google.maps.Marker({
    position: gwkPos, map: compsMap, zIndex: 999,
    icon: {
      path: google.maps.SymbolPath.CIRCLE, scale: 10,
      fillColor: '#C8A55A', fillOpacity: 1,
      strokeColor: '#0A1628', strokeWeight: 3,
    },
  });
  new MapLabel(gwkPos, 'â˜… Greenwood at Katy', true).setMap(compsMap);
  bounds.extend(gwkPos);

  // Comp markers (navy)
  comps.forEach(c => {
    if (!c.lat || !c.lng) return;
    const pos = new google.maps.LatLng(c.lat, c.lng);
    new google.maps.Marker({
      position: pos, map: compsMap,
      icon: {
        path: google.maps.SymbolPath.CIRCLE, scale: 7,
        fillColor: '#0A1628', fillOpacity: 1,
        strokeColor: '#ffffff', strokeWeight: 2,
      },
    });
    new MapLabel(pos, c.name, false).setMap(compsMap);
    bounds.extend(pos);
  });

  compsMap.fitBounds(bounds, { top: 60, bottom: 30, left: 40, right: 40 });
}

// ===== HUD LOAN TAB =====
function renderLoan() {
  const L = LOAN_DATA;
  if (!L || !L.original_amount) return;

  // --- Headline Banner ---
  const hlEl = document.getElementById('loan-headline');
  hlEl.innerHTML = `<div class="loan-headline">
    <div class="loan-headline-left">
      <div class="loan-headline-icon">HUD</div>
      <div class="loan-headline-text">
        <h3>$${(L.original_amount / 1e6).toFixed(1)}M HUD Loan @ ${L.interest_rate_pct} Fixed</h3>
        <p><strong>${L.loan_type}</strong> &mdash; Originated ${new Date(L.origination_date).toLocaleDateString('en-US',{month:'short',year:'numeric'})} &middot; Matures ${new Date(L.maturity_date).toLocaleDateString('en-US',{month:'short',year:'numeric'})} &middot; ${L.total_term_years}-year term</p>
      </div>
    </div>
    <div class="loan-headline-right">
      <div class="loan-headline-stat">
        <div class="val">$${(L.current_balance / 1e6).toFixed(1)}M</div>
        <div class="lbl">Balance (EOY 2025)</div>
      </div>
      <div class="loan-headline-stat">
        <div class="val">${L.remaining_years}yr</div>
        <div class="lbl">Remaining</div>
      </div>
      <div class="loan-headline-stat">
        <div class="val">${L.dscr_2026}x</div>
        <div class="lbl">DSCR (2026)</div>
      </div>
    </div>
  </div>`;

  // --- KPI Cards ---
  const kpisEl = document.getElementById('loan-kpis');
  const ds = L.ds_components_2026 || {};
  kpisEl.innerHTML = [
    kpiCard('Current Balance', '$' + Math.round(L.current_balance).toLocaleString(), `As of ${L.as_of_date} | ${L.pct_paid_down}% paid down`, '', true),
    kpiCard('2026 Interest Expense', '$' + Math.round(ds.interest || L.annual_interest_2025).toLocaleString(), `Monthly: ~$${Math.round((ds.interest || L.annual_interest_2025) / 12).toLocaleString()}`),
    kpiCard('2026 Principal Paydown', '$' + Math.round(ds.principal || L.annual_principal_2025).toLocaleString(), `Monthly: ~$${Math.round((ds.principal || L.annual_principal_2025) / 12).toLocaleString()}`),
    kpiCard('2026 MIP + Admin Fee', '$' + Math.round((ds.mip||0) + (ds.admin_fee||0)).toLocaleString(), `MIP: $${Math.round(ds.mip||0).toLocaleString()} | Admin: $${Math.round(ds.admin_fee||0).toLocaleString()}`, '', true),
    kpiCard('Total Debt Service (2026)', '$' + Math.round(L.budget_annual_debt_service_2026).toLocaleString(), `$${Math.round(L.budget_monthly_debt_service_2026).toLocaleString()}/mo avg | DSCR: ${L.dscr_2026}x`),
  ].join('');

  // --- Balance Trend Chart ---
  const balData = L.balance_trend || [];
  if (balData.length > 0) {
    // Sample for readability: show every year for first 10, then every 5
    const sampled = balData.filter((d, i) => {
      if (d.year <= 2031) return true;
      if (d.year % 5 === 0) return true;
      if (d.year === balData[balData.length - 1].year) return true;
      return false;
    });
    new Chart(document.getElementById('loan-balance-chart'), {
      type: 'line',
      data: {
        labels: sampled.map(d => d.year),
        datasets: [{
          label: 'Outstanding Balance',
          data: sampled.map(d => d.balance),
          borderColor: C.navy,
          backgroundColor: C.navyFill,
          fill: true, tension: 0.3, borderWidth: 2.5,
          pointRadius: sampled.map(d => d.year === 2025 ? 6 : 3),
          pointBackgroundColor: sampled.map(d => d.year === 2025 ? C.gold : C.navy),
        }],
      },
      options: {
        responsive: true,
        scales: {
          y: { ticks: { callback: v => '$' + (v / 1e6).toFixed(0) + 'M' }, beginAtZero: true },
          x: { ticks: { maxRotation: 45 } },
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => '$' + Math.round(ctx.raw).toLocaleString() } },
        },
      },
    });
  }

  // --- Interest vs Principal Split Chart ---
  const splitData = L.interest_principal_split || [];
  if (splitData.length > 0) {
    const sampled2 = splitData.filter(d => {
      if (d.year <= 2031) return true;
      if (d.year % 5 === 0) return true;
      return false;
    });
    new Chart(document.getElementById('loan-split-chart'), {
      type: 'bar',
      data: {
        labels: sampled2.map(d => d.year),
        datasets: [
          { label: 'Interest', data: sampled2.map(d => d.interest), backgroundColor: C.gold, borderRadius: 2 },
          { label: 'Principal', data: sampled2.map(d => d.principal), backgroundColor: C.navy, borderRadius: 2 },
        ],
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true, ticks: { maxRotation: 45 } },
          y: { stacked: true, ticks: { callback: v => '$' + (v / 1e3).toFixed(0) + 'K' } },
        },
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font: { size: 10 } } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': $' + Math.round(ctx.raw).toLocaleString() } },
        },
      },
    });
  }

  // --- 2026 Debt Service Donut ---
  if (ds.interest) {
    new Chart(document.getElementById('loan-ds-donut'), {
      type: 'doughnut',
      data: {
        labels: ['Interest', 'Principal', 'MIP', 'Admin Fee'],
        datasets: [{
          data: [ds.interest, ds.principal, ds.mip, ds.admin_fee],
          backgroundColor: [C.navy, C.gold, C.teal, C.orange],
          borderWidth: 2, borderColor: '#fff',
        }],
      },
      options: {
        responsive: true, cutout: '55%',
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, padding: 14, font: { size: 11 } } },
          tooltip: { callbacks: {
            label: ctx => {
              const total = ctx.dataset.data.reduce((a,b) => a+b, 0);
              const pct = ((ctx.raw / total) * 100).toFixed(1);
              return ctx.label + ': $' + Math.round(ctx.raw).toLocaleString() + ' (' + pct + '%)';
            }
          }},
        },
      },
    });
  }

  // --- 2026 Monthly DS Stacked Bar ---
  const dsM = L.ds_2026_monthly;
  if (dsM && dsM.interest) {
    const moLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    new Chart(document.getElementById('loan-ds-monthly-chart'), {
      type: 'bar',
      data: {
        labels: moLabels,
        datasets: [
          { label: 'Interest', data: dsM.interest, backgroundColor: C.navy, borderRadius: 1 },
          { label: 'Principal', data: dsM.principal, backgroundColor: C.gold, borderRadius: 1 },
          { label: 'MIP', data: dsM.mip, backgroundColor: C.teal, borderRadius: 1 },
          { label: 'Admin Fee', data: dsM.admin_fee, backgroundColor: C.orange, borderRadius: 1 },
        ],
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true },
          y: { stacked: true, ticks: { callback: v => '$' + (v / 1e3).toFixed(0) + 'K' } },
        },
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, padding: 14, font: { size: 10 } } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': $' + Math.round(ctx.raw).toLocaleString() } },
        },
      },
    });
  }

  // --- HUD Features Grid ---
  const featEl = document.getElementById('loan-features-container');
  const features = L.hud_features || [];
  if (features.length > 0) {
    const highlightLabels = ['Rate Type', 'Guarantee', 'Property Tax', 'Assumable'];
    let fh = '<div class="loan-features">';
    features.forEach(f => {
      const isHL = highlightLabels.includes(f.label);
      fh += `<div class="loan-feature-item${isHL ? ' feat-highlight' : ''}">
        <div class="feat-label">${f.label}</div>
        <div class="feat-value">${f.value}</div>
      </div>`;
    });
    fh += '</div>';
    featEl.innerHTML = fh;
  }

  // --- Amortization Table ---
  const amort = L.amort_table || [];
  const atEl = document.getElementById('loan-amort-container');
  if (amort.length > 0) {
    let t = '<table class="loan-amort-table"><thead><tr><th>Year</th><th>Interest Paid</th><th>Principal Paid</th><th>Total P&I</th><th>Ending Balance</th></tr></thead><tbody>';
    amort.forEach(row => {
      const isCurrent = row.year === 2026;
      const isRef = row.year === 2025;
      t += `<tr class="${isCurrent ? 'current-year' : isRef ? 'ref-year' : ''}">
        <td>${row.year}${isCurrent ? ' â—€ Current' : isRef ? ' (Actual)' : ''}</td>
        <td>$${Math.round(row.interest_paid).toLocaleString()}</td>
        <td>$${Math.round(row.principal_paid).toLocaleString()}</td>
        <td>$${Math.round(row.total_paid).toLocaleString()}</td>
        <td>$${Math.round(row.ending_balance).toLocaleString()}</td>
      </tr>`;
    });
    t += '</tbody></table>';
    atEl.innerHTML = t;
  }
}

// ===== ACTIONS TAB =====
// ===== CELL COMMENTS =====
const CELL_COMMENTS_KEY = 'gwk_cell_comments';
let _activeCellKey = null;
let _activeCellLabel = null;

function loadCellComments() {
  if (_cellCommentsCache !== null) return _cellCommentsCache;
  try { return JSON.parse(localStorage.getItem(CELL_COMMENTS_KEY)) || {}; }
  catch { return {}; }
}
function saveCellComments(comments) {
  _cellCommentsCache = comments;
  localStorage.setItem(CELL_COMMENTS_KEY, JSON.stringify(comments));
  serverSave('cell_comments', comments);
}
function getCellKey(td) {
  const row = td.getAttribute('data-row');
  const col = td.getAttribute('data-col');
  if (!row || col === null) return null;
  return row + '_' + col;
}

function showCellTooltip(td) {
  const key = getCellKey(td);
  if (!key) return;
  const comments = loadCellComments();
  if (!comments[key]) return;
  const tooltip = document.getElementById('cell-comment-tooltip');
  tooltip.textContent = comments[key];
  // Position tooltip: show it first to measure, then position
  tooltip.style.visibility = 'hidden';
  tooltip.classList.add('visible');
  const rect = td.getBoundingClientRect();
  let top = rect.top - tooltip.offsetHeight - 8;
  let left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2;
  // Keep in viewport
  if (top < 8) top = rect.bottom + 8;
  if (left < 8) left = 8;
  if (left + tooltip.offsetWidth > window.innerWidth - 8) left = window.innerWidth - tooltip.offsetWidth - 8;
  tooltip.style.left = left + 'px';
  tooltip.style.top = top + 'px';
  tooltip.style.visibility = '';
}
function hideCellTooltip() {
  document.getElementById('cell-comment-tooltip').classList.remove('visible');
}

function openCellCommentPopup(td) {
  const key = getCellKey(td);
  if (!key) return;
  _activeCellKey = key;
  // Build label from row key + month
  const rowKey = td.getAttribute('data-row');
  const colIdx = td.getAttribute('data-col');
  const isBudgetDetail = rowKey.startsWith('bd_');
  let rowLabel, monthLabel;
  if (isBudgetDetail) {
    rowLabel = rowKey.replace(/^bd_/, '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    const B = BUDGET_DATA;
    monthLabel = colIdx === 'ann' ? '2026 Annual' : (B.months && B.months[parseInt(colIdx)] || 'Month ' + colIdx);
  } else {
    const F = FINANCIAL_DATA;
    rowLabel = rowKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    monthLabel = colIdx === 'total' ? 'T-12 Total' : (F.months && F.months[parseInt(colIdx)] || 'Month ' + colIdx);
  }
  _activeCellLabel = rowLabel + ' â€” ' + monthLabel;

  const comments = loadCellComments();
  const existing = comments[key] || '';
  const popup = document.getElementById('cell-comment-popup');
  const textarea = document.getElementById('cell-comment-textarea');
  const deleteBtn = document.getElementById('cell-comment-delete-btn');
  const titleEl = document.getElementById('cell-comment-popup-title');
  const labelEl = document.getElementById('cell-comment-label');

  textarea.value = existing;
  titleEl.textContent = existing ? 'Edit Comment' : 'Add Comment';
  labelEl.textContent = _activeCellLabel;
  deleteBtn.style.display = existing ? 'inline-block' : 'none';

  // Position popup near cell
  const rect = td.getBoundingClientRect();
  const popupWidth = 300;
  let left = rect.left;
  let top = rect.bottom + 6;
  if (left + popupWidth > window.innerWidth - 16) left = window.innerWidth - popupWidth - 16;
  if (left < 16) left = 16;
  if (top + 200 > window.innerHeight) top = rect.top - 200;
  if (top < 16) top = 16;

  popup.style.left = left + 'px';
  popup.style.top = top + 'px';
  popup.classList.add('active');
  hideCellTooltip();
  setTimeout(() => textarea.focus(), 50);
}
function closeCellCommentPopup() {
  document.getElementById('cell-comment-popup').classList.remove('active');
  _activeCellKey = null;
}
function saveCellComment() {
  if (!_activeCellKey) return;
  const text = document.getElementById('cell-comment-textarea').value.trim();
  const comments = loadCellComments();
  if (text) { comments[_activeCellKey] = text; }
  else { delete comments[_activeCellKey]; }
  saveCellComments(comments);
  const wasBudgetDetail = _activeCellKey.startsWith('bd_');
  closeCellCommentPopup();
  if (wasBudgetDetail) renderBudgetTable(); else renderFinancialTable();
}
function deleteCellComment() {
  if (!_activeCellKey) return;
  const comments = loadCellComments();
  delete comments[_activeCellKey];
  saveCellComments(comments);
  const wasBudgetDetail = _activeCellKey.startsWith('bd_');
  closeCellCommentPopup();
  if (wasBudgetDetail) renderBudgetTable(); else renderFinancialTable();
}

// ===== AI CHAT WIDGET =====
const AI_KEY_STORAGE = 'gwk_anthropic_key';
let aiChatHistory = [];

function getApiKey() {
  if (_apiKeyCache !== null) return _apiKeyCache;
  return localStorage.getItem(AI_KEY_STORAGE) || '';
}

function saveApiKey() {
  const key = document.getElementById('ai-api-key').value.trim();
  if (!key) return;
  _apiKeyCache = key;
  localStorage.setItem(AI_KEY_STORAGE, key);
  serverSave('api_key', key);
  const st = document.getElementById('ai-key-status');
  st.textContent = 'âœ“ Key saved';
  st.style.color = 'var(--green)';
  document.getElementById('ai-api-key').value = '';
  setTimeout(() => { document.getElementById('ai-key-panel').style.display = 'none'; }, 1000);
}

function toggleApiKeyInput() {
  const panel = document.getElementById('ai-key-panel');
  const vis = panel.style.display !== 'none';
  panel.style.display = vis ? 'none' : 'block';
  if (!vis) {
    const key = getApiKey();
    const st = document.getElementById('ai-key-status');
    st.style.color = key ? 'var(--green)' : 'var(--gray)';
    st.textContent = key ? 'Key configured (sk-ant-...' + key.slice(-4) + ')' : 'No key configured yet';
  }
}

function buildFinancialSystemPrompt() {
  const F = FINANCIAL_DATA;
  const P = F.prior || {};
  const yoy = F.yoy_comparison || {};
  const hasPrior = !!P.period;

  let p = `You are a financial analyst assistant for Greenwood at Katy Apartment Homes.

PROPERTY INFO:
- 324 units, 310,836 SF, Katy TX (west of Houston, near I-10 & Grand Parkway)
- Built 2022, Three-Story Garden-Style
- 50% units allocated to 80% AMI; existing tenants qualify up to 140% AMI
- 100% property tax exempt under HCHA (very favorable)
- HUD Loan: $49.3M at 3.18% fixed, matures Sep 2062
- Managed by Greystar, owned by Pondmoon Real Estate Partners & Allen Harrison Company
- Acquired by Pondmoon: November 2025

CURRENT T-12: ${F.period || 'Oct 2024-Sep 2025'}
Months: ${(F.months||[]).join(', ')}
`;

  // Current annual totals
  p += '\nCURRENT YEAR ANNUAL TOTALS:\n';
  const ct = F.annual_totals || {};
  for (const [k,v] of Object.entries(ct)) {
    p += `  ${k}: ${typeof v === 'number' ? '$'+Math.round(v).toLocaleString() : v}\n`;
  }

  if (hasPrior) {
    p += `\nPRIOR T-12: ${P.period || 'Oct 2023-Sep 2024'}\nMonths: ${(P.months||[]).join(', ')}\n`;
    p += '\nPRIOR YEAR ANNUAL TOTALS:\n';
    const pt = P.annual_totals || {};
    for (const [k,v] of Object.entries(pt)) {
      p += `  ${k}: ${typeof v === 'number' ? '$'+Math.round(v).toLocaleString() : v}\n`;
    }
  }

  // Monthly data for important keys
  const importantKeys = [
    'total_income','total_rental_income','total_other_income','total_opex','noi',
    'market_rent','vacancy_loss','total_concessions','bad_debt_rent',
    'payroll_benefits','repairs_maintenance','make_ready','contract_services',
    'marketing','utilities','management_fees','insurance','taxes',
    'one_time_concessions','renewal_concessions'
  ];
  const m = F.metrics || {};
  p += '\nCURRENT YEAR MONTHLY DATA:\n';
  for (const k of importantKeys) {
    if (m[k]) {
      const label = m[k+'_label'] || k;
      p += `  ${label} (${k}): [${m[k].map(v=>Math.round(v)).join(', ')}]\n`;
    }
  }
  if (hasPrior) {
    const pm = P.metrics || {};
    p += '\nPRIOR YEAR MONTHLY DATA:\n';
    for (const k of importantKeys) {
      if (pm[k]) {
        const label = pm[k+'_label'] || k;
        p += `  ${label} (${k}): [${pm[k].map(v=>Math.round(v)).join(', ')}]\n`;
      }
    }
  }

  // YoY summary
  if (yoy && yoy.summary) {
    p += '\nYEAR-OVER-YEAR SUMMARY:\n';
    const s = yoy.summary;
    p += `  Total Income change: $${s.total_income_change_abs?.toLocaleString()} (${s.total_income_change_pct}%)\n`;
    p += `  Total OpEx change: $${s.total_opex_change_abs?.toLocaleString()} (${s.total_opex_change_pct}%)\n`;
    p += `  NOI change: $${s.noi_change_abs?.toLocaleString()} (${s.noi_change_pct}%)\n`;
    if (s.biggest_opex_increase) p += `  Biggest OpEx increase: ${s.biggest_opex_increase.label} (${s.biggest_opex_increase.change_pct}%)\n`;
    if (s.biggest_opex_decrease) p += `  Biggest OpEx decrease: ${s.biggest_opex_decrease.label} (${s.biggest_opex_decrease.change_pct}%)\n`;

    p += '\nYoY LINE ITEM DETAILS:\n';
    for (const [k,li] of Object.entries(yoy.line_items || {})) {
      p += `  ${li.label}: curr=$${li.current_annual?.toLocaleString()} prior=$${li.prior_annual?.toLocaleString()} chg=$${li.change_abs?.toLocaleString()} (${li.change_pct}%)\n`;
    }
  }

  // === Companion properties ===
  if (typeof COMPANION_DATA !== 'undefined' && COMPANION_DATA && Object.keys(COMPANION_DATA).length > 0) {
    p += '\n\n=== COMPANION PROPERTIES (Cross-Property Comparison) ===\n';
    for (const [key, prop] of Object.entries(COMPANION_DATA)) {
      p += `\nPROPERTY: ${prop.name} (${prop.short_name})\n`;
      p += `  ${prop.total_units} units, ${(prop.total_sf||0).toLocaleString()} SF\n`;

      if (prop.current) {
        p += `  Current T-12: ${prop.current.period}\n`;
        p += `  Months: ${(prop.current.months||[]).join(', ')}\n`;
        p += '  Current Annual Totals:\n';
        for (const [k,v] of Object.entries(prop.current.annual_totals || {})) {
          p += `    ${k}: ${typeof v==='number'?'$'+Math.round(v).toLocaleString():v}\n`;
        }
        const cm = prop.current.metrics || {};
        p += '  Current Monthly Data:\n';
        for (const k of importantKeys) {
          if (cm[k]) p += `    ${k}: [${cm[k].map(v=>Math.round(v)).join(', ')}]\n`;
        }
      }
      if (prop.prior) {
        p += `  Prior T-12: ${prop.prior.period}\n`;
        p += '  Prior Annual Totals:\n';
        for (const [k,v] of Object.entries(prop.prior.annual_totals || {})) {
          p += `    ${k}: ${typeof v==='number'?'$'+Math.round(v).toLocaleString():v}\n`;
        }
        const pm2 = prop.prior.metrics || {};
        p += '  Prior Monthly Data:\n';
        for (const k of importantKeys) {
          if (pm2[k]) p += `    ${k}: [${pm2[k].map(v=>Math.round(v)).join(', ')}]\n`;
        }
      }
    }
  }

  p += `
INSTRUCTIONS:
- Answer in the same language the user uses. If they mix Chinese and English, respond in the same mix.
- Always cite specific dollar amounts and percentages.
- When comparing YoY, state both the absolute dollar change and percentage change.
- Be concise: 2-4 sentences for simple questions, up to a short paragraph for complex analysis.
- Format numbers with $ signs and commas (e.g., $1,234,567).
- Greenwood month indices in arrays: 0=Oct, 1=Nov, 2=Dec, 3=Jan, 4=Feb, 5=Mar, 6=Apr, 7=May, 8=Jun, 9=Jul, 10=Aug, 11=Sep.
- When the user asks about a specific month like "September" or "9æœˆ" for Greenwood, map it to index 11. "September insurance" means insurance[11].
- Companion properties (Trails etc.) use calendar year: month indices 0=Jan, 1=Feb, ..., 8=Sep, ..., 11=Dec.
  For "same month" cross-property comparisons (e.g., "9æœˆ"), use Greenwood index 11 and Trails index 8.
- "åŒæœŸ" means "same period last year" â€” compare the same month index between current and prior arrays.
- When comparing across properties, always normalize per-unit or per-SF for fair comparison.
  Greenwood = 324 units, 310,836 SF; always state which property when citing numbers.
- "è·¨ç‰©ä¸šå¯¹æ¯”" or "compare properties" = compare Greenwood and companion property(ies).
- Use **bold** for key numbers and labels.
`;

  return p;
}

async function callClaudeAPI(userMessage) {
  const apiKey = getApiKey();
  if (!apiKey) throw new Error('NO_KEY');

  const systemPrompt = buildFinancialSystemPrompt();
  const recentHistory = aiChatHistory.slice(-20);
  const messages = recentHistory.map(msg => ({ role: msg.role, content: msg.content }));
  messages.push({ role: 'user', content: userMessage });

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
    },
    body: JSON.stringify({
      model: 'claude-3-5-haiku-20241022',
      max_tokens: 1024,
      system: systemPrompt,
      messages: messages,
    }),
  });

  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    if (response.status === 401) throw new Error('INVALID_KEY');
    throw new Error(err.error?.message || `API Error ${response.status}`);
  }

  const data = await response.json();
  return data.content[0].text;
}

function renderAiMessage(role, content) {
  const container = document.getElementById('ai-chat-messages');
  const div = document.createElement('div');
  div.className = `ai-msg ai-msg-${role}`;
  const avatar = document.createElement('div');
  avatar.className = 'ai-msg-avatar';
  avatar.textContent = role === 'user' ? 'You' : 'AI';
  const bubble = document.createElement('div');
  bubble.className = 'ai-msg-bubble';
  bubble.innerHTML = content
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
  div.appendChild(avatar);
  div.appendChild(bubble);
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

function showAiTyping() {
  const container = document.getElementById('ai-chat-messages');
  const div = document.createElement('div');
  div.className = 'ai-msg ai-msg-assistant ai-msg-loading';
  div.id = 'ai-typing-indicator';
  div.innerHTML = '<div class="ai-msg-avatar">AI</div><div class="ai-msg-bubble"><div class="ai-typing-dots"><span></span><span></span><span></span></div></div>';
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function removeAiTyping() {
  const el = document.getElementById('ai-typing-indicator');
  if (el) el.remove();
}

async function sendChatMessage() {
  const input = document.getElementById('ai-chat-input');
  const sendBtn = document.getElementById('ai-send-btn');
  const userText = input.value.trim();
  if (!userText) return;

  if (!getApiKey()) {
    toggleApiKeyInput();
    const st = document.getElementById('ai-key-status');
    st.textContent = 'Please enter your Anthropic API key first';
    st.style.color = 'var(--red)';
    return;
  }

  renderAiMessage('user', userText);
  aiChatHistory.push({ role: 'user', content: userText });
  input.value = '';
  sendBtn.disabled = true;

  // Hide suggestions after first message
  const sugg = document.getElementById('ai-suggestions');
  if (sugg) sugg.style.display = 'none';

  showAiTyping();

  try {
    const reply = await callClaudeAPI(userText);
    removeAiTyping();
    renderAiMessage('assistant', reply);
    aiChatHistory.push({ role: 'assistant', content: reply });
  } catch (err) {
    removeAiTyping();
    let errMsg = 'An error occurred. Please try again.';
    if (err.message === 'NO_KEY') errMsg = 'Please set your Anthropic API key first (click âš™).';
    else if (err.message === 'INVALID_KEY') errMsg = 'Invalid API key. Please check and re-enter (click âš™).';
    else errMsg = 'Error: ' + err.message;
    renderAiMessage('assistant', '<span class="ai-error">' + errMsg + '</span>');
  } finally {
    sendBtn.disabled = false;
    input.focus();
  }
}

function askSuggested(btn) {
  document.getElementById('ai-chat-input').value = btn.textContent;
  sendChatMessage();
}

// ===== ACTIONS =====
const ACTIONS_STORAGE_KEY = 'gwk_actions_state';

function loadActionsState() {
  if (_actionsStateCache !== null) return _actionsStateCache;
  try { return JSON.parse(localStorage.getItem(ACTIONS_STORAGE_KEY)) || {}; }
  catch { return {}; }
}
function saveActionsState(state) {
  _actionsStateCache = state;
  localStorage.setItem(ACTIONS_STORAGE_KEY, JSON.stringify(state));
  serverSave('actions_state', state);
}

// Merge data actions + user-added actions, excluding hidden ones
function getAllActions() {
  const state = loadActionsState();
  const hidden = state.hidden || {};
  const base = (ACTIONS_DATA.actions || []).map((a, i) => {
    const id = 'data_' + i;
    return { ...a, _id: id, _done: !!(state.done && state.done[id]) };
  }).filter(a => !hidden[a._id]);
  const custom = (state.custom || []).map(a => {
    return { ...a, _done: !!(state.done && state.done[a._id]) };
  });
  return [...base, ...custom];
}

// ===== 2026 BUDGET =====
function renderBudget() {
  const B = BUDGET_DATA;
  if (!B || !B.metrics) return;
  const months = B.months || [];
  const m = B.metrics;
  const t = B.annual_totals || {};

  // Update subtitle with source
  const subEl = document.getElementById('budget-subtitle');
  if (subEl && B.source_file) {
    subEl.innerHTML = `Annual Operating Budget &mdash; Greenwood at Katy &middot; Source: ${B.source_file}`;
  }

  // --- KPIs ---
  const noiMargin = t.total_income ? ((t.noi / t.total_income) * 100).toFixed(1) : 0;
  const noiPerUnit = Math.round(t.noi / 324);
  const opexRatio = t.total_income ? ((t.total_opex / t.total_income) * 100).toFixed(1) : 0;
  const dscr = t.debt_service ? (t.noi / t.debt_service).toFixed(2) : 'N/A';
  const niPerUnit = Math.round(t.net_income / 324);

  document.getElementById('budget-kpis').innerHTML = [
    kpiCard('Budget Revenue', fmt(t.total_income,'dollar'), `${fmt(Math.round(t.total_income/12),'dollar')}/mo avg`, '', true),
    kpiCard('Budget OpEx', fmt(t.total_opex,'dollar'), `${opexRatio}% of revenue | ${fmt(Math.round(t.total_opex/12),'dollar')}/mo`),
    kpiCard('Budget NOI', fmt(t.noi,'dollar'), `${noiMargin}% margin | $${noiPerUnit.toLocaleString()}/unit`, '', true),
    kpiCard('Debt Service', fmt(t.debt_service,'dollar'), `DSCR: ${dscr}x`),
    kpiCard('Net Income', fmt(t.net_income,'dollar'), `$${niPerUnit.toLocaleString()}/unit`),
  ].join('');

  // --- Chart 1: Budgeted Monthly Income ---
  if (m.total_income) {
    new Chart(document.getElementById('budget-income-chart'), {
      type: 'bar', data: { labels: months, datasets: [
        { label: 'Total Income', data: m.total_income, backgroundColor: C.navy, borderRadius: 4 },
        { label: 'Rental Income', data: m.total_rental_income, backgroundColor: C.gold, borderRadius: 4 },
        { label: 'Other Income', data: m.other_income_residential, backgroundColor: C.teal, borderRadius: 4 },
      ]}, options: { responsive: true, scales: { y: { ticks: { callback: v=>'$'+(v/1000).toFixed(0)+'K' } } }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font:{size:10} } } } },
    });
  }

  // --- Chart 2: Budgeted OpEx Breakdown ---
  if (m.payroll_benefits) {
    new Chart(document.getElementById('budget-opex-chart'), {
      type: 'bar', data: { labels: months, datasets: [
        { label: 'Payroll', data: m.payroll_benefits, backgroundColor: C.navy },
        { label: 'Contract Svc', data: m.contract_services, backgroundColor: C.orange },
        { label: 'Utilities', data: m.utilities, backgroundColor: C.teal },
        { label: 'Marketing', data: m.marketing, backgroundColor: C.gold },
        { label: 'Insurance', data: m.insurance, backgroundColor: C.purple },
        { label: 'Mgmt Fees', data: m.management_fees, backgroundColor: C.blue },
        { label: 'Other', data: months.map((_,i)=>Math.max(0,(m.total_opex?.[i]||0)-(m.payroll_benefits?.[i]||0)-(m.contract_services?.[i]||0)-(m.utilities?.[i]||0)-(m.marketing?.[i]||0)-(m.insurance?.[i]||0)-(m.management_fees?.[i]||0))), backgroundColor: C.gray },
      ]}, options: { responsive: true, scales: { x:{stacked:true}, y:{stacked:true, ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'K'}} }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font:{size:9} } } } },
    });
  }

  // --- Chart 3: Budgeted NOI vs Debt Service ---
  if (m.noi) {
    new Chart(document.getElementById('budget-noi-chart'), {
      type: 'bar', data: { labels: months, datasets: [
        { type: 'line', label: 'NOI', data: m.noi, borderColor: C.green, backgroundColor: C.greenFill, fill: true, tension: 0.3, borderWidth: 2.5, pointRadius: 4, pointBackgroundColor: C.green, order: 1 },
        { type: 'line', label: 'Debt Service', data: m.debt_service, borderColor: C.red, borderDash:[8,4], borderWidth: 2, pointRadius: 3, fill: false, order: 2 },
        { type: 'bar', label: 'Net Income', data: m.net_income, backgroundColor: 'rgba(45,159,111,0.25)', borderRadius: 3, order: 3 },
      ]}, options: { responsive: true, scales: { y: { ticks: { callback: v=>'$'+(v/1000).toFixed(0)+'K' } } }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font:{size:10} } } } },
    });
  }

  // --- Chart 4: Budgeted Occupancy Targets ---
  if (m.targeted_occupancy) {
    new Chart(document.getElementById('budget-occ-chart'), {
      type: 'line', data: { labels: months, datasets: [
        { label: 'Targeted Occupancy', data: m.targeted_occupancy.map(v=>v*100), borderColor: C.navy, backgroundColor: C.navyFill, fill: false, tension: 0.3, borderWidth: 2.5, pointRadius: 4, pointBackgroundColor: C.navy },
        { label: 'Financial Occupancy', data: m.financial_occupancy.map(v=>v*100), borderColor: C.gold, fill: false, tension: 0.3, borderWidth: 2, pointRadius: 3, pointBackgroundColor: C.gold },
        { label: 'Economic Occupancy', data: m.economic_occupancy.map(v=>v*100), borderColor: C.teal, fill: false, tension: 0.3, borderWidth: 2, pointRadius: 3, pointBackgroundColor: C.teal },
      ]}, options: { responsive: true, scales: { y: { min: 80, max: 100, ticks: { callback: v=>v+'%' } } }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font:{size:10} } } } },
    });
  }

  // --- Budget Detail Table ---
  renderBudgetTable();
}

function renderBudgetTable() {
  const B = BUDGET_DATA;
  if (!B || !B.metrics) return;
  const months = B.months || [];
  const m = B.metrics;

  const pctKeys = new Set(['targeted_occupancy','financial_occupancy','economic_occupancy']);
  const intKeys = new Set(['move_ins','move_outs','projected_expirations','renewals']);

  const rows = [
    { key: '_hdr_occ', label: 'Occupancy', isHeader: true },
    { key: 'targeted_occupancy', label: 'Targeted Occupancy' },
    { key: 'financial_occupancy', label: 'Financial Occupancy' },
    { key: 'economic_occupancy', label: 'Economic Occupancy' },
    { key: '_hdr_leasing', label: 'Leasing Activity', isHeader: true },
    { key: 'move_ins', label: 'Move Ins' },
    { key: 'move_outs', label: 'Move Outs' },
    { key: 'projected_expirations', label: 'Projected Expirations' },
    { key: 'renewals', label: 'Renewals' },
    { key: '_hdr_rent', label: 'Rent Metrics', isHeader: true },
    { key: 'avg_market_rent_per_unit', label: 'Avg Market Rent / Unit' },
    { key: 'net_potential_rent_per_unit', label: 'Net Potential Rent / Unit' },
    { key: '_hdr_income', label: 'Income', isHeader: true },
    { key: 'potential_rent', label: 'Potential Rent' },
    { key: 'net_potential_rent', label: 'Net Potential Rent' },
    { key: 'vacancy_loss', label: 'Vacancy Loss' },
    { key: 'non_revenue_units', label: 'Non-Revenue Units' },
    { key: 'bad_debt', label: 'Bad Debt' },
    { key: 'total_rental_income', label: 'TOTAL RENTAL INCOME', isTotal: true },
    { key: 'other_income_residential', label: 'Other Income - Residential' },
    { key: 'total_income', label: 'TOTAL INCOME', isTotal: true },
    { key: '_hdr_ctrl', label: 'Controllable Expenses', isHeader: true },
    { key: 'payroll_benefits', label: 'Payroll & Benefits' },
    { key: 'repairs_maintenance', label: 'Repairs & Maintenance' },
    { key: 'make_ready', label: 'Make-Ready / Redecorating' },
    { key: 'recreational_amenities', label: 'Recreational Amenities' },
    { key: 'contract_services', label: 'Contract Services' },
    { key: 'marketing', label: 'Advertising / Marketing' },
    { key: 'office_expenses', label: 'Office Expenses' },
    { key: 'other_admin', label: 'Other G&A' },
    { key: 'utilities', label: 'Utilities' },
    { key: 'controllable_expenses', label: 'CONTROLLABLE EXPENSES', isTotal: true },
    { key: '_hdr_nonctrl', label: 'Non-Controllable Expenses', isHeader: true },
    { key: 'management_fees', label: 'Management Fees' },
    { key: 'taxes', label: 'Taxes' },
    { key: 'insurance', label: 'Insurance' },
    { key: 'non_controllable_expenses', label: 'NON-CONTROLLABLE EXPENSES', isTotal: true },
    { key: 'total_opex', label: 'TOTAL OPERATING EXPENSES', isTotal: true },
    { key: '_hdr_noi', label: 'NOI & Below the Line', isHeader: true },
    { key: 'noi', label: 'NET OPERATING INCOME', isTotal: true },
    { key: 'routine_replacement', label: 'Routine Replacement' },
    { key: 'capital_renovation', label: 'Capital / Renovation' },
    { key: 'noi_after_replacements', label: 'NOI AFTER REPLACEMENTS', isTotal: true },
    { key: 'partnership_owner_expenses', label: 'Partnership / Owner Expenses' },
    { key: 'closing_costs', label: 'Closing Costs' },
    { key: 'debt_service', label: 'Debt Service' },
    { key: 'total_non_operating', label: 'TOTAL NON-OPERATING', isTotal: true },
    { key: 'net_income', label: 'NET INCOME', isTotal: true },
  ];

  const cellComments = loadCellComments();

  let t = '<table class="budget-table"><thead><tr><th style="text-align:left;min-width:200px">Line Item</th>';
  months.forEach(mo => { t += `<th>${mo}</th>`; });
  t += '<th style="font-weight:700">Annual</th></tr></thead><tbody>';

  for (const row of rows) {
    if (row.isHeader) {
      t += `<tr class="section-header"><td colspan="${months.length+2}" style="text-align:left;font-weight:700;padding-top:16px">${row.label}</td></tr>`;
      continue;
    }
    const vals = m[row.key];
    if (!vals) continue;

    const cls = row.isTotal ? ' class="total-row"' : '';
    t += `<tr${cls}><td style="text-align:left;padding-left:${row.isTotal?'8':'20'}px">${row.label}</td>`;

    let annual = 0;
    vals.forEach((v, mi) => {
      const val = v ?? 0;
      annual += val;
      let formatted;
      if (pctKeys.has(row.key)) {
        formatted = (val * 100).toFixed(1) + '%';
      } else if (intKeys.has(row.key)) {
        formatted = Math.round(val).toString();
      } else if (row.key === 'avg_market_rent_per_unit' || row.key === 'net_potential_rent_per_unit') {
        formatted = '$' + Math.round(val).toLocaleString();
      } else {
        formatted = '$' + Math.round(val).toLocaleString();
      }
      const cKey = 'bd_' + row.key + '_' + mi;
      const hasC = cellComments[cKey] ? ' has-comment' : '';
      const neg = val < 0 ? ' negative' : '';
      t += `<td data-row="bd_${row.key}" data-col="${mi}" class="${(neg+hasC).trim()}">${formatted}</td>`;
    });

    // Annual column
    let annFormatted;
    if (pctKeys.has(row.key)) {
      annFormatted = (annual / 12 * 100).toFixed(1) + '%';
    } else if (intKeys.has(row.key)) {
      annFormatted = Math.round(annual).toString();
    } else if (row.key === 'avg_market_rent_per_unit' || row.key === 'net_potential_rent_per_unit') {
      annFormatted = '$' + Math.round(annual / 12).toLocaleString() + ' avg';
    } else {
      annFormatted = '$' + Math.round(annual).toLocaleString();
    }
    const annKey = 'bd_' + row.key + '_ann';
    const hasAnnC = cellComments[annKey] ? ' has-comment' : '';
    const annNeg = annual < 0 ? ' negative' : '';
    t += `<td data-row="bd_${row.key}" data-col="ann" style="font-weight:700" class="${(annNeg+hasAnnC).trim()}">${annFormatted}</td></tr>`;
  }

  t += '</tbody></table>';
  document.getElementById('budget-detail-container').innerHTML = t;
}

// ===== MANAGEMENT ACTIONS =====
let currentFilter = 'all';
let currentStrategyFilter = null;
let actionsSortField = 'date'; // 'date', 'source', 'responsible', 'status'
let actionsSortDir = 'desc';   // 'asc' or 'desc'

function toggleActionsSort(field) {
  if (actionsSortField === field) {
    actionsSortDir = actionsSortDir === 'asc' ? 'desc' : 'asc';
  } else {
    actionsSortField = field;
    actionsSortDir = field === 'date' ? 'desc' : 'asc'; // date default newest-first, others A-Z
  }
  renderActions(true); // skipStrategyRender to avoid re-rendering strategy cards
}

function renderActions(skipStrategyRender) {
  // Top Goal banner
  if (!skipStrategyRender) {
    const goalEl = document.getElementById('top-goal-container');
    const topGoal = ACTIONS_DATA.top_goal;
    if (topGoal) {
      // Calculate current progress from leasing data
      const weeks = LEASING_DATA.weeks || [];
      const latestWeek = weeks.length > 0 ? weeks[weeks.length - 1] : null;
      const currentOcc = latestWeek ? latestWeek.occupancy_pct : null;
      const targetOcc = topGoal.target_value;
      const gap = currentOcc !== null && targetOcc ? (targetOcc - currentOcc).toFixed(1) : null;

      goalEl.innerHTML = `<div class="top-goal">
        <div class="top-goal-icon">ðŸŽ¯</div>
        <div class="top-goal-content">
          <div class="top-goal-label">Top Priority</div>
          <div class="top-goal-text">${topGoal.goal}</div>
          <div class="top-goal-meta">
            <div class="top-goal-meta-item"><strong>Set:</strong> ${topGoal.date_set}</div>
            ${topGoal.deadline ? `<div class="top-goal-meta-item"><strong>Deadline:</strong> ${topGoal.deadline}</div>` : ''}
            ${topGoal.source ? `<div class="top-goal-meta-item"><strong>Source:</strong> ${topGoal.source}</div>` : ''}
          </div>
        </div>
        ${currentOcc !== null ? `<div class="top-goal-progress">
          <div class="top-goal-pct">${currentOcc.toFixed(1)}%</div>
          <div class="top-goal-pct-label">Current</div>
          ${gap !== null && gap > 0 ? `<div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px">${gap}pp to go</div>` : gap !== null && gap <= 0 ? `<div style="font-size:11px;color:var(--gold);margin-top:4px;font-weight:600">âœ“ Goal Met</div>` : ''}
        </div>` : ''}
      </div>`;
    }
  }

  // Strategy summary cards (only re-render if not called from strategy click)
  if (!skipStrategyRender) {
    const strategySummary = ACTIONS_DATA.strategy_summary || [];
    const ssEl = document.getElementById('strategy-summary-container');
    if (strategySummary.length > 0) {
      let sh = '<div class="strategy-grid">';
      strategySummary.forEach(s => {
        const isEmpty = s.count === 0;
        const isActive = currentStrategyFilter === s.category;
        sh += `<div class="strategy-card cat-${s.category}${isActive ? ' strategy-active' : ''}" onclick="filterByStrategy('${s.category}')" title="Click to filter actions by ${s.category}">
          <div class="strategy-card-header">
            <div class="strategy-icon">${s.icon}</div>
            <div>
              <div class="strategy-card-title">${s.category}</div>
              <div class="strategy-card-count">${s.count} action item${s.count !== 1 ? 's' : ''}</div>
            </div>
          </div>
          <div class="${isEmpty ? 'strategy-card-empty' : 'strategy-card-summary'}">${s.summary}</div>
        </div>`;
      });
      sh += '</div>';
      ssEl.innerHTML = sh;
    }
  }

  // Filters + table
  const allActions = getAllActions();
  const filtersEl = document.getElementById('actions-filters');
  const sources = [...new Set(allActions.map(a => a.source))];

  filtersEl.innerHTML = '<span style="font-size:12px;color:var(--gray);line-height:34px;margin-right:4px;font-weight:600">Source:</span>' +
    '<button class="filter-btn active" onclick="filterActions(\'all\',this)">All</button>' +
    sources.map(s => `<button class="filter-btn" onclick="filterActions('${s}',this)">${s}</button>`).join('');

  // Apply both source filter and strategy filter
  let filtered = currentFilter === 'all' ? allActions : allActions.filter(a => a.source === currentFilter);
  if (currentStrategyFilter) {
    filtered = filtered.filter(a => a.strategy_category === currentStrategyFilter);
  }
  renderActionsTable(filtered, !!currentStrategyFilter);
}

// Strategy card click â†’ filter + scroll with animation
window.filterByStrategy = function(category) {
  if (currentStrategyFilter === category) {
    // Toggle off â€” clear filter
    currentStrategyFilter = null;
  } else {
    currentStrategyFilter = category;
  }

  // Update active card visuals
  document.querySelectorAll('.strategy-card').forEach(card => {
    card.classList.remove('strategy-active');
  });
  if (currentStrategyFilter) {
    const activeCard = document.querySelector(`.strategy-card.cat-${currentStrategyFilter}`);
    if (activeCard) activeCard.classList.add('strategy-active');
  }

  // Re-render table (skip re-rendering strategy cards since we just updated them)
  renderActions(true);

  // Smooth scroll to the actions table
  if (currentStrategyFilter) {
    const tableContainer = document.getElementById('actions-table-container');
    if (tableContainer) {
      setTimeout(() => {
        tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 50);
    }
  }
};

window.filterActions = function(filter, btn) {
  currentFilter = filter;
  currentStrategyFilter = null; // Clear strategy filter when switching source
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.strategy-card').forEach(card => card.classList.remove('strategy-active'));
  const allActions = getAllActions();
  const filtered = filter === 'all' ? allActions : allActions.filter(a => a.source === filter);
  renderActionsTable(filtered);
};

function toggleActionDone(id) {
  const state = loadActionsState();
  if (!state.done) state.done = {};
  state.done[id] = !state.done[id];
  saveActionsState(state);
  renderActions();
}

function deleteAction(id) {
  const state = loadActionsState();
  if (id.startsWith('user_') || id.startsWith('ai_')) {
    // Remove custom/AI-extracted action entirely
    if (state.custom) state.custom = state.custom.filter(a => a._id !== id);
  } else {
    // Hide data-sourced action
    if (!state.hidden) state.hidden = {};
    state.hidden[id] = true;
  }
  if (state.done) delete state.done[id];
  saveActionsState(state);
  renderActions();
}

function addAction() {
  const textEl = document.getElementById('new-action-text');
  const respEl = document.getElementById('new-action-resp');
  const text = textEl.value.trim();
  if (!text) { textEl.focus(); return; }
  const resp = respEl.value.trim();

  const state = loadActionsState();
  if (!state.custom) state.custom = [];
  const today = new Date();
  const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  const id = 'user_' + Date.now();
  state.custom.push({
    _id: id,
    date: dateStr,
    source: 'Manual',
    action: text,
    responsible: resp || '-',
    status: 'pending',
  });
  saveActionsState(state);
  textEl.value = '';
  respEl.value = '';
  renderActions();
}

// ===== AI DOCUMENT PARSER =====
let uploadedFiles = [];
let extractedActions = [];

function toggleUploadPanel() {
  const body = document.getElementById('file-upload-body');
  const toggle = document.getElementById('file-upload-toggle');
  const visible = body.style.display !== 'none';
  body.style.display = visible ? 'none' : 'block';
  toggle.classList.toggle('open', !visible);
}

function initDropZone() {
  const zone = document.getElementById('file-drop-zone');
  if (!zone) return;
  ['dragenter','dragover'].forEach(evt => {
    zone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); zone.classList.add('drag-over'); });
  });
  ['dragleave','drop'].forEach(evt => {
    zone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); zone.classList.remove('drag-over'); });
  });
  zone.addEventListener('drop', e => { addFilesToQueue([...e.dataTransfer.files]); });
  zone.addEventListener('click', e => {
    if (e.target.closest('.file-browse-link') || e.target.tagName === 'LABEL') return;
    document.getElementById('file-input-picker').click();
  });
}

function handleFileSelect(event) {
  addFilesToQueue([...event.target.files]);
  event.target.value = '';
}

function addFilesToQueue(files) {
  const allowed = ['.docx','.pdf','.txt','.eml'];
  for (const file of files) {
    const ext = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowed.includes(ext)) { alert('Unsupported file type: ' + file.name + '\nAccepted: .docx, .pdf, .txt, .eml'); continue; }
    if (uploadedFiles.find(f => f.file.name === file.name && f.file.size === file.size)) continue;
    uploadedFiles.push({ file, text: null });
  }
  renderFileQueue();
}

function renderFileQueue() {
  const container = document.getElementById('file-list');
  const actionsDiv = document.getElementById('file-actions');
  if (uploadedFiles.length === 0) { container.style.display = 'none'; actionsDiv.style.display = 'none'; return; }
  container.style.display = 'block';
  actionsDiv.style.display = 'flex';
  container.innerHTML = uploadedFiles.map((f, i) => {
    const sizeKB = (f.file.size / 1024).toFixed(1);
    return `<div class="file-list-item"><div><span class="file-name">${f.file.name}</span><span class="file-size">(${sizeKB} KB)</span></div><button class="file-remove" onclick="removeUploadFile(${i})" title="Remove">&#10005;</button></div>`;
  }).join('');
}

function removeUploadFile(index) { uploadedFiles.splice(index, 1); renderFileQueue(); }

function clearUploadedFiles() {
  uploadedFiles = []; extractedActions = [];
  renderFileQueue();
  document.getElementById('file-preview').style.display = 'none';
  document.getElementById('file-status').style.display = 'none';
}

async function readFileContent(fileObj) {
  const file = fileObj.file;
  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'txt' || ext === 'eml') {
    const text = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(new Error('Failed to read ' + file.name));
      reader.readAsText(file);
    });
    // For .eml files, extract Date/From/Subject headers and prepend as metadata
    if (ext === 'eml') {
      const meta = [];
      const dateMatch = text.match(/^Date:\s*(.+)$/mi);
      const fromMatch = text.match(/^From:\s*(.+)$/mi);
      const subjMatch = text.match(/^Subject:\s*(.+)$/mi);
      const toMatch = text.match(/^To:\s*(.+)$/mi);
      if (dateMatch) {
        meta.push('[EMAIL DATE]: ' + dateMatch[1].trim());
        // Also try to parse into YYYY-MM-DD for the AI
        try {
          const d = new Date(dateMatch[1].trim());
          if (!isNaN(d.getTime())) meta.push('[EMAIL DATE ISO]: ' + d.toISOString().slice(0, 10));
        } catch(e) {}
      }
      if (fromMatch) meta.push('[EMAIL FROM]: ' + fromMatch[1].trim());
      if (toMatch) meta.push('[EMAIL TO]: ' + toMatch[1].trim());
      if (subjMatch) meta.push('[EMAIL SUBJECT]: ' + subjMatch[1].trim());
      if (meta.length > 0) return meta.join('\n') + '\n\n' + text;
    }
    return text;
  }
  if (ext === 'docx') {
    if (typeof mammoth === 'undefined') throw new Error('mammoth.js library not loaded. Check internet connection.');
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    return result.value;
  }
  if (ext === 'pdf') {
    if (typeof pdfjsLib === 'undefined') throw new Error('pdf.js library not loaded. Check internet connection.');
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      fullText += content.items.map(item => item.str).join(' ') + '\n\n';
    }
    return fullText;
  }
  throw new Error('Unsupported file type: ' + ext);
}

function buildActionExtractionPrompt() {
  return `You are an action item extraction assistant for Greenwood at Katy Apartment Homes, a 324-unit multifamily property in Katy, TX managed by Greystar.

CONTEXT:
- Investors: Pondmoon (Steven Li, Nicole) and Allen Harrison Company (AHC, contact: Meredith)
- Property Manager: Greystar (Community Manager: Danteil Kirkland)
- Property has 50% affordable units, HUD loan at 3.18%, 100% property tax exempt
- Documents may be in Chinese, English, or bilingual

YOUR TASK:
Extract ONLY items that require someone to TAKE ACTION â€” plans, goals, tasks, decisions that need follow-up, or strategic recommendations that need implementation.

STRICT FILTERING â€” DO NOT extract:
- Pure notifications or FYI messages (e.g. "here is the report", "see attached", "please review")
- Status updates that don't require action (e.g. "occupancy is 92%", "we received 5 applications")
- Greetings, sign-offs, or pleasantries
- Forwarded content headers or email signatures
- General observations with no actionable next step
- Information that merely describes a current state without proposing any change

ONLY extract items where someone needs to DO something: approve, implement, schedule, follow up, decide, change, hire, spend, negotiate, submit, complete, etc.

For each item, determine:
1. "date" - The date when this item was COMMUNICATED or RECORDED (YYYY-MM-DD), NOT any future target/deadline date. For emails: ALWAYS use the [EMAIL DATE ISO] field (the day the email was sent). For meeting minutes: use the meeting date. If no document date can be determined, use today.
2. "source" - Document type: "Meeting Minutes", "Email", "Action Plan", or "Uploaded Document". For .eml files with [EMAIL FROM]/[EMAIL SUBJECT] headers, always use "Email".
3. "source_detail" - Brief descriptor like "From Meredith (AHC)" or "Weekly Call (Feb 13)". For emails, use the sender and subject.
4. "action" - The action item text. Keep the ORIGINAL language (Chinese or English). Max 200 chars.
5. "responsible" - One of: "Steven (Pondmoon)", "Meredith (AHC)", "Danteil (Greystar)", "Nicole (Pondmoon)", "All Parties", or "Unknown"
6. "status" - One of: "pending", "in_progress", "recommended", "noted", "monitoring", "communicated"
7. "category" - One of: "decision", "strategy", "leasing", "retention", "marketing", "operations", "outlook", "financial"
8. "sentiment" - Only if applicable: "concern" or "positive". Omit if neutral.
9. "strategy_category" - Classify into ONE of: "Concession", "Marketing", "Personnel", "Renovation", "Refinance", "Sale". Omit if none apply.
   - Concession: pricing, concessions, loss leaders, renewal offers, move-in specials
   - Marketing: advertising, ILS platforms, campaigns, SEO/SEM, marketing spend
   - Personnel: staffing, hiring, team changes, incentive programs
   - Renovation: capital improvements, make-ready, landscaping, amenities, broadband
   - Refinance: loan restructuring, debt (only if explicitly discussed)
   - Sale: disposition, sale (only if explicitly discussed)

RESPONSE FORMAT:
Return ONLY a JSON array. No markdown, no code blocks, no explanation. Just the raw JSON array.
If no actionable items found, return: []`;
}

async function callClaudeForActions(fileContents) {
  const apiKey = getApiKey();
  if (!apiKey) throw new Error('NO_KEY');

  const systemPrompt = buildActionExtractionPrompt();
  let userMessage = 'Please extract action items from the following document(s):\n\n';
  fileContents.forEach((fc, i) => {
    userMessage += `--- DOCUMENT ${i+1}: ${fc.name} ---\n${fc.text.substring(0, 100000)}\n\n`;
  });

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 4096,
      system: systemPrompt,
      messages: [{ role: 'user', content: userMessage }],
    }),
  });

  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    if (response.status === 401) throw new Error('INVALID_KEY');
    throw new Error(err.error?.message || 'API Error ' + response.status);
  }
  const data = await response.json();
  return data.content[0].text;
}

async function processUploadedFiles() {
  if (uploadedFiles.length === 0) return;
  const apiKey = getApiKey();
  if (!apiKey) {
    toggleApiKeyInput();
    const st = document.getElementById('ai-key-status');
    if (st) { st.textContent = 'Please enter your Anthropic API key first'; st.style.color = 'var(--red)'; }
    return;
  }

  const statusEl = document.getElementById('file-status');
  const statusText = document.getElementById('file-status-text');
  const processBtn = document.getElementById('file-process-btn');
  statusEl.style.display = 'flex';
  document.getElementById('file-preview').style.display = 'none';
  processBtn.disabled = true;

  try {
    const fileContents = [];
    for (let i = 0; i < uploadedFiles.length; i++) {
      statusText.textContent = `Reading file ${i+1}/${uploadedFiles.length}: ${uploadedFiles[i].file.name}...`;
      const text = await readFileContent(uploadedFiles[i]);
      uploadedFiles[i].text = text;
      fileContents.push({ name: uploadedFiles[i].file.name, text });
    }

    statusText.textContent = 'AI is analyzing documents and extracting action items...';
    const response = await callClaudeForActions(fileContents);

    statusText.textContent = 'Processing results...';
    let cleaned = response.trim();
    if (cleaned.startsWith('```')) cleaned = cleaned.replace(/^```(?:json)?\s*/, '').replace(/\s*```$/, '');
    let parsed;
    try { parsed = JSON.parse(cleaned); } catch (e) { throw new Error('AI returned invalid JSON. Please try again.'); }
    if (!Array.isArray(parsed)) throw new Error('AI response was not an array. Please try again.');

    if (parsed.length === 0) {
      statusText.textContent = 'No action items found in the uploaded document(s).';
      setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
      return;
    }

    extractedActions = parsed;
    statusEl.style.display = 'none';
    renderExtractedPreview(parsed);
  } catch (err) {
    statusEl.style.display = 'none';
    let errMsg = err.message;
    if (err.message === 'NO_KEY') errMsg = 'Please set your Anthropic API key first.';
    else if (err.message === 'INVALID_KEY') errMsg = 'Invalid API key. Please re-enter.';
    alert('Error: ' + errMsg);
  } finally {
    processBtn.disabled = false;
  }
}

function renderExtractedPreview(actions) {
  const previewEl = document.getElementById('file-preview');
  const listEl = document.getElementById('file-preview-list');
  listEl.innerHTML = actions.map((a, i) => {
    const catBadge = a.strategy_category ? `<span class="cat-badge cat-badge-${a.strategy_category}" style="font-size:9px;margin-right:4px">${a.strategy_category}</span>` : '';
    const sentBadge = a.sentiment ? `<span class="sentiment-badge sentiment-${a.sentiment}" style="font-size:9px;margin-right:4px">${a.sentiment === 'concern' ? 'Concern' : 'Positive'}</span>` : '';
    return `<div class="file-preview-item" id="preview-item-${i}">
      <button class="preview-remove" onclick="removeExtractedItem(${i})" title="Remove this item">âœ•</button>
      <div class="preview-action">${sentBadge}${catBadge}${a.action}</div>
      <div class="preview-meta">
        <span>Date: ${a.date || '-'}</span>
        <span>Source: ${a.source_detail || a.source || '-'}</span>
        <span>Responsible: ${a.responsible || '-'}</span>
        <span>Status: ${a.status || '-'}</span>
      </div>
    </div>`;
  }).join('');
  updatePreviewCount();
  previewEl.style.display = 'block';
  previewEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function removeExtractedItem(index) {
  extractedActions.splice(index, 1);
  renderExtractedPreview(extractedActions);
  if (extractedActions.length === 0) {
    document.getElementById('file-preview').style.display = 'none';
  }
}

function updatePreviewCount() {
  const btn = document.querySelector('.file-confirm-btn');
  if (btn) btn.textContent = `Add ${extractedActions.length} Item${extractedActions.length !== 1 ? 's' : ''} to Actions Table`;
  const title = document.querySelector('.file-preview-title');
  if (title) title.textContent = `Extracted Action Items (${extractedActions.length})`;
}

function confirmExtractedActions() {
  if (extractedActions.length === 0) return;
  const state = loadActionsState();
  if (!state.custom) state.custom = [];
  const now = Date.now();
  extractedActions.forEach((a, i) => {
    state.custom.push({
      _id: 'ai_' + (now + i),
      date: a.date || new Date().toISOString().slice(0, 10),
      source: a.source || 'Uploaded Document',
      source_detail: a.source_detail || '',
      action: a.action || '',
      responsible: a.responsible || 'Unknown',
      status: a.status || 'pending',
      category: a.category || '',
      sentiment: a.sentiment || undefined,
      strategy_category: a.strategy_category || undefined,
    });
  });
  saveActionsState(state);

  // Reset upload UI
  extractedActions = [];
  uploadedFiles = [];
  document.getElementById('file-preview').style.display = 'none';
  document.getElementById('file-list').style.display = 'none';
  document.getElementById('file-actions').style.display = 'none';

  renderActions();
  setTimeout(() => {
    document.getElementById('actions-table-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function discardExtractedActions() {
  extractedActions = [];
  document.getElementById('file-preview').style.display = 'none';
}

// Enter key to add
document.addEventListener('DOMContentLoaded', () => {
  ['new-action-text','new-action-resp'].forEach(elId => {
    const el = document.getElementById(elId);
    if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') addAction(); });
  });

  // --- AI Document Parser drop zone ---
  initDropZone();

  // --- Contacts form: Enter key to add ---
  ['contact-name','contact-email','contact-phone','contact-role'].forEach(elId => {
    const el = document.getElementById(elId);
    if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') addContact(); });
  });

  // --- Cell comment event delegation ---
  // Attach to both T-12 financial table and Budget Detail table
  ['budget-table-container', 'budget-detail-container'].forEach(containerId => {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.addEventListener('click', function(e) {
      const td = e.target.closest('td[data-row]');
      if (!td) return;
      if (e.target.closest('.cell-comment-popup')) return;
      openCellCommentPopup(td);
    });
    container.addEventListener('mouseover', function(e) {
      const td = e.target.closest('td[data-row]');
      if (td && !document.getElementById('cell-comment-popup').classList.contains('active')) {
        showCellTooltip(td);
      }
    });
    container.addEventListener('mouseout', function(e) {
      const td = e.target.closest('td[data-row]');
      if (td) hideCellTooltip();
    });
  });
  // Close popup on outside click
  document.addEventListener('click', function(e) {
    const popup = document.getElementById('cell-comment-popup');
    if (popup && popup.classList.contains('active') &&
        !e.target.closest('.cell-comment-popup') &&
        !e.target.closest('td[data-row]')) {
      closeCellCommentPopup();
    }
  });
  // Keyboard: Escape to close, Ctrl/Cmd+Enter to save
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeCellCommentPopup();
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && _activeCellKey) {
      e.preventDefault();
      saveCellComment();
    }
  });
});

function renderActionsTable(actions, animate) {
  const c = document.getElementById('actions-table-container');
  // Sort: done items at bottom, then by user-selected field
  const sorted = [...actions].sort((a, b) => {
    if (a._done !== b._done) return a._done ? 1 : -1;
    let va, vb;
    switch (actionsSortField) {
      case 'date': va = a.date || ''; vb = b.date || ''; break;
      case 'source': va = (a.source || '').toLowerCase(); vb = (b.source || '').toLowerCase(); break;
      case 'responsible': va = (a.responsible || '').toLowerCase(); vb = (b.responsible || '').toLowerCase(); break;
      case 'status': va = (a.status || '').toLowerCase(); vb = (b.status || '').toLowerCase(); break;
      default: va = a.date || ''; vb = b.date || '';
    }
    const cmp = va < vb ? -1 : va > vb ? 1 : 0;
    return actionsSortDir === 'asc' ? cmp : -cmp;
  });

  // Show filter indicator when strategy filter is active
  let h = '';
  if (currentStrategyFilter) {
    h += `<div class="strategy-filter-label" onclick="filterByStrategy('${currentStrategyFilter}')">
      Showing: ${currentStrategyFilter} (${sorted.length} item${sorted.length !== 1 ? 's' : ''})
      <span class="clear-x">âœ• Clear</span>
    </div>`;
  }

  // Build sortable header helper
  function sortTh(field, label, extraStyle) {
    const isActive = actionsSortField === field;
    const arrow = isActive ? (actionsSortDir === 'asc' ? 'â–²' : 'â–¼') : 'â–²';
    const cls = isActive ? 'sortable sort-active' : 'sortable';
    const style = extraStyle ? ` style="${extraStyle}"` : '';
    return `<th class="${cls}" onclick="toggleActionsSort('${field}')"${style}>${label}<span class="sort-arrow">${arrow}</span></th>`;
  }

  h += `<table class="actions-table"><thead><tr><th style="width:40px"></th>${sortTh('date','Date')}${sortTh('source','Source')}<th>Action / Decision</th>${sortTh('responsible','Responsible')}${sortTh('status','Status')}<th style="width:40px"></th></tr></thead><tbody>`;
  sorted.forEach((a, idx) => {
    const isDone = a._done;
    const sc = isDone ? 'status-done' : 'status-' + (a.status || '').replace(/\s/g, '_');
    const statusLabel = isDone ? 'Done' : a.status;
    const srcHtml = a.source_detail ? `${a.source}<br><span style="font-size:11px;color:var(--gray)">${a.source_detail}</span>` : a.source;
    const animClass = animate ? ' row-highlight-pulse' : '';
    const animDelay = animate ? ` style="animation-delay:${idx * 0.06}s"` : '';
    h += `<tr class="${isDone ? 'row-done' : ''}${animClass}"${animDelay}>
      <td style="text-align:center"><input type="checkbox" class="action-check" ${isDone ? 'checked' : ''} onchange="toggleActionDone('${a._id}')"></td>
      <td style="white-space:nowrap">${a.date}</td>
      <td style="white-space:nowrap">${srcHtml}</td>
      <td>${a.sentiment ? `<span class="sentiment-badge sentiment-${a.sentiment}">${a.sentiment === 'concern' ? 'Concern' : 'Positive'}</span>` : ''}${a.strategy_category ? `<span class="cat-badge cat-badge-${a.strategy_category}">${a.strategy_category}</span>` : ''}<span class="action-text">${a.action}</span></td>
      <td style="white-space:nowrap">${a.responsible || '-'}</td>
      <td><span class="status-badge ${sc}">${statusLabel}</span></td>
      <td style="text-align:center"><button onclick="deleteAction('${a._id}')" style="background:none;border:none;color:var(--gray-light);cursor:pointer;font-size:13px;padding:2px 6px;transition:color 0.2s" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--gray-light)'" title="Remove">&#10005;</button></td>
    </tr>`;
  });
  h += '</tbody></table>';
  c.innerHTML = h;
}

// ===== CONTACTS =====
const CONTACTS_STORAGE_KEY = 'gwk_contacts';

// Company logo overrides (base64 or SVG data URIs for known companies)
// Pondmoon: reconstructed logo from branding â€” dark circle with crescent moon
const PONDMOON_LOGO = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230a1628'/%3E%3Ccircle cx='38' cy='28' r='18' fill='%23c8a55a'/%3E%3Ccircle cx='44' cy='26' r='16' fill='%230a1628'/%3E%3Ctext x='32' y='58' text-anchor='middle' font-family='serif' font-size='7' font-weight='700' letter-spacing='1.5' fill='%23c8a55a'%3EPONDMOON%3C/text%3E%3C/svg%3E";

// Override map: company name â†’ logo data URI (takes priority over Google favicon)
const COMPANY_LOGO_OVERRIDES = {
  'Pondmoon': PONDMOON_LOGO,
  // Add more: 'Allen Harrison Company': 'data:image/...', etc.
};

const EMAIL_DOMAIN_MAP = {
  'greystar.com':         { company: 'Greystar', role: 'Property Manager (Greystar)' },
  'allenharrisonco.com':  { company: 'Allen Harrison Company', role: 'Co-Investor (AHC)' },
  'ahc-re.com':           { company: 'Allen Harrison Company', role: 'Co-Investor (AHC)' },
  'allenharrison.com':    { company: 'Allen Harrison Company', role: 'Co-Investor (AHC)' },
  'pondmoonusa.com':      { company: 'Pondmoon', role: 'Investor (Pondmoon)' },
  'pondmoon.com':         { company: 'Pondmoon', role: 'Investor (Pondmoon)' },
  'hud.gov':              { company: 'HUD', role: 'HUD / FHA' },
  'fha.gov':              { company: 'HUD', role: 'HUD / FHA' },
  'houstontx.gov':        { company: 'HCHA', role: 'Tax Authority (HCHA)' },
};

const KNOWN_CONTACTS = {
  'danteil kirkland': { company: 'Greystar', role: 'Community Manager (Greystar)' },
  'steven li':        { company: 'Pondmoon', role: 'Investor (Pondmoon)' },
  'nicole':           { company: 'Pondmoon', role: 'Investor (Pondmoon)' },
  'meredith':         { company: 'Allen Harrison Company', role: 'Co-Investor (AHC)' },
};

const DEFAULT_CONTACTS = [
  {"id":"contact_1","name":"Meredith Monroe","email":"mmonroe@allenharrisonco.com","phone":"","role":"Asset Manager (Allen Harrison Company)"},
  {"id":"contact_2","name":"Catherine Hudson","email":"chudson@allenharrisonco.com","phone":"","role":"VP of Development (Allen Harrison Company)"},
  {"id":"contact_3","name":"Jared Garrand","email":"jgarrand@allenharrisonco.com","phone":"","role":"Principal (Allen Harrison Company)"},
  {"id":"contact_4","name":"Nicole Zhong","email":"nzhong@pondmoonusa.com","phone":"","role":"Director (Pondmoon)"},
  {"id":"contact_5","name":"Steven Li","email":"fhli@pondmoonusa.com","phone":"","role":"Managing Partner (Pondmoon)"},
  {"id":"contact_6","name":"Kristin Krohn","email":"kristin.krohn@greystar.com","phone":"","role":"Regional Manager (Greystar)"},
  {"id":"contact_7","name":"Danteil Kirkland","email":"greenwoodatkatymgr@greystar.com","phone":"","role":"Community Manager (Greystar)"},
  {"id":"contact_8","name":"Ashley Johnson","email":"ashley.johnson@greystar.com","phone":"","role":"Regional Property Manager"},
  {"id":"contact_9","name":"Lmurphy","email":"lmurphy@ctot.com","phone":"","role":"Senior Associate (Chilton O'Connor Thomas & Onley)"},
  {"id":"contact_10","name":"Meryl See","email":"msee@kslaw.com","phone":"","role":"Partner (King & Spalding LLP)"},
  {"id":"contact_11","name":"Samantha Brooks","email":"samantha.brooks@greyco.com","phone":"","role":"Vice President (Greystone)"},
  {"id":"contact_12","name":"Luke Zarr","email":"lzarr@allenharrisonco.com","phone":"","role":"Asset Manager (Allen Harrison Company)"},
  {"id":"contact_13","name":"David Runnels","email":"drunnels@kslaw.com","phone":"","role":"Partner (King & Spalding LLP)"},
  {"id":"contact_14","name":"Melissa Garcia","email":"mgarcia@ctot.com","phone":"","role":"Associate (Chilton O'Connor Thomas & Onley)"},
  {"id":"contact_15","name":"Tracee Tallas","email":"ttallas@allenharrisonco.com","phone":"","role":"Acquisitions Manager (Allen Harrison Company)"},
  {"id":"contact_16","name":"Jeff Patman","email":"jpatman@ctot.com","phone":"","role":"Partner (Chilton O'Connor Thomas & Onley)"},
  {"id":"contact_17","name":"Patrick Chen","email":"pchen@pondmoonusa.com","phone":"","role":"CEO"},
  {"id":"contact_18","name":"Richard Kourbage","email":"richard.kourbage@cushwakegreyco.com","phone":"","role":"Managing Director (Cushman & Wakefield)"}
];

function loadContacts() {
  if (_contactsCache !== null) return _contactsCache;
  try {
    const saved = JSON.parse(localStorage.getItem(CONTACTS_STORAGE_KEY));
    if (saved && saved.length > 0) return saved;
    // First visit: seed with default contacts and save
    saveContacts(DEFAULT_CONTACTS);
    return DEFAULT_CONTACTS;
  } catch {
    saveContacts(DEFAULT_CONTACTS);
    return DEFAULT_CONTACTS;
  }
}
function saveContacts(contacts) {
  _contactsCache = contacts;
  localStorage.setItem(CONTACTS_STORAGE_KEY, JSON.stringify(contacts));
  serverSave('contacts', contacts);
}

function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function detectContactRole() {
  const emailEl = document.getElementById('contact-email');
  const roleEl = document.getElementById('contact-role');
  const hintEl = document.getElementById('ai-role-hint');
  const hintTextEl = document.getElementById('ai-role-hint-text');
  const email = emailEl.value.trim().toLowerCase();

  const atIdx = email.indexOf('@');
  if (atIdx < 0 || atIdx === email.length - 1) { hintEl.style.display = 'none'; return; }
  const domain = email.slice(atIdx + 1);

  let match = EMAIL_DOMAIN_MAP[domain];
  if (!match) {
    for (const [d, info] of Object.entries(EMAIL_DOMAIN_MAP)) {
      if (domain.endsWith('.' + d)) { match = info; break; }
    }
  }

  if (match) {
    hintTextEl.textContent = 'Detected: ' + match.role;
    hintEl.style.display = 'flex';
    if (!roleEl.value.trim()) roleEl.value = match.role;
  } else {
    hintEl.style.display = 'none';
  }
}

function extractCompany(contact) {
  if (contact.email) {
    const atIdx = contact.email.indexOf('@');
    if (atIdx > 0) {
      const domain = contact.email.slice(atIdx + 1).toLowerCase();
      for (const [d, info] of Object.entries(EMAIL_DOMAIN_MAP)) {
        if (domain === d || domain.endsWith('.' + d)) return info.company;
      }
    }
  }
  const nameLower = (contact.name || '').toLowerCase().trim();
  for (const [n, info] of Object.entries(KNOWN_CONTACTS)) {
    if (nameLower.includes(n) || n.includes(nameLower)) return info.company;
  }
  const roleMatch = (contact.role || '').match(/\(([^)]+)\)/);
  if (roleMatch) return roleMatch[1];
  if (contact.role) return contact.role;
  return 'Other';
}

function addContact() {
  const nameEl = document.getElementById('contact-name');
  const emailEl = document.getElementById('contact-email');
  const phoneEl = document.getElementById('contact-phone');
  const roleEl = document.getElementById('contact-role');

  const name = nameEl.value.trim();
  if (!name) { nameEl.focus(); return; }

  const contact = {
    id: 'contact_' + Date.now(),
    name: name,
    email: emailEl.value.trim(),
    phone: phoneEl.value.trim(),
    role: roleEl.value.trim() || 'Contact',
    created: new Date().toISOString(),
  };

  const contacts = loadContacts();
  contacts.push(contact);
  saveContacts(contacts);

  nameEl.value = ''; emailEl.value = ''; phoneEl.value = ''; roleEl.value = '';
  document.getElementById('ai-role-hint').style.display = 'none';
  renderContacts(contact.id);
}

function deleteContact(id) {
  let contacts = loadContacts();
  contacts = contacts.filter(c => c.id !== id);
  saveContacts(contacts);
  renderContacts();
}

let editingContactId = null;

function startEditContact(id) {
  editingContactId = id;
  renderContacts();
}
function cancelEditContact() {
  editingContactId = null;
  renderContacts();
}
function saveEditContact(id) {
  const contacts = loadContacts();
  const contact = contacts.find(c => c.id === id);
  if (!contact) return;
  contact.name = document.getElementById('edit-contact-name').value.trim() || contact.name;
  contact.email = document.getElementById('edit-contact-email').value.trim();
  contact.phone = document.getElementById('edit-contact-phone').value.trim();
  contact.role = document.getElementById('edit-contact-role').value.trim() || contact.role;
  saveContacts(contacts);
  editingContactId = null;
  renderContacts();
}

// --- Batch Import ---
let batchParsed = []; // [{name, email, role, company, selected, aiRole}]

function toggleBatchImport() {
  const body = document.getElementById('batch-import-body');
  const toggle = document.getElementById('batch-import-toggle');
  const visible = body.style.display !== 'none';
  body.style.display = visible ? 'none' : 'block';
  toggle.classList.toggle('open', !visible);
}

function parseBatchContacts() {
  const raw = document.getElementById('batch-import-text').value.trim();
  if (!raw) return;

  // Parse "Name <email>" or bare "email" patterns from To/Cc lines
  // Remove To:/Cc: prefixes, split by ; or , then parse each entry
  const cleaned = raw.replace(/^(To|Cc|Bcc|From)\s*:\s*/gmi, '');
  // Match: "Name <email>" or bare email patterns
  const entries = [];
  // Split by ; or , but not within < >
  const parts = cleaned.split(/[;,]+/);
  parts.forEach(part => {
    part = part.replace(/_/g, '').trim(); // strip underscores (email formatting artifacts)
    if (!part) return;
    // Try "Name <email>" pattern
    const angleMatch = part.match(/^(.+?)\s*<([^>]+@[^>]+)>/);
    if (angleMatch) {
      entries.push({ name: angleMatch[1].trim().replace(/["']/g, ''), email: angleMatch[2].trim().toLowerCase() });
      return;
    }
    // Try bare email
    const emailMatch = part.match(/([^\s<>]+@[^\s<>]+\.[^\s<>]+)/);
    if (emailMatch) {
      const email = emailMatch[1].toLowerCase();
      // Derive name from email prefix
      const prefix = email.split('@')[0].replace(/[._-]/g, ' ');
      const name = prefix.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
      entries.push({ name, email });
      return;
    }
  });

  if (entries.length === 0) {
    document.getElementById('batch-status').textContent = 'No contacts found. Check format.';
    setTimeout(() => { document.getElementById('batch-status').textContent = ''; }, 3000);
    return;
  }

  // Deduplicate by email, skip already-existing contacts
  const existing = loadContacts();
  const existingEmails = new Set(existing.map(c => c.email.toLowerCase()));

  batchParsed = [];
  entries.forEach(e => {
    if (existingEmails.has(e.email)) return; // skip duplicates
    // Auto-detect role from domain
    const atIdx = e.email.indexOf('@');
    const domain = atIdx > 0 ? e.email.slice(atIdx + 1) : '';
    let role = '', company = '';
    const domainMatch = EMAIL_DOMAIN_MAP[domain];
    if (domainMatch) { role = domainMatch.role; company = domainMatch.company; }
    else {
      // Try suffix match
      for (const [d, info] of Object.entries(EMAIL_DOMAIN_MAP)) {
        if (domain.endsWith('.' + d)) { role = info.role; company = info.company; break; }
      }
    }
    if (!company) company = domain.split('.').slice(0, -1).join('.'); // keep raw domain minus TLD as placeholder

    batchParsed.push({ name: e.name, email: e.email, domain, role, company, selected: true, aiRole: '' });
  });

  if (batchParsed.length === 0) {
    document.getElementById('batch-status').textContent = 'All contacts already exist.';
    setTimeout(() => { document.getElementById('batch-status').textContent = ''; }, 3000);
    return;
  }

  renderBatchPreview();
  document.getElementById('batch-ai-btn').style.display = 'inline-flex';
  document.getElementById('batch-ai-btn').disabled = false;
}

function renderBatchPreview() {
  const listEl = document.getElementById('batch-preview-list');
  const titleEl = document.getElementById('batch-preview-title');
  const selectedCount = batchParsed.filter(c => c.selected).length;
  titleEl.textContent = `Parsed Contacts (${selectedCount} of ${batchParsed.length} selected)`;

  listEl.innerHTML = batchParsed.map((c, i) => {
    const roleDisplay = c.aiRole
      ? `<span>${escHtml(c.aiRole)}</span><span class="batch-preview-ai-tag">AI</span>`
      : (c.role ? escHtml(c.role) : `<span style="color:var(--gray-light)">Unknown role</span>`);
    const logoSrc = getCompanyLogo(c.company, c.domain);
    const logoImg = logoSrc ? `<img src="${logoSrc}" style="width:16px;height:16px;vertical-align:middle;margin-right:4px;border-radius:2px" onerror="this.style.display='none'">` : '';
    return `<div class="batch-preview-item${c.selected ? '' : ' deselected'}">
      <input type="checkbox" class="batch-preview-check" ${c.selected ? 'checked' : ''} onchange="toggleBatchItem(${i})">
      <div class="batch-preview-info">
        <div class="batch-preview-name">${escHtml(c.name)}</div>
        <div class="batch-preview-email">${escHtml(c.email)} &middot; ${logoImg}${escHtml(c.company)}</div>
        <div class="batch-preview-role">
          ${roleDisplay}
          <input class="batch-preview-role-edit" value="${escHtml(c.aiRole || c.role)}" placeholder="Edit role..." onchange="updateBatchRole(${i}, this.value)" style="margin-left:8px">
        </div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('batch-preview').style.display = 'block';
}

function toggleBatchItem(index) {
  batchParsed[index].selected = !batchParsed[index].selected;
  renderBatchPreview();
}

function updateBatchRole(index, value) {
  batchParsed[index].role = value.trim();
  batchParsed[index].aiRole = ''; // user override clears AI tag
}

async function aiSearchBatchRoles() {
  const apiKey = getApiKey();
  if (!apiKey) {
    toggleApiKeyInput();
    const st = document.getElementById('ai-key-status');
    if (st) { st.textContent = 'Please enter your Anthropic API key first'; st.style.color = 'var(--red)'; }
    return;
  }

  const btn = document.getElementById('batch-ai-btn');
  const statusEl = document.getElementById('batch-status');
  btn.disabled = true;
  statusEl.textContent = 'AI is searching job titles...';

  const contactsToSearch = batchParsed.filter(c => c.selected && !c.aiRole);
  if (contactsToSearch.length === 0) {
    statusEl.textContent = 'All roles already identified.';
    btn.disabled = false;
    setTimeout(() => { statusEl.textContent = ''; }, 2000);
    return;
  }

  const searchList = contactsToSearch.map(c => `${c.name} â€” ${c.company} (${c.email})`).join('\n');

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2048,
        system: `You are a real estate industry contact research assistant. Given a list of people with their company/email domain, determine:
1. Their most likely job title or role
2. The FULL OFFICIAL company name (resolve abbreviated or shortened domain names to real company names)

Context: These contacts are associated with Greenwood at Katy, a 324-unit multifamily property in Katy, TX.
Known companies:
- greystar.com â†’ Greystar Real Estate Partners (property management: Community Manager, Regional Manager, Director, VP, Maintenance, Leasing)
- allenharrisonco.com â†’ Allen Harrison Company (real estate investment/development in Houston: Principal, VP, Asset Manager, Acquisitions)
- pondmoonusa.com â†’ Pondmoon Real Estate Partners (real estate investment: Principal, Managing Partner, VP, Analyst)

For UNKNOWN domains, you MUST resolve the domain to the real company name. Examples:
- cushwakegreyco.com â†’ Cushman & Wakefield (or Greystone, depending on actual domain)
- cbre.com â†’ CBRE Group
- jll.com â†’ Jones Lang LaSalle (JLL)
- Look at the full domain name and use your knowledge to identify the real company.

Use your knowledge of real estate companies, LinkedIn, and industry directories. If you can identify the exact person, provide their actual title. Otherwise, make an educated guess based on name, email prefix, and company.

Return ONLY a JSON array with objects: {"email": "...", "title": "...", "company": "Full Official Company Name"} for each person. No markdown, no explanation.`,
        messages: [{ role: 'user', content: `Find job titles for these contacts:\n${searchList}` }],
      }),
    });

    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      throw new Error(errData.error?.message || `API error ${response.status}`);
    }

    const data = await response.json();
    let text = data.content?.[0]?.text || '';
    if (text.startsWith('```')) text = text.replace(/^```(?:json)?\s*/, '').replace(/\s*```$/, '');

    const results = JSON.parse(text);
    if (Array.isArray(results)) {
      results.forEach(r => {
        const match = batchParsed.find(c => c.email === r.email);
        if (match) {
          if (r.title) {
            match.aiRole = r.title;
          }
          // Update company name if AI resolved a better one
          if (r.company && r.company.length > 1) {
            match.company = r.company;
          }
          match.role = (match.aiRole || match.role || '') + (match.company ? ' (' + match.company + ')' : '');
        }
      });
    }

    statusEl.textContent = `Found ${results.length} result${results.length !== 1 ? 's' : ''}`;
    renderBatchPreview();
  } catch (err) {
    statusEl.textContent = 'Error: ' + err.message;
  } finally {
    btn.disabled = false;
    setTimeout(() => { document.getElementById('batch-status').textContent = ''; }, 4000);
  }
}

function confirmBatchContacts() {
  const toAdd = batchParsed.filter(c => c.selected);
  if (toAdd.length === 0) return;

  const contacts = loadContacts();
  const now = Date.now();
  let lastId = '';
  toAdd.forEach((c, i) => {
    const id = 'contact_' + (now + i);
    lastId = id;
    contacts.push({
      id,
      name: c.name,
      email: c.email,
      phone: '',
      role: c.role || c.company,
      created: new Date().toISOString(),
    });
  });
  saveContacts(contacts);

  // Reset batch UI
  batchParsed = [];
  document.getElementById('batch-preview').style.display = 'none';
  document.getElementById('batch-ai-btn').style.display = 'none';
  document.getElementById('batch-import-text').value = '';
  document.getElementById('batch-status').textContent = `Added ${toAdd.length} contact${toAdd.length !== 1 ? 's' : ''}!`;
  setTimeout(() => { document.getElementById('batch-status').textContent = ''; }, 3000);

  renderContacts(lastId);
}

function discardBatchContacts() {
  batchParsed = [];
  document.getElementById('batch-preview').style.display = 'none';
  document.getElementById('batch-ai-btn').style.display = 'none';
}

// Get domain from a contact's email
function getDomainFromEmail(email) {
  if (!email) return '';
  const at = email.indexOf('@');
  return at > 0 ? email.slice(at + 1).toLowerCase() : '';
}

// Get the primary domain for a company group based on its members' emails
function getGroupDomain(members) {
  const domains = {};
  members.forEach(c => {
    const d = getDomainFromEmail(c.email);
    if (d) domains[d] = (domains[d] || 0) + 1;
  });
  // Return most common domain
  let best = '', bestCount = 0;
  for (const [d, count] of Object.entries(domains)) {
    if (count > bestCount) { best = d; bestCount = count; }
  }
  return best;
}

// Generate favicon/logo URL for a domain
function getLogoUrl(domain) {
  if (!domain) return '';
  return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(domain)}&sz=64`;
}

// Get logo URL for a company, checking overrides first
function getCompanyLogo(company, domain) {
  if (company && COMPANY_LOGO_OVERRIDES[company]) return COMPANY_LOGO_OVERRIDES[company];
  return getLogoUrl(domain);
}

function renderContacts(newContactId) {
  const container = document.getElementById('contacts-list-container');
  const countLabel = document.getElementById('contacts-count-label');
  const searchEl = document.getElementById('contacts-search');
  const searchTerm = searchEl ? searchEl.value.trim().toLowerCase() : '';

  let contacts = loadContacts();
  if (searchTerm) {
    contacts = contacts.filter(c =>
      (c.name||'').toLowerCase().includes(searchTerm) ||
      (c.email||'').toLowerCase().includes(searchTerm) ||
      (c.phone||'').toLowerCase().includes(searchTerm) ||
      (c.role||'').toLowerCase().includes(searchTerm)
    );
  }

  countLabel.textContent = contacts.length + ' contact' + (contacts.length !== 1 ? 's' : '');

  if (contacts.length === 0) {
    container.innerHTML = `<div class="contacts-empty">
      <div class="contacts-empty-icon">&#128101;</div>
      <div class="contacts-empty-text">${searchTerm ? 'No contacts match your search' : 'No contacts yet'}</div>
      <div class="contacts-empty-sub">${searchTerm ? 'Try a different search term' : 'Add your first contact using the form above'}</div>
    </div>`;
    return;
  }

  // Group by company
  const groups = {};
  contacts.forEach(c => {
    const company = extractCompany(c);
    if (!groups[company]) groups[company] = [];
    groups[company].push(c);
  });

  const companyOrder = ['Greystar', 'Pondmoon', 'Allen Harrison Company', 'HUD', 'HCHA'];
  const sortedKeys = Object.keys(groups).sort((a, b) => {
    const ai = companyOrder.indexOf(a), bi = companyOrder.indexOf(b);
    if (ai >= 0 && bi >= 0) return ai - bi;
    if (ai >= 0) return -1;
    if (bi >= 0) return 1;
    return a.localeCompare(b);
  });

  let html = '';
  sortedKeys.forEach(company => {
    const members = groups[company];
    const initials = company.split(/\s+/).map(w => w[0]).join('').slice(0, 2).toUpperCase();
    const isNewGroup = newContactId && members.some(c => c.id === newContactId) && members.length === 1;
    const groupDomain = getGroupDomain(members);
    const logoUrl = getCompanyLogo(company, groupDomain);
    const iconHtml = logoUrl
      ? `<img src="${logoUrl}" alt="${escHtml(company)}" onerror="this.classList.add('logo-failed');this.parentElement.innerHTML='${initials}'">`
      : initials;

    html += `<div class="contacts-group${isNewGroup ? ' contacts-group-new' : ''}">
      <div class="contacts-group-header">
        <div class="contacts-group-icon">${iconHtml}</div>
        <div class="contacts-group-name">${escHtml(company)}</div>
        <div class="contacts-group-count">${members.length} contact${members.length !== 1 ? 's' : ''}</div>
      </div>
      <div class="contacts-group-body">`;

    members.forEach(c => {
      const isNew = newContactId === c.id;

      if (editingContactId === c.id) {
        html += `<div class="contact-edit-row">
          <input id="edit-contact-name" value="${escHtml(c.name)}" placeholder="Name" style="flex:1">
          <input id="edit-contact-email" value="${escHtml(c.email)}" placeholder="Email" style="flex:1.2">
          <input id="edit-contact-phone" value="${escHtml(c.phone)}" placeholder="Phone" style="width:130px">
          <input id="edit-contact-role" value="${escHtml(c.role)}" placeholder="Role" style="flex:0.8">
          <button class="contact-edit-save" onclick="saveEditContact('${c.id}')">Save</button>
          <button class="contact-edit-cancel" onclick="cancelEditContact()">Cancel</button>
        </div>`;
        return;
      }

      const nameInitials = c.name.split(/\s+/).map(w => w[0]).join('').slice(0, 2).toUpperCase();
      html += `<div class="contact-card${isNew ? ' contact-card-new' : ''}">
        <div class="contact-avatar">${nameInitials}</div>
        <div class="contact-info">
          <div>
            <span class="contact-name">${escHtml(c.name)}</span>
            <span class="contact-role-badge">${escHtml(c.role)}</span>
          </div>
          <div class="contact-details">
            ${c.email ? `<a href="mailto:${escHtml(c.email)}"><span class="detail-icon">&#9993;</span> ${escHtml(c.email)}</a>` : ''}
            ${c.phone ? `<a href="tel:${escHtml(c.phone)}"><span class="detail-icon">&#9742;</span> ${escHtml(c.phone)}</a>` : ''}
          </div>
        </div>
        <div class="contact-actions">
          <button onclick="startEditContact('${c.id}')" title="Edit">Edit</button>
          <button class="contact-delete" onclick="deleteContact('${c.id}')" title="Delete">&#10005;</button>
        </div>
      </div>`;
    });

    html += '</div></div>';
  });

  container.innerHTML = html;
}

// ===== INIT =====
renderLeasing();
renderFinancial();
renderBudget();
renderLoan();
renderComps();
renderActions();
renderContacts();

// Check server for newer data (uploaded via web UI)
checkForUpdatedData();
</script>

<!-- Print-only header for PDF export -->
<div id="print-report-header" class="print-report-header">
  <div class="print-header-top">
    <div>
      <div class="print-property-name">Greenwood at Katy Apartment Homes</div>
      <div class="print-property-address">1700 Katy Fort Bend Rd, Katy, TX 77493</div>
    </div>
    <div class="print-header-meta">
      <div class="print-header-label">T-12 Income &amp; Expense Statement</div>
      <div class="print-header-period" id="print-header-period"></div>
      <div class="print-header-date" id="print-header-date"></div>
    </div>
  </div>
  <div class="print-header-bar"></div>
  <div class="print-header-details">
    <span>324 Units &bull; 310,836 SF &bull; Built 2022</span>
    <span>PM: Greystar &bull; Investor: Pondmoon Real Estate Partners</span>
  </div>
</div>

<!-- ===== UPLOAD PANEL MODAL ===== -->
<div id="upload-overlay" class="upload-overlay" style="display:none">
  <div class="upload-panel">
    <div class="upload-header">
      <h3 id="upload-title">Update Data</h3>
      <button class="upload-close" onclick="closeUploadPanel()">&times;</button>
    </div>
    <div class="upload-tabs">
      <div class="upload-tab active" onclick="switchUploadMode('file')" id="upload-tab-file">Upload File</div>
      <div class="upload-tab" onclick="switchUploadMode('manual')" id="upload-tab-manual">Enter Manually</div>
    </div>
    <!-- File Upload Mode -->
    <div id="upload-mode-file">
      <div class="upload-dropzone" id="upload-dropzone"
           ondrop="handleDrop(event)" ondragover="event.preventDefault(); this.classList.add('dragover')"
           ondragleave="this.classList.remove('dragover')">
        <div class="dropzone-icon">+</div>
        <div>Drag &amp; drop a file here, or click to browse</div>
        <div class="dropzone-hint" id="upload-hint">Supported: .xlsx, .xls, .pdf, .xlsb, .png, .jpg (max 10MB)</div>
        <input type="file" id="upload-file-input" accept=".xlsx,.xls,.pdf,.xlsb,.docx,image/*" onchange="handleUploadFileSelect(this)" style="display:none">
      </div>
      <div id="upload-file-info" style="display:none; margin:12px 0; padding:10px; background:#f0f4f8; border-radius:6px; font-size:13px">
        <span id="upload-file-name" style="font-weight:600"></span>
        <span id="upload-file-size" style="color:#999; margin-left:8px"></span>
        <div id="upload-img-preview" style="display:none; margin-top:8px"><img id="upload-preview-img" style="max-width:100%; max-height:200px; border-radius:4px"></div>
      </div>
      <button class="upload-submit" id="upload-submit-btn" onclick="submitFileUpload()" disabled>Upload &amp; Process</button>
    </div>
    <!-- Manual Entry Mode -->
    <div id="upload-mode-manual" style="display:none">
      <div id="manual-leasing-form">
        <!-- OCR Screenshot Upload -->
        <div class="ocr-section" id="ocr-section">
          <div class="ocr-dropzone" id="ocr-dropzone">
            <div class="dropzone-icon">&#128247;</div>
            <div>Paste or drop a screenshot of the weekly leasing table</div>
            <div class="dropzone-hint">Supports PNG, JPG, clipboard paste (Ctrl+V / Cmd+V)</div>
            <input type="file" id="ocr-file-input" accept="image/*" style="display:none">
          </div>
          <div class="ocr-preview" id="ocr-preview" style="display:none">
            <img id="ocr-preview-img">
            <div class="ocr-preview-actions">
              <button class="ocr-analyze-btn" id="ocr-analyze-btn" onclick="analyzeScreenshot()">&#9889; Analyze with AI</button>
              <button class="ocr-clear-btn" onclick="clearOcrPreview()">Clear</button>
            </div>
          </div>
          <div class="ocr-status" id="ocr-status" style="display:none"></div>
        </div>
        <div class="form-row" style="margin-bottom:8px">
          <label>Week Ending Date</label>
          <input type="date" id="manual-week-ending" required>
        </div>
        <div class="form-grid">
          <div class="form-row"><label>Occupied Units</label><input type="number" id="manual-occupied" placeholder="e.g. 295"></div>
          <div class="form-row"><label>Leased Units</label><input type="number" id="manual-leased" placeholder="e.g. 310"></div>
          <div class="form-row"><label>New Prospects</label><input type="number" id="manual-prospects" placeholder="e.g. 25"></div>
          <div class="form-row"><label>Walk-in Traffic</label><input type="number" id="manual-walkin" placeholder="e.g. 10"></div>
          <div class="form-row"><label>Gross Leases</label><input type="number" id="manual-gross" placeholder="e.g. 8"></div>
          <div class="form-row"><label>Net Leases</label><input type="number" id="manual-net" placeholder="e.g. 5"></div>
          <div class="form-row"><label>Move-ins</label><input type="number" id="manual-movein" placeholder="e.g. 6"></div>
          <div class="form-row"><label>Move-outs</label><input type="number" id="manual-moveout" placeholder="e.g. 3"></div>
          <div class="form-row"><label>30-Day Trend %</label><input type="number" step="0.01" id="manual-trend30" placeholder="e.g. 92.5"></div>
          <div class="form-row"><label>60-Day Trend %</label><input type="number" step="0.01" id="manual-trend60" placeholder="e.g. 93.2"></div>
          <div class="form-row"><label>Rent PSF ($)</label><input type="number" step="0.01" id="manual-psf" placeholder="e.g. 1.45"></div>
        </div>
        <button class="upload-submit" onclick="submitManualLeasing()">Add Week</button>
      </div>
      <div id="manual-financials-msg" style="display:none; text-align:center; padding:40px; color:#666; font-size:14px">
        T-12 data requires a file upload (Excel or PDF).<br>Manual entry is not available for financials.
      </div>
    </div>
    <div id="upload-status" class="upload-status" style="display:none"></div>
  </div>
</div>

</body>
</html>
